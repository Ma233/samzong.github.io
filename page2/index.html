
<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/Blog">
  <head>
    <meta charset="utf-8">
	<link rel="manifest" href="/static/pwa/manifest.json">
	<title> Home | 船长的课记 </title>
    
		
    <meta name="author" content="船长">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="theme-color" content="#2196F3">
	<meta name="google-site-verification" content="puZt0ZyqB-t67BYdYAgLUyIPBeismG68J0dmEc01QeY" />

	
    <script>
		if ('serviceWorker' in navigator) {
			window.addEventListener('load', function () {
				navigator.serviceWorker
										.register('/sw.js')
										.then(function(registration) {
											console.log("Successfully registered service worker", registration.scope);
										}).catch(function(err) {
											console.log("Service worker registration failed: ", err);
										});
				//navigator.serviceWorker.ready always resolve
				navigator.serviceWorker.ready.then(function (registration) {
					console.log('Service worker successfully registered on scope', registration.scope);
				});
			});
		}
    </script>
	<script type="text/javascript" src="/assets/themes/evjekylltheme/jquery-3.6.0.slim.min.js"></script>

	<link href="/assets/themes/evjekylltheme/google-code-prettify/desert.css" type="text/css" rel="stylesheet" />

    <!-- Le styles -->
    <link href="/assets/themes/evjekylltheme/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/evjekylltheme/css/style.css" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="/static/images/favicon.ico">

    <!-- atom & rss feed -->
    <link href="" type="application/atom+xml" rel="alternate" title="Jekyll auto generate ATOM Feed">
    <link href="" type="application/atom+xml" rel="alternate" title="Site ATOM Feed">
    <link href="" type="application/rss+xml" rel="alternate" title="Site RSS Feed">
	<link rel="stylesheet" href="/assets/themes/evjekylltheme/font-awesome-4.4.0/css/font-awesome.min.css">
	<!-- <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
	new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
	j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
	'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
	})(window,document,'script','dataLayer','GTM-W2LDG64');</script> -->
		<!-- <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8529425670069509"
						crossorigin="anonymous"></script> -->
	<!-- <script async src="https://cdn.splitbee.io/sb.js"></script> -->
  </head>

  <body>
	<!-- <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W2LDG64"
	height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript> -->
    <div class="navbar navbar-default navbar-fixed-top">
				<div class="container">
          <div class="row mobilepadding">
					<!-- <a class="navbar-brand" href="/">船长的课记</a> -->
					<a class="navbar-brand" href="/">SAMZONG</a>
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#mNavbar">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <div class="collapse navbar-collapse" id="mNavbar">
  					<ul class="nav navbar-nav">
  						
  						
  						


  
    
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/friends.html">Friends</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  
    
  
    
  
    
  
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  



						  <li class="dropdown">
							  <a class="dropdown-toggle" data-toggle="dropdown" href="#">Other</a>
							  <ul class="dropdown-menu">
									<li><a href="/about.html">About</a></li>
									<li><a href="https://yuque.com/samzong/note" target="_blank">船长的课记</a></li>
									<li><a href="https://yuque.com/samzong/ap" target="_blank">果粉日记</a></li>
									<li><a href="https://yuque.com/samzong/code" target="_blank">Code Snippet</a></li>
									<li><a href="https://www.yuque.com/samzong/mcx" target="_blank">集</a></li>
									<li><a href="https://www.yuque.com/zooka" target="_blank">藏金阁</a></li>
								</ul>
						  </li>
  					</ul>
  					<form id="search-form" class="navbar-form navbar-right" role="search">
  						<div class="form-group">
  						<input type="text" class="form-control input-sm" placeholder="Search's Bad" id="query">
  						</div>
  					</form>
  					<div class="nav-icon">
  						<a href="/feed.xml"><i class="fa fa-rss fa-2x"></i></a>
  					</div>
          </div>
				</div>
      </div>
    </div>

    <div class="container">
			<div class="row mobilepadding">
        <div class="row">
					<div class="col-md-12">
						<div class="searchresult">
						</div>
						<div id="search-loader" class="img-wrap">
						</div>
					</div>
        </div>
				<meta itemprop="image" content="https://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com/uPic/telegram-cloud-photo-size-4-5971176114485308439-x.jpg">
<div class="row">
  <div class="col-xs-12 col-md-8">
    
    
    <h1><a class="title" href="/post/2022/09/Skoala-%E9%83%A8%E7%BD%B2%E6%95%99%E7%A8%8B.html">Skoala 部署教程</a></h1>
    <div class="post_at_index">
      <h2 id="使用之前的话">使用之前的话</h2>

<p>Skoala 的微服务治理和微服务是强依赖的 Ghippo、Insight 和 Kpanda 作为基石；同时 Skoala 也支持了 Mesh 服务治理能力，所以也需要 Mspider。
为了保证良好的使用体验，以及减少不可预知的部署问题，请确认以上组件均可正常工作。</p>

<h3 id="检测方式一">检测方式一</h3>

<p>访问 UI 界面环境，可以在左侧导航栏能够正确看到所有模块，并且可以正常使用。
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1662545276376-f34d4b1d-e736-4552-b873-83421c7a70e8.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-09-07 at 18.07.42@2x.jpg" /></p>

<h3 id="检测方式二">检测方式二</h3>

<p>通过终端查看集群内的 apiserver 是否正常，检查服务 Pod 是否正常运行</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 检测 ghippo</span>
~ kubectl <span class="nt">-n</span> ghippo-system get pods | egrep <span class="s2">"apiserver|ui"</span>
ghippo-apiserver-589c4ddcf6-cmct7              3/3     Running     0          17h
ghippo-apiserver-589c4ddcf6-sts8t              3/3     Running     0          17h
ghippo-ui-7ddddc548c-nsbkj                     2/2     Running     0          94m


<span class="c"># 检查 kpanda</span>
~ kubectl <span class="nt">-n</span> kpanda-system get pods | egrep <span class="s2">"apiserver|ui"</span>
kpanda-apiserver-695b76f476-kdb8l                                 2/2     Running     0          5m56s
kpanda-apiserver-695b76f476-mvllg                                 2/2     Running     0          7m51s
kpanda-clusterpedia-apiserver-574d49c4c-hptm7                     2/2     Running     0          74m
kpanda-clusterpedia-apiserver-574d49c4c-mjm84                     2/2     Running     0          74m
kpanda-ui-5f9586d49b-f4mn2                                        2/2     Running     0          66m
kpanda-ui-5f9586d49b-qpgwd                                        2/2     Running     0          66m


<span class="c"># 检查 Insight</span>
~ kubectl <span class="nt">-n</span> insight-system get pods | egrep <span class="s2">"server|ui"</span>
insight-server-5bbc96bb94-n2wc7                                1/1     Running   0          174m
insight-ui-66b6795c44-zm6qj                                    1/1     Running   0          3h38m


<span class="c"># 检查 mspider</span>
~ kubectl <span class="nt">-n</span> mspider-system get pods | egrep <span class="s2">"api|ui"</span>
mspider-api-service-7d96c6798-mljst       2/2     Running   0          3h20m
mspider-ui-6f5d58cdc6-59hbn               2/2     Running   0          170m
mspider-work-api-684b75dccb-4659g         2/2     Running   0          3h20m
</code></pre></div></div>

<h2 id="配置-skoala-helm-repo">配置 skoala helm repo</h2>

<p>配置好 skoala 仓库，即可查看和获取到 skoala 的应用 chart</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm repo add skoala-release https://release.daocloud.io/chartrepo/skoala
helm repo update
</code></pre></div></div>

<blockquote>
  <p>需要实现安装 Helm</p>
</blockquote>

<h2 id="安装依赖-mysql">安装依赖 mysql</h2>

<p>在安装 skoala 的组件时，hive 和 sesame 需要用到 mysql 组件，所以这里需要预先安装一下 mysql，执行下方 yaml。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 使用如下命令</span>
<span class="s">kubectl -n skoala-system apply -f skoala-mysql.yml</span>
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 保存到 skoala-mysql.yml 文件</span>

<span class="s">~ cat skoala-mysql.yml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">skoala-mysql</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">skoala-system</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">3306</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">mysql</span>
  <span class="na">clusterIP</span><span class="pi">:</span> <span class="s">None</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">skoala-mysql</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">skoala-system</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">mysql</span>
  <span class="na">strategy</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">Recreate</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">mysql</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">release.daocloud.io/skoala/mysql:5.7.32</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">mysql</span>
        <span class="na">env</span><span class="pi">:</span>
          <span class="c1"># Use secret in real usage</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_ROOT_PASSWORD</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">password</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">3306</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">mysql</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">mysql-persistent-storage</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/var/lib/mysql</span>
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">mysql-persistent-storage</span>
        <span class="na">persistentVolumeClaim</span><span class="pi">:</span>
          <span class="na">claimName</span><span class="pi">:</span> <span class="s">mysql-pv-claim</span>
</code></pre></div></div>

<ul>
  <li>注意修改以上，mysql 的密码。</li>
</ul>

<h3 id="初始化-mysql">初始化 mysql</h3>

<p>登录到 pod 内，并成功登录到 mysql 内</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">kubectl -n skoala-system exec pods/`kubectl -n skoala-system get pods | grep skoala-mysql | awk '{print $1}'` -it bash</span>
</code></pre></div></div>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1662548094736-0d938b21-7991-426b-a0b0-9aa19a2d357a.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-09-07 at 18.54.47@2x.jpg" /></p>

<p>初始化数据库表</p>

<ul>
  <li>获取到 mysql 的初始化脚本文件，<a href="https://gitlab.daocloud.cn/ndx/skoala/-/tree/main/app/hive/db">https://gitlab.daocloud.cn/ndx/skoala/-/tree/main/app/hive/db</a></li>
  <li>依次查看对应的文件，并放在 mysql 中执行</li>
</ul>

<p>注意把对应的版本，建议使用最新的版本，这里建议  v0.6.1</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm upgrade <span class="nt">--install</span> skoala <span class="nt">--create-namespace</span> <span class="nt">-n</span> skoala-system <span class="nt">--cleanup-on-fail</span> <span class="se">\</span>
<span class="nt">--set</span> image.tag<span class="o">=</span>v0.6.1 <span class="se">\</span>
skoala/skoala-agent <span class="se">\</span>
<span class="nt">--version</span> 0.6.1
</code></pre></div></div>

<p>这里会将资源部署到 skoala-system 命名空间内，可以通过查看该命名空间内的资源来查看是否部署成功。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~ kubectl <span class="nt">-n</span> skoala-system get pods
NAME                           READY   STATUS    RESTARTS         AGE
hive-96b58785c-shhnh           0/1     Running   0                23h
sesame-cdd894f74-l55hw         0/1     Running   0                23h
ui-7df9754f85-v2gg5            1/1     Running   0                23h
</code></pre></div></div>

<h2 id="安装-skoala">安装 Skoala</h2>

<h3 id="查看-skaola-当前最新版本">查看 skaola 当前最新版本</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm search repo skoala-release/skoala <span class="nt">--versions</span>
NAME                CHART VERSION APP VERSION DESCRIPTION
skoala-release/skoala       0.6.1         0.6.1       The helm chart <span class="k">for </span>Skoala
skoala-release/skoala       0.6.0         0.6.0       The helm chart <span class="k">for </span>Skoala
skoala-release/skoala       0.5.1         0.5.1       The helm chart <span class="k">for </span>Skoala
</code></pre></div></div>

<h3 id="执行部署">执行部署</h3>

<p>这里注意各个组件的版本，建议安装如下版本，直接执行命令即可，【在 demo 部署时】</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">helm upgrade --install skoala --create-namespace -n skoala-system --cleanup-on-fail \</span>
<span class="s">--set ui.image.tag=v0.5.3 \</span>
<span class="s">--set hive.image.tag=v0.6.1 \</span>
<span class="s">--set sesame.image.tag=v0.6.1 \</span>
<span class="s">daocloud-registry/skoala \</span>
<span class="s">--version 0.6.1</span>
</code></pre></div></div>

<p>查看部署的 pod 是否启动成功</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">~ kubectl -n skoala-system get pods</span>
<span class="s">NAME                           READY   STATUS             RESTARTS          AGE</span>
<span class="s">hive-96b58785c-shhnh           1/1     Running            0                 25h</span>
<span class="s">sesame-cdd894f74-l55hw         1/1     Running            0                 25h</span>
<span class="s">skoala-mysql-75dc5cfc7-99tbs   1/1     Running            0                 25h</span>
<span class="s">ui-7df9754f85-v2gg5            1/1     Running            0                 23h</span>
</code></pre></div></div>

<h3 id="卸载">卸载</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">helm uninstall skoala -n skoala-system</span>
</code></pre></div></div>

<h3 id="更多参数的配置">更多参数的配置</h3>

<table>
  <thead>
    <tr>
      <th><strong>Key</strong></th>
      <th><strong>Type</strong></th>
      <th><strong>Default</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>global.image.pullPolicy</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"IfNotPresent"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>global.image.repository</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"release.daocloud.io"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>global.imageCredentials.email</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">""</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>global.imageCredentials.password</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">""</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>global.imageCredentials.username</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">""</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>global.imagePullSecrets</td>
      <td>list</td>
      <td><code class="language-plaintext highlighter-rouge">[]</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>global.istioInjection.enable</td>
      <td>bool</td>
      <td><code class="language-plaintext highlighter-rouge">true</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>global.namespace</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"skoala-system"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.chart-repos.skoala.name</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"skoala"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.chart-repos.skoala.password</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">""</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.chart-repos.skoala.url</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"https://release.daocloud.io/chartrepo/skoala"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.chart-repos.skoala.user</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">""</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.client.ghippo.kubeconfig</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">""</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.client.ghippo.timeout</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">30</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.client.insight</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"insight-server.insight-system:80"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.client.kpanda</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"kpanda-apiserver.kpanda-system:80"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.client.mspider</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"mspider-api-service.mspider-system:8081"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.client.mspider_mcpc</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"mspider-work-api.mspider-system:8081"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.data.database.database</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"hive"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.data.database.driver</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"mysql"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.data.database.host</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"skoala-mysql"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.data.database.max-connection-lifetime</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">20</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.data.database.max-idle-connections</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">150</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.data.database.max-open-connections</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">150</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.data.database.password</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"dangerous"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.data.database.port</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">3306</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.data.database.user</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"root"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.data.server.grpc.addr</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"0.0.0.0:9091"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.data.server.grpc.timeout</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"1s"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.data.server.http.addr</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"0.0.0.0:8081"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.data.server.http.timeout</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"1s"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.enable</td>
      <td>bool</td>
      <td><code class="language-plaintext highlighter-rouge">true</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.image.name</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"skoala/hive"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.image.pullPolicy</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"IfNotPresent"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.image.tag</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"v0.6.0"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.nameOverride</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"hive"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.replicaCount</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">1</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.resources</td>
      <td>object</td>
      <td><code class="language-plaintext highlighter-rouge">{}</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.service.grpc.nodePort</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">30091</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.service.grpc.port</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">9091</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.service.http.nodePort</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">30081</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.service.http.port</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">8081</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.service.type</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"NodePort"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.chart-repos.skoala.name</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"skoala"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.chart-repos.skoala.password</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">""</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.chart-repos.skoala.url</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"https://release.daocloud.io/chartrepo/skoala"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.chart-repos.skoala.user</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">""</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.client.ghippo.kubeconfig</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">""</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.client.ghippo.timeout</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">30</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.client.insight</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"insight-server.insight-system:80"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.client.kpanda</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"kpanda-apiserver.kpanda-system:80"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.data.server.grpc.addr</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"0.0.0.0:9092"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.data.server.grpc.timeout</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"1s"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.data.server.http.addr</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"0.0.0.0:8082"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.data.server.http.timeout</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"1s"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.log.development</td>
      <td>bool</td>
      <td><code class="language-plaintext highlighter-rouge">true</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.log.disable-color</td>
      <td>bool</td>
      <td><code class="language-plaintext highlighter-rouge">false</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.log.disable-stacktrace</td>
      <td>bool</td>
      <td><code class="language-plaintext highlighter-rouge">false</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.log.enable-caller</td>
      <td>bool</td>
      <td><code class="language-plaintext highlighter-rouge">true</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.log.error-output-paths</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"dist/log/skoala-sesame.error.log"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.log.format</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"console"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.log.level</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"debug"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.log.name</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"skoala-sesame"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.log.output-paths</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"dist/log/skoala-sesame.log,stdout"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.enable</td>
      <td>bool</td>
      <td><code class="language-plaintext highlighter-rouge">true</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.image.name</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"skoala/sesame"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.image.pullPolicy</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"IfNotPresent"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.image.tag</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"v0.6.0"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.nameOverride</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"sesame"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.replicaCount</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">1</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.resources</td>
      <td>object</td>
      <td><code class="language-plaintext highlighter-rouge">{}</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.service.grpc.nodePort</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">30092</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.service.grpc.port</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">9092</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.service.http.nodePort</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">30082</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.service.http.port</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">8082</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.service.type</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"NodePort"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ui.enable</td>
      <td>bool</td>
      <td><code class="language-plaintext highlighter-rouge">true</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ui.image.name</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"skoala/skoala-ui"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ui.image.pullPolicy</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"IfNotPresent"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ui.image.tag</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"v0.4.0"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ui.nameOverride</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"ui"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ui.replicaCount</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">1</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ui.resources</td>
      <td>object</td>
      <td><code class="language-plaintext highlighter-rouge">{}</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ui.service.nodePort</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">30090</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ui.service.port</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">80</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ui.service.type</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"NodePort"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>create</td>
      <td>bool</td>
      <td><code class="language-plaintext highlighter-rouge">true</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ui.serviceAccount.name</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">""</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ui.tolerations</td>
      <td>list</td>
      <td><code class="language-plaintext highlighter-rouge">[]</code></td>
      <td> </td>
    </tr>
  </tbody>
</table>

<h2 id="安装-skoala-agent">安装 skoala-agent</h2>

<p>安装步骤说明</p>

<h3 id="查看当前最新版本">查看当前最新版本</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">~ helm search repo skoala-release/skoala-agent --versions</span>
<span class="s">NAME                CHART VERSION APP VERSION DESCRIPTION</span>
<span class="s">skoala/skoala-agent 0.6.1         0.6.1       A Helm chart for Skoala Agent</span>
<span class="s">skoala/skoala-agent 0.6.0         0.6.0       A Helm chart for Kubernetes</span>
<span class="s">skoala/skoala-agent 0.5.1         0.5.1       A Helm chart for Kubernetes</span>
<span class="s">skoala/skoala-agent 0.5.0         0.5.0       A Helm chart for Kubernetes</span>
</code></pre></div></div>

<h3 id="部署">部署</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">helm upgrade --install skoala-agent --create-namespace -n skoala-agent --cleanup-on-fail \</span>
<span class="s">--set image.tag=v0.6.1 \</span>
<span class="s">skoala/skoala-agent \</span>
<span class="s">--version 0.6.1</span>
</code></pre></div></div>

<p>查看部署的 pod 是否启动成功</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">~ kubectl -n skoala-agent get pods</span>
<span class="s">NAME                            READY   STATUS    RESTARTS   AGE</span>
<span class="s">skoala-agent-679c6d64b4-tb7k4   1/1     Running   0          26h</span>
</code></pre></div></div>

<h3 id="卸载命令">卸载命令</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">helm uninstall skoala-agent -n skoala-agent</span>
</code></pre></div></div>

<h3 id="更多参数设置">更多参数设置</h3>

<table>
  <thead>
    <tr>
      <th>Key</th>
      <th>Type</th>
      <th>Default</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>affinity</td>
      <td>object</td>
      <td><code class="language-plaintext highlighter-rouge">{}</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>autoscaling.enabled</td>
      <td>bool</td>
      <td><code class="language-plaintext highlighter-rouge">false</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>autoscaling.maxReplicas</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">100</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>autoscaling.minReplicas</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">1</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>autoscaling.targetCPUUtilizationPercentage</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">80</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>fullnameOverride</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">""</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>image.pullPolicy</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"IfNotPresent"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>image.repository</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"release-ci.daocloud.io/skoala/skoala-agent"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>image.tag</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"v0.6.0"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>imagePullSecrets</td>
      <td>list</td>
      <td><code class="language-plaintext highlighter-rouge">[]</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ingress.annotations</td>
      <td>object</td>
      <td><code class="language-plaintext highlighter-rouge">{}</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ingress.className</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">""</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ingress.enabled</td>
      <td>bool</td>
      <td><code class="language-plaintext highlighter-rouge">false</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ingress.hosts[0].host</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"chart-example.local"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ingress.hosts[0].paths[0].path</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"/"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ingress.hosts[0].paths[0].pathType</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"ImplementationSpecific"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ingress.tls</td>
      <td>list</td>
      <td><code class="language-plaintext highlighter-rouge">[]</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>istioInjection.enable</td>
      <td>bool</td>
      <td><code class="language-plaintext highlighter-rouge">true</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>nameOverride</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">""</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>nodeSelector</td>
      <td>object</td>
      <td><code class="language-plaintext highlighter-rouge">{}</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>podAnnotations</td>
      <td>object</td>
      <td><code class="language-plaintext highlighter-rouge">{}</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>podSecurityContext</td>
      <td>object</td>
      <td><code class="language-plaintext highlighter-rouge">{}</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>replicaCount</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">1</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>resources</td>
      <td>object</td>
      <td><code class="language-plaintext highlighter-rouge">{}</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>securityContext</td>
      <td>object</td>
      <td><code class="language-plaintext highlighter-rouge">{}</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>service.port</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">443</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>service.type</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"NodePort"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>serviceAccount.annotations</td>
      <td>object</td>
      <td><code class="language-plaintext highlighter-rouge">{}</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>serviceAccount.create</td>
      <td>bool</td>
      <td><code class="language-plaintext highlighter-rouge">false</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>serviceAccount.name</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">""</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>tolerations</td>
      <td>list</td>
      <td><code class="language-plaintext highlighter-rouge">[]</code></td>
      <td> </td>
    </tr>
  </tbody>
</table>

      
    </div>
    <br/>
    <div>
      <cite>2022-09-20</cite> <i class="icon-tag"></i>
      <a href="/tags.html#Skoala">Skoala</a>
      
      
      
    </div>
    <div style="clear: both;"></div>
    <hr/>
    
    
    <h1><a class="title" href="/post/2022/09/%E4%BD%BF%E7%94%A8-canal-%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A2%9E%E9%87%8F%E5%90%8C%E6%AD%A5.html">使用 canal 进行数据库增量同步</a></h1>
    <div class="post_at_index">
      <p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1662586780206-7328e88e-c0e3-4e2f-ac6d-e072747efc4a.png?x-oss-process=image/resize,w_960,m_lfit" alt="image.png" /></p>

<h2 id="简介">简介</h2>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/20191104101735947.png?x-oss-process=image/resize,w_960,m_lfit" alt="image" /></p>

<p><strong>canal [kə’næl]</strong>，译意为水道/管道/沟渠，主要用途是基于 MySQL 数据库增量日志解析，提供增量数据订阅和消费</p>

<p>早期阿里巴巴因为杭州和美国双机房部署，存在跨机房同步的业务需求，实现方式主要是基于业务 trigger 获取增量变更。从 2010 年开始，业务逐步尝试数据库日志解析获取增量变更进行同步，由此衍生出了大量的数据库增量订阅和消费业务。</p>

<p>基于日志增量订阅和消费的业务包括</p>

<ul>
  <li>数据库镜像</li>
  <li>数据库实时备份</li>
  <li>索引构建和实时维护 (拆分异构索引、倒排索引等)</li>
  <li>业务 cache 刷新</li>
  <li>带业务逻辑的增量数据处理</li>
</ul>

<p>当前的 canal 支持源端 MySQL 版本包括 5.1.x , 5.5.x , 5.6.x , 5.7.x , 8.0.x</p>

<h2 id="工作原理">工作原理</h2>

<h3 id="mysql-主备复制原理">MySQL 主备复制原理</h3>

<p><img src="../assets/ev1v2m/468c1a14-e7ad-3290-9d3d-44ac501a7227.jpg" alt="image" /></p>

<ul>
  <li>MySQL master 将数据变更写入二进制日志 ( binary log, 其中记录叫做二进制日志事件 binary log events，可以通过 show binlog events 进行查看)</li>
  <li>MySQL slave 将 master 的 binary log events 拷贝到它的中继日志 (relay log)</li>
  <li>MySQL slave 重放 relay log 中事件，将数据变更反映它自己的数据</li>
</ul>

<h3 id="canal-工作原理">canal 工作原理</h3>

<ul>
  <li>canal 模拟 MySQL slave 的交互协议，伪装自己为 MySQL slave，向 MySQL master 发送 dump 协议</li>
  <li>MySQL master 收到 dump 请求，开始推送 binary log 给 slave (即 canal )</li>
  <li>canal 解析 binary log 对象 (原始为 byte 流)</li>
</ul>

<h2 id="文档支持">文档支持</h2>

<ul>
  <li><a href="https://github.com/alibaba/canal/wiki/Home">Home</a></li>
  <li><a href="https://github.com/alibaba/canal/wiki/Introduction">Introduction</a></li>
  <li><a href="https://github.com/alibaba/canal/wiki/QuickStart">QuickStart</a>
    <ul>
      <li><a href="https://github.com/alibaba/canal/wiki/Docker-QuickStart">Docker QuickStart</a></li>
      <li><a href="https://github.com/alibaba/canal/wiki/Canal-Kafka-RocketMQ-QuickStart%22">Canal Kafka/RocketMQ QuickStart</a></li>
      <li><a href="https://github.com/alibaba/canal/wiki/aliyun-RDS-QuickStart">Aliyun RDS for MySQL QuickStart</a></li>
      <li><a href="https://github.com/alibaba/canal/wiki/Prometheus-QuickStart">Prometheus QuickStart</a></li>
    </ul>
  </li>
  <li>Canal Admin
    <ul>
      <li><a href="https://github.com/alibaba/canal/wiki/Canal-Admin-QuickStart">Canal Admin QuickStart</a></li>
      <li><a href="https://github.com/alibaba/canal/wiki/Canal-Admin-Guide">Canal Admin Guide</a></li>
      <li><a href="https://github.com/alibaba/canal/wiki/Canal-Admin-ServerGuide">Canal Admin ServerGuide</a></li>
      <li><a href="https://github.com/alibaba/canal/wiki/Canal-Admin-Docker">Canal Admin Docker</a></li>
    </ul>
  </li>
  <li><a href="https://github.com/alibaba/canal/wiki/AdminGuide">AdminGuide</a></li>
  <li><a href="https://github.com/alibaba/canal/wiki/ClientExample">ClientExample</a></li>
  <li><a href="https://github.com/alibaba/canal/wiki/ClientAPI">ClientAPI</a></li>
  <li><a href="https://github.com/alibaba/canal/wiki/Performance">Performance</a></li>
  <li><a href="https://github.com/alibaba/canal/wiki/DevGuide">DevGuide</a></li>
  <li><a href="https://github.com/alibaba/canal/wiki/BinlogChange%28mysql5.6%29">BinlogChange(MySQL 5.6)</a></li>
  <li><a href="https://github.com/alibaba/canal/wiki/BinlogChange%28MariaDB%29">BinlogChange(MariaDB)</a></li>
  <li><a href="https://github.com/alibaba/canal/wiki/TableMetaTSDB">TableMetaTSDB</a></li>
  <li><a href="http://alibaba.github.com/canal/release.html">ReleaseNotes</a></li>
  <li><a href="https://github.com/alibaba/canal/releases">Download</a></li>
  <li><a href="https://github.com/alibaba/canal/wiki/FAQ">FAQ</a></li>
</ul>

<h2 id="多语言">多语言</h2>

<p>canal 特别设计了 client-server 模式，交互协议使用 protobuf 3.0 , client 端可采用不同语言实现不同的消费逻辑，欢迎大家提交 pull request</p>

<ul>
  <li>canal java 客户端：<a href="https://github.com/alibaba/canal/wiki/ClientExample">https://github.com/alibaba/canal/wiki/ClientExample</a></li>
  <li>canal c# 客户端：<a href="https://github.com/dotnetcore/CanalSharp">https://github.com/dotnetcore/CanalSharp</a></li>
  <li>canal go 客户端：<a href="https://github.com/CanalClient/canal-go">https://github.com/CanalClient/canal-go</a></li>
  <li>canal php 客户端：<a href="https://github.com/xingwenge/canal-php">https://github.com/xingwenge/canal-php</a></li>
  <li>canal Python 客户端：<a href="https://github.com/haozi3156666/canal-python">https://github.com/haozi3156666/canal-python</a></li>
  <li>canal Rust 客户端：<a href="https://github.com/laohanlinux/canal-rs">https://github.com/laohanlinux/canal-rs</a></li>
  <li>canal Nodejs 客户端：<a href="https://github.com/marmot-z/canal-nodejs">https://github.com/marmot-z/canal-nodejs</a></li>
</ul>

<p>canal 作为 MySQL binlog 增量获取和解析工具，可将变更记录投递到 MQ 系统中，比如 Kafka/RocketMQ，可以借助于 MQ 的多语言能力</p>

<ul>
  <li>参考文档：<a href="https://github.com/alibaba/canal/wiki/Canal-Kafka-RocketMQ-QuickStart">Canal Kafka/RocketMQ QuickStart</a></li>
</ul>

<h2 id="资料整理">资料整理</h2>

<p>canal 的策略是模拟了 MySQL Slave 的行为，因此需要有 SELECT, REPLICATION SLAVE, REPLICATION CLIENT 的权限</p>

      
    </div>
    <br/>
    <div>
      <cite>2022-09-18</cite> <i class="icon-tag"></i>
      <a href="/tags.html#Canal">Canal</a>
      , 
      <a href="/tags.html#MySQL">MySQL</a>
      
      
      
    </div>
    <div style="clear: both;"></div>
    <hr/>
    
    
    <h1><a class="title" href="/post/2022/09/K8s%E7%B3%BB%E5%88%97-%E5%8D%97%E5%8C%97%E6%B5%81%E9%87%8F%E5%92%8C%E4%B8%9C%E8%A5%BF%E6%B5%81%E9%87%8F.html">K8s 系列 南北流量和东西流量</a></h1>
    <div class="post_at_index">
      <h2 id="南北流量和东西流量-是什么意思">南北流量和东西流量 是什么意思？</h2>

<p>在 Service Mesh 微服务架构中，我们常常会听到东西流量和南北流量两个术语。</p>

<p>南北流量（NORTH-SOUTH traffic）和东西流量（EAST-WEST traffic）是数据中心环境中的网络流量模式。下面我们通过一个例子来理解这两个术语。</p>

<p>假设我们尝试通过浏览器访问某些 Web 应用。Web 应用部署在位于某个数据中心的应用服务器中。在多层体系结构中，典型的数据中心不仅包含应用服务器，还包含其他服务器，如负载均衡器、数据库等，以及路由器和交换机等网络组件。假设应用服务器是负载均衡器的前端。</p>

<p>当我们访问 web 应用时，会发生以下类型的网络流量：</p>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/f9c10a68e23f6955cc25c176d2ea98f7.png?x-oss-process=image/resize,w_960,m_lfit" alt="img" style="zoom:80%;" /></p>

<p>数据中心树型拓扑图是一个典型的包含接入层、汇聚层、核心层三层的网络结构。这种结构诞生之初就是为了将外部流量引流到内部应用。</p>

<p>流量从外部穿过防火墙或者数据中心其它外围网络设备进来，对应到上⾯这张图里，流动方向为从上到下，称为南向流量（和地图一样，上北下南），而与之对应的，数据中心内部产生的，离开数据中心的流量，从下到上故称为北向流量。合起来称为南北流量。</p>

<p>在微服务化流行之前，以巨石系统（monolithic）这种单体应用为单位部署的方式，产生的是典型的南北流量。一个单体应用配有一个专门的服务器（或虚拟机），一个外部请求通常在单体应用内独立完成，除了访问数据库等必须依赖服务之外，很少会发生横向的流量。</p>

<p>但云计算机、大数据、微服务、云原生等技术的发展催生了大量的从左到右以及从右到左的流量，也被称为东西流量。</p>

<p>数据中心内部南北流量的削弱，而东西流量的井喷在硬件上要求数据中心要横向扩展以提供更宽的大二层以及容纳更多的服务器，而在软件上则要求一种新的服务编排方式以便能充分挖掘、利用现有的计算能力，从这个角度看 K8s 的出现是一种必然。</p>

<p>举两个例子：</p>

<ul>
  <li>
    <p>客户端（位于数据中心一侧的浏览器）与负载均衡器（位于数据中心）之间的网络流量</p>
  </li>
  <li>
    <p>负载均衡器、应用服务器、数据库等之间的网络流量，它们都位于数据中心。</p>
  </li>
</ul>

<p>在这个例子中，前者即即客户端和服务器之间的流量被称为南北流量。简而言之，南北流量是 server-client 流量。</p>

<p>第二种流量即不同服务器之间的流量与数据中心或不同数据中心之间的网络流被称为东西流量。简而言之，东西流量是 service-service 流量。</p>

<p>当下，东西流量远超南北流量，尤其是在当今的大数据生态系统中，比如 Hadoop 生态系统（大量 server 驻留在数据中心中，用 map reduce 处理），server-server 流量远大于 server-client 流量。</p>

<p>大家可能会好奇，东西南北，为什么这么命名？</p>

<p>该命名来自于绘制典型 network diagrams 的习惯。在图表中，通常核心网络组件绘制在顶部（NORTH），客户端绘制在底部（SOUTH），而数据中心内的不同服务器水平（EAST-WEST）</p>

      
    </div>
    <br/>
    <div>
      <cite>2022-09-12</cite> <i class="icon-tag"></i>
      <a href="/tags.html#K8s">K8s</a>
      
      
      
    </div>
    <div style="clear: both;"></div>
    <hr/>
    
    
    <h1><a class="title" href="/post/2022/08/Docker-for-Mac-%E7%BD%91%E7%BB%9C%E6%8A%80%E5%B7%A7.html">Docker for Mac 网络技巧</a></h1>
    <div class="post_at_index">
      <p>在 Windows 和 Linux 中使用 Docker，可以通过 docker0 这个网络 IP，在容器内访问宿主机的端口及服务</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ ifconfig
docker0: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 172.17.0.1  netmask 255.255.0.0  broadcast 172.17.255.255
        ether 02:42:65:e2:82:de  txqueuelen 0  <span class="o">(</span>Ethernet<span class="o">)</span>
        RX packets 19240  bytes 9107695 <span class="o">(</span>8.6 MiB<span class="o">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 16989  bytes 9952021 <span class="o">(</span>9.4 MiB<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</code></pre></div></div>

<p>但以上在 macOS 中无 docker0 端口，那我们如何在 Docker for Mac 中访问宿主机的服务呢？</p>

<blockquote>
  <p>docker.for.mac.host.internal</p>
</blockquote>

<p>可以采用以上本地域名内实现在容器内访问 宿主机的服务</p>

      
    </div>
    <br/>
    <div>
      <cite>2022-08-17</cite> <i class="icon-tag"></i>
      <a href="/tags.html#Docker">Docker</a>
      , 
      <a href="/tags.html#Mac">Mac</a>
      
      
      
    </div>
    <div style="clear: both;"></div>
    <hr/>
    
    
    <h1><a class="title" href="/post/2022/08/%E7%93%A6%E5%B0%94%E7%99%BB%E6%B9%96.html">瓦尔登湖</a></h1>
    <div class="post_at_index">
      <p><a href="https://www.amazon.cn/s/ref=as_li_ss_tl?_encoding=UTF8\&amp;camp=536\&amp;creative=3132\&amp;field-keywords=%E7%93%A6%E5%B0%94%E7%99%BB%E6%B9%96\&amp;linkCode=ur2\&amp;tag=llll1-23\&amp;url=search-alias%3Dbooks">亨利••大卫••梭罗</a>
7 highlights, 1 note</p>

<ul>
  <li>在这段时间里把车钱挣出来了，会在明天的什么时候到达那里，如果你幸运地及时找到了工作，也可能今晚到达。你大半天的时间不是去了菲奇堡，却是在这里干活。因此，如果铁路通到全世界，我想我还是会在你前头；至于说长见识，如果净是那方面的见识，我就得和你完全断绝来往了。</li>
  <li>如果你决定明天开始做一件事情，那为什么不现在就开始呢？实用主义，不应该追求虚无的东西。</li>
  <li>
    <p>最好在坏事一开始的时候就防止它。</p>
  </li>
  <li>
    <p>在任何一个社会中，书籍的作者都是天生的极富魅力的精英分子，对人类发挥着比帝王们更大的影响。当目不识丁的、也许还是鄙视一切的商人，通过魄力和勤奋挣得了垂涎已久的闲暇和衣食无忧的生活，进入了财富和时尚的圈子以后，最终不可避免地会转向那更高的然而却难以企及的知识和才赋的圈子，这时他才会意识到自己文化的残缺，以及他一切财富的空虚无用；于是他不遗余力地要使子女获得知识文化，他深刻地感到自己这方面的不足，从而证明了他的明智；就这样，他成了一个家族的缔造者。</p>
  </li>
  <li>
    <p>我们应该和古代的圣贤一样优秀，但是首先要知道他们有多么优秀。我们是一群矮子，我们智力翱翔所达之处只不过稍高于报纸的专栏而已。</p>
  </li>
  <li>
    <p>德不孤，必有邻。</p>
  </li>
  <li>
    <p>孤独不能以一个人和别人之间有多少英里的空间来衡量。</p>
  </li>
  <li>在他身上肉体的人得到了充分发展。</li>
</ul>

      
    </div>
    <br/>
    <div>
      <cite>2022-08-15</cite> <i class="icon-tag"></i>
      <a href="/tags.html#读书笔记">读书笔记</a>
      
      
      
    </div>
    <div style="clear: both;"></div>
    <hr/>
    
    
    <h1><a class="title" href="/post/2022/08/Contour-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html">Contour 学习笔记</a></h1>
    <div class="post_at_index">
      <h2 id="contour-官方的资料">Contour 官方的资料</h2>

<ul>
  <li><a href="https://hackmd.io/84Xbl4WBTpm7OBhaOAsSiw">https://hackmd.io/84Xbl4WBTpm7OBhaOAsSiw</a>  Contour Community Meeting Notes</li>
  <li><a href="https://www.youtube.com/watch?v=fpRzvQWiHjI&amp;list=PLk2K7YhXu5KtYU1UGEYNC8ApH5gsWihDJ">https://www.youtube.com/watch?v=fpRzvQWiHjI&amp;list=PLk2K7YhXu5KtYU1UGEYNC8ApH5gsWihDJ</a>  双周例会</li>
  <li><a href="https://kubernetes.slack.com/archives/C8XRH2R4J">https://kubernetes.slack.com/archives/C8XRH2R4J</a>  Slack Chat Channel</li>
  <li><a href="https://bitnami.com/stack/contour/helm">https://bitnami.com/stack/contour/helm</a>  Helm 部署 Contour 资料</li>
  <li><a href="https://juejin.cn/post/7029286464802258974">https://juejin.cn/post/7029286464802258974</a>  Envoy Ingress：Contour 基本原理和源码分析
    <ul>
      <li><a href="https://juejin.cn/user/3878732754069272">https://juejin.cn/user/3878732754069272</a> 掘金大佬</li>
    </ul>
  </li>
</ul>

<h2 id="参考文档一使用-contour-接管-k8s-南北流量">参考文档一：使用 Contour 接管 K8s 南北流量</h2>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1652658255610-3a38d8d3-2062-486b-a0b9-3b0a1d47dc5c.png?x-oss-process=image/resize,w_960,m_lfit" alt="image.png" />
容器公司 <a href="https://heptio.com/">Heptio</a> 开源的项目 <a href="https://github.com/heptio/contour">Contour</a> 使用 Envoy 作为 Kubernetes 的 Ingress Controller 实现。</p>

<h3 id="contour-的组成">Contour 的组成</h3>

<p>Contour Ingress controller 由两个组件组成：</p>

<ul>
  <li>Envoy : 提供高性能反向代理。</li>
  <li>Contour : 充当 Envoy 的控制平面，为 Envoy 的路由配置提供统一的来源。</li>
</ul>

<h3 id="contour-的部署方式">Contour 的部署方式</h3>

<p>官方文档提供了三种部署方法：</p>

<ol>
  <li>通过 DaemonSet 来部署，每个节点上跑一个 Contour 实例（Contour 与 Envoy 在同一个 Pod 中）。</li>
  <li>通过 Deployment 来部署，总共跑两个 Contour 实例（Contour 与 Envoy 在同一个 Pod 中）。</li>
  <li>通过 Deployment 来部署 Contour，总共跑两个 Contour 实例；通过 DaemonSet 来部署 Envoy，每个节点上跑一个 Envoy 实例。</li>
</ol>

<p>第三种方案比较巧妙，这样可以让 Contour 和 Envoy 这两个组件解耦，可以分别按需对不同的组件进行扩展，具体的优势如下：</p>

<ul>
  <li>Envoy 以 Daemonset 的形式运行，具有很强的扩展性，后续可通过 ipvs 和 keepalived 等工具来实现其负载均衡和高可用。</li>
  <li>Envoy 运行的网络模式是 hostNetwork，减少了额外的网络性能损耗。</li>
  <li>Contour 与 Envoy 之间通过双向认证的自签名证书进行通信，大大增强了安全性。</li>
  <li>升级 Contour 不需要重启 Envoy。</li>
</ul>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1652658571911-263003fa-2d88-47d9-9650-7929589a49c8.png?x-oss-process=image/resize,w_960,m_lfit" alt="image.png" /></p>

<blockquote>
  <p>启动分析</p>
</blockquote>

<p>在 Envoy 的 Pod 初始化期间，Contour 作为 Init 容器运行，并将 bootstrap（初始化）配置写入一个 temporary volume。该 Volume 被传递给 Envoy 容器并告诉 Envoy 将另一个 Deployment 中的 Contour 容器视为控制平面。</p>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1652659925765-50a45ceb-22f8-44a9-8c48-34fa832cda3e.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="image" /></p>

<blockquote>
  <p>Contour 会根据启动参数和 K8S API Server 中的配置信息生成 Envoy 的初始配置文件</p>
</blockquote>

<ol>
  <li>Envoy initContainer 根据启动参数和 K8S API Server 中的配置信息生成 Envoy 的初始配置文件 envoy.json，该文件告诉 Envoy 从 xDS server 中获取动态配置信息，并配置了 xDS server 的地址信息，即控制平面的 Contour。</li>
  <li>Envoy 使用配置文件 envoy.json 启动。</li>
  <li>Envoy 根据获取到的动态配置启动 Listener，并根据 Listener 的配置，结合 Route 和 Cluster 对进入的流量进行处理。</li>
</ol>

<p>Contour 作为 Envoy 的 initContainer</p>

<h2 id="参考文档-二contour-中-envoy-优雅停服的实现与源码分析">参考文档 二：Contour 中 Envoy 优雅停服的实现与源码分析</h2>

      
    </div>
    <br/>
    <div>
      <cite>2022-08-10</cite> <i class="icon-tag"></i>
      <a href="/tags.html#Contour">Contour</a>
      
      
      
    </div>
    <div style="clear: both;"></div>
    <hr/>
    
    
    <h1><a class="title" href="/post/2022/07/%E9%80%9A%E8%BF%87pipreqs%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E9%A1%B9%E7%9B%AE%E7%9A%84%E4%BE%9D%E8%B5%96%E5%BA%93.html">通过 pipreqs 获取当前项目的依赖库</a></h1>
    <div class="post_at_index">
      <p>如果在开始开发一个项目时，未注意项目的依赖库隔离；可能会导致后续给项目打包时：</p>

<ul>
  <li>导致缺少依赖库，导致项目初始化麻烦</li>
  <li>读取了全局依赖库，导致项目安装了大量的实际无用的库</li>
</ul>

<p>这里推荐一个专门解决这个问题的 Python 库， <code class="language-plaintext highlighter-rouge">pipreqs</code></p>

<h3 id="使用注意事项">使用注意事项</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># linux &amp; mac</span>
pipreqs <span class="nv">$python_project_dir</span>

<span class="c"># Windows 需要增加 --encoding=utf-8 字母编码，否则会有出错，懂得都懂</span>
pipreqs ./ <span class="nt">--encoding</span><span class="o">=</span>utf-8

<span class="c"># 会自动在当前目录生成一个 requirements.txt， 如果已存在会提示失败</span>
<span class="c"># 也可以使用 --force 强制覆盖</span>
pipreqs <span class="nb">.</span> <span class="nt">--force</span>
</code></pre></div></div>

<h3 id="支持的其他功能">支持的其他功能</h3>

<p>更多的功能，可以在安装后研究下，通过 -h 可以获取更多有价值的信息</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>\--diff &lt;file&gt;         将 requirements.txt 中的模块与项目导入进行比较。  &gt;&gt; 仅追加
\--clean &lt;file&gt;     通过删除项目中没有导入的模块来清理 requirements.txt   &gt;&gt; 瘦身
</code></pre></div></div>

      
    </div>
    <br/>
    <div>
      <cite>2022-07-24</cite> <i class="icon-tag"></i>
      <a href="/tags.html#Python">Python</a>
      
      
      
    </div>
    <div style="clear: both;"></div>
    <hr/>
    
    
    <h1><a class="title" href="/post/2022/07/Contour-&-Envoy-%E6%8C%87%E6%A0%87.html">Contour & Envoy 指标</a></h1>
    <div class="post_at_index">
      <h2 id="contour--envoy-指标">Contour &amp; Envoy 指标</h2>

<p>本文档内容与Contour与 Envoy 的metrics相关, 据Contour与envoy的官网内容并参考源码、第三方blog等汇总而成. 因为 Contour 指标较少, 所以在文中全部列出,且个人主观的将其暂分为:必须与可选的； 在envoy中 metrics被称为stats 通过管理接口向公众暴露,因其指标过多,所以按官方建议只选取Cluster与HCM相关指标,并只抽取个人认为比较重要且现阶段需要的指标列出,如需要相看详情,请点击相应链接.</p>

<h2 id="contour-指标">Contour 指标</h2>

<table>
  <thead>
    <tr>
      <th>Required</th>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>YES</td>
      <td>contour_build_info</td>
      <td>Gauge</td>
      <td>branch, revision, version</td>
      <td> </td>
    </tr>
    <tr>
      <td>NO</td>
      <td>contour_cachehandler_onupdate_duration_seconds</td>
      <td>Summary</td>
      <td>Histogram for the runtime of xDS cache regeneration.</td>
      <td> </td>
    </tr>
    <tr>
      <td>YES</td>
      <td>contour_dagrebuild_timestamp</td>
      <td>Gauge</td>
      <td>Timestamp of the last DAG rebuild.</td>
      <td> </td>
    </tr>
    <tr>
      <td>NO</td>
      <td>contour_dagrebuild_total</td>
      <td>Counter</td>
      <td>Total number of times DAG has been rebuilt since startup</td>
      <td> </td>
    </tr>
    <tr>
      <td>YES</td>
      <td>contour_eventhandler_operation_total</td>
      <td>Counter</td>
      <td>Total number of Kubernetes object changes Contour has received by operation and object kind.</td>
      <td> </td>
    </tr>
    <tr>
      <td>YES</td>
      <td>contour_httpproxy</td>
      <td>Gauge</td>
      <td>Total number of HTTPProxies that exist regardless of status.</td>
      <td> </td>
    </tr>
    <tr>
      <td>NO</td>
      <td>contour_httpproxy_invalid</td>
      <td>Gauge</td>
      <td>Total number of invalid HTTPProxies.</td>
      <td> </td>
    </tr>
    <tr>
      <td>NO</td>
      <td>contour_httpproxy_orphaned</td>
      <td>Gauge</td>
      <td>Total number of orphaned HTTPProxies which have no root delegating to them.</td>
      <td> </td>
    </tr>
    <tr>
      <td>YES</td>
      <td>contour_httpproxy_root</td>
      <td>Gauge</td>
      <td>Total number of root HTTPProxies. Note there will only be a single</td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>YES</td>
      <td>contour_httpproxy_valid</td>
      <td>Gauge</td>
      <td>Total number of valid HTTPProxies.</td>
      <td> </td>
    </tr>
  </tbody>
</table>

<h2 id="envoy-指标">Envoy 指标</h2>

<h3 id="cluster"><a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/upstream/cluster_manager/cluster_stats#config-cluster-manager-cluster-stats">Cluster</a></h3>

<h3 id="general">General</h3>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>cluster_added/modified/removed/updated</td>
      <td>Counter</td>
      <td>Total clusters added / modified / removed / updated</td>
    </tr>
    <tr>
      <td>active_clusters</td>
      <td>Gauge</td>
      <td>Number of currently active (warmed) clusters</td>
    </tr>
    <tr>
      <td>upstream_cx_total</td>
      <td>Counter</td>
      <td>Total connections</td>
    </tr>
    <tr>
      <td>upstream_cx_active</td>
      <td>Gauge</td>
      <td>Total active connections</td>
    </tr>
    <tr>
      <td>upstream_cx_connect_fail</td>
      <td>Counter</td>
      <td>Total connection failures</td>
    </tr>
    <tr>
      <td>upstream_cx_connect_timeout</td>
      <td>Counter</td>
      <td>Total connection connect timeouts</td>
    </tr>
    <tr>
      <td>upstream_cx_connect_ms</td>
      <td>Histogram</td>
      <td>Connection establishment milliseconds</td>
    </tr>
    <tr>
      <td>upstream_cx_rx_bytes_total</td>
      <td>Counter</td>
      <td>Total received connection bytes</td>
    </tr>
    <tr>
      <td>upstream_cx_tx_bytes_total</td>
      <td>Counter</td>
      <td>Total sent connection bytes</td>
    </tr>
    <tr>
      <td>upstream_rq_total</td>
      <td>Counter</td>
      <td>Total requests</td>
    </tr>
    <tr>
      <td>upstream_rq_active Gauge</td>
      <td>Total</td>
      <td>active requests</td>
    </tr>
    <tr>
      <td>upstream_rq_timeout</td>
      <td>Counter</td>
      <td>Total requests that timed out waiting for a response</td>
    </tr>
    <tr>
      <td>upstream_rq_retry</td>
      <td>Counter</td>
      <td>Total request retries</td>
    </tr>
    <tr>
      <td>upstream_rq_retry_success</td>
      <td>Counter</td>
      <td>Total request retry successes</td>
    </tr>
  </tbody>
</table>

<h3 id="request-response-size-statistics">Request Response Size statistics</h3>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>upstream_rq_headers_size</td>
      <td>Histogram</td>
      <td>Request headers size in bytes per upstream</td>
    </tr>
    <tr>
      <td>upstream_rq_body_size</td>
      <td>Histogram</td>
      <td>Request body size in bytes per upstream</td>
    </tr>
    <tr>
      <td>upstream_rs_headers_size</td>
      <td>Histogram</td>
      <td>Response headers size in bytes per upstream</td>
    </tr>
    <tr>
      <td>upstream_rs_body_size</td>
      <td>Histogram</td>
      <td>Response body size in bytes per upstream</td>
    </tr>
  </tbody>
</table>

<h3 id="hcm"><a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/stats#statistics">HCM</a></h3>

<h3 id="general-1"><a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/stats#statistics">General</a></h3>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>downstream_cx_total</td>
      <td>Counter</td>
      <td>Total connections</td>
    </tr>
    <tr>
      <td>downstream_cx_active</td>
      <td>Gauge</td>
      <td>Total active connections</td>
    </tr>
    <tr>
      <td>downstream_cx_rx_bytes_total</td>
      <td>Counter</td>
      <td>Total bytes received</td>
    </tr>
    <tr>
      <td>downstream_cx_tx_bytes_total</td>
      <td>Counter</td>
      <td>Total bytes sent</td>
    </tr>
    <tr>
      <td>downstream_rq_total</td>
      <td>Counter</td>
      <td>Total requests</td>
    </tr>
    <tr>
      <td>downstream_rq_active</td>
      <td>Gauge</td>
      <td>Total active requests</td>
    </tr>
    <tr>
      <td>downstream_rq_1/2/3/4/5xx</td>
      <td>Counter</td>
      <td>Total 1/2/3/4/5xx responses</td>
    </tr>
    <tr>
      <td>downstream_rq_completed</td>
      <td>Counter</td>
      <td>Total requests that resulted in a response (e.g. does not include aborted requests)</td>
    </tr>
    <tr>
      <td>downstream_rq_time</td>
      <td>Histogram</td>
      <td>Total time for request and response (milliseconds)</td>
    </tr>
  </tbody>
</table>

<h3 id="per-user-agent-statistics"><a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/stats#per-user-agent-statistics">Per user agent statistics</a></h3>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>downstream_cx_total</td>
      <td>Counter</td>
      <td>Total connections</td>
    </tr>
    <tr>
      <td>downstream_rq_total</td>
      <td>Counter</td>
      <td>Total requests</td>
    </tr>
  </tbody>
</table>

<h3 id="http-per-listener-statistics"><a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/stats#http-per-listener-statistics">HTTP per listener statistics¶</a></h3>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>downstream_rq_completed</td>
      <td>Counter</td>
      <td>Total responses</td>
    </tr>
    <tr>
      <td>downstream_rq_1/2/3/4/5xx</td>
      <td>Counter</td>
      <td>Total 1/2/3/4/5xx responses</td>
    </tr>
  </tbody>
</table>

<h3 id="tracing-statistics"><a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/stats#tracing-statistics">Tracing statistics</a></h3>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>random_sampling</td>
      <td>Counter</td>
      <td>Total number of traceable decisions by random sampling</td>
    </tr>
    <tr>
      <td>service_forced</td>
      <td>Counter</td>
      <td>Total number of traceable decisions by server runtime flag tracing.global_enabled</td>
    </tr>
    <tr>
      <td>client_enabled</td>
      <td>Counter</td>
      <td>Total number of traceable decisions by request header x-envoy-force-trace</td>
    </tr>
    <tr>
      <td>not_traceable</td>
      <td>Counter</td>
      <td>Total number of non-traceable decisions by request id</td>
    </tr>
    <tr>
      <td>health_check</td>
      <td>Counter</td>
      <td>Total number of non-traceable decisions by health check</td>
    </tr>
  </tbody>
</table>

<h2 id="参考">参考</h2>

<ul>
  <li><a href="https://projectcontour.io/guides/prometheus/">Collecting Metrics with Prometheus</a></li>
  <li><a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/upstream/cluster_manager/cluster_stats#config-cluster-manager-cluster-stats">Cluster Stats</a></li>
  <li><a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/stats#statistics">HTTP Stats</a></li>
  <li><a href="https://prometheus.io/docs/concepts/metric_types/#Counter">Counter</a></li>
  <li><a href="https://prometheus.io/docs/concepts/metric_types/#Gauge">Gauge</a></li>
  <li><a href="https://prometheus.io/docs/concepts/metric_types/#Summary">Summary</a></li>
</ul>

<hr />

<p>关于监控指标的问题答疑：</p>

<ul>
  <li>实时 启动之后一直有的</li>
  <li>时间范围的数据</li>
  <li>数据统计维度
    <ul>
      <li>contour httpproxy count</li>
      <li>envoy request count</li>
      <li>httpproxy -&gt; route -&gt; request info summary</li>
    </ul>
  </li>
  <li>现阶段暂时未接入 prom，需要考虑如何处理，接入后会联动到 grafana，这部分跟 insight 怎么处理</li>
  <li>告警怎么做？拿到了数据指标之后怎么处理</li>
</ul>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/image-20221120000945266.png?x-oss-process=image/resize,w_960,m_lfit" alt="image-20221120000945266" /></p>

      
    </div>
    <br/>
    <div>
      <cite>2022-07-22</cite> <i class="icon-tag"></i>
      <a href="/tags.html#Contour">Contour</a>
      
      
      
    </div>
    <div style="clear: both;"></div>
    <hr/>
    
    
    <h1><a class="title" href="/post/2022/07/jq-%E5%91%BD%E4%BB%A4%E8%A1%8C-Json-%E5%A4%84%E7%90%86%E7%A5%9E%E5%99%A8.html">jq 命令行 Json 处理神器</a></h1>
    <div class="post_at_index">
      <ul>
  <li>
    <p><a href="https://mozillazg.com/2018/01/jq-use-examples-cookbook.html">https://mozillazg.com/2018/01/jq-use-examples-cookbook.htm</a>-</p>
  </li>
  <li>
    <p>jq 命令日常练习 <a href="https://jqplay.org/s/KhRuUFCP2h">https://jqplay.org/s/KhRuUFCP2h</a></p>
  </li>
</ul>

<p>一个灵活的轻量级命令行 JSON 处理器</p>

<h2 id="说明">说明</h2>

<p>jq 是 stedolan 开发的一个轻量级的和灵活的命令行 JSON 处理器，源码请参考 <a href="https://github.com/stedolan/jq">jq 项目主页</a> 。jq 用于处理 JSON 输入，将给定过滤器应用于其 JSON 文本输入并在标准输出上将过滤器的结果生成为 JSON；最简单的过滤器是<code class="language-plaintext highlighter-rouge">.</code>，它将 jq 的输入未经修改地复制到其输出中（格式设置除外）；请注意，jq 当前仅支持 64 位双精度浮点数（IEEE754）。</p>

<h2 id="安装">安装</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Debian系，如 Ubuntu</span>
<span class="nb">sudo </span>apt-get <span class="nb">install </span>jq

<span class="c"># RedHat系, 如 CentOS</span>
yum <span class="nb">install </span>jq

<span class="c"># MacOS</span>
brew <span class="nb">install </span>jq
</code></pre></div></div>

<h2 id="语法">语法</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jq <span class="o">[</span>options] &lt;jq filter&gt; <span class="o">[</span>file...]
jq <span class="o">[</span>options] <span class="nt">--args</span> &lt;jq filter&gt; <span class="o">[</span>strings...]
jq <span class="o">[</span>options] <span class="nt">--jsonargs</span> &lt;jq filter&gt; <span class="o">[</span>JSON_TEXTS...]
</code></pre></div></div>

<h2 id="选项">选项</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">-c</span>               紧凑而不是漂亮的输出<span class="p">;</span>
<span class="nt">-n</span>               使用<span class="sb">`</span>null<span class="sb">`</span>作为单个输入值<span class="p">;</span>
<span class="nt">-e</span>               根据输出设置退出状态代码<span class="p">;</span>
<span class="nt">-s</span>               将所有输入读取（吸取）到数组中；应用过滤器<span class="p">;</span>
<span class="nt">-r</span>               输出原始字符串，而不是JSON文本<span class="p">;</span>
<span class="nt">-R</span>               读取原始字符串，而不是JSON文本<span class="p">;</span>
<span class="nt">-C</span>               为JSON着色<span class="p">;</span>
<span class="nt">-M</span>               单色（不要为JSON着色）<span class="p">;</span>
<span class="nt">-S</span>               在输出上排序对象的键<span class="p">;</span>
<span class="nt">--tab</span>            使用制表符进行缩进<span class="p">;</span>
<span class="nt">--arg</span> a v        将变量<span class="nv">$a</span>设置为value&lt;v&gt;<span class="p">;</span>
<span class="nt">--argjson</span> a v    将变量<span class="nv">$a</span>设置为JSON value&lt;v&gt;<span class="p">;</span>
<span class="nt">--slurpfile</span> a f  将变量<span class="nv">$a</span>设置为从&lt;f&gt;读取的JSON文本数组<span class="p">;</span>
<span class="nt">--rawfile</span> a f    将变量<span class="nv">$a</span>设置为包含&lt;f&gt;内容的字符串<span class="p">;</span>
<span class="nt">--args</span>           其余参数是字符串参数，而不是文件<span class="p">;</span>
<span class="nt">--jsonargs</span>       其余的参数是JSON参数，而不是文件<span class="p">;</span>
<span class="nt">--</span>               终止参数处理<span class="p">;</span>
</code></pre></div></div>

<h2 id="例子">例子</h2>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">.</code>: 以漂亮的方式输出</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'{ "foo": { "bar": { "baz": 123 } } }'</span> | jq <span class="s1">'.'</span>
<span class="o">{</span>
  <span class="s2">"foo"</span>: <span class="o">{</span>
    <span class="s2">"bar"</span>: <span class="o">{</span>
      <span class="s2">"baz"</span>: 123
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">.foo, .foo.bar, .foo?</code>: 获取一个键的值</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'{"foo": 42, "bar": "less interesting data"}'</span> | jq <span class="s1">'.foo'</span>
42
</code></pre></div></div>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">.[], .[]?, .[2], .[10:15]</code>: 数组运算</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'[{"name":"JSON", "good":true}, {"name":"XML", "good":false}]'</span> | jq <span class="s1">'.[1]'</span>
<span class="o">{</span>
  <span class="s2">"name"</span>: <span class="s2">"XML"</span>,
  <span class="s2">"good"</span>: <span class="nb">false</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">[], {}</code>: 构造一个数组/对象</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'{"user":"stedolan","titles":["JQ Primer", "More JQ"]}'</span> | jq <span class="s1">'{user, title: .titles[]}'</span>
<span class="o">{</span>
  <span class="s2">"user"</span>: <span class="s2">"stedolan"</span>,
  <span class="s2">"title"</span>: <span class="s2">"JQ Primer"</span>
<span class="o">}</span>
<span class="o">{</span>
  <span class="s2">"user"</span>: <span class="s2">"stedolan"</span>,
  <span class="s2">"title"</span>: <span class="s2">"More JQ"</span>
<span class="o">}</span>
</code></pre></div></div>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">length</code>: 计算一个值的长度</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'[[1,2], "string", {"a":2}, null]'</span> | jq <span class="s1">'.[] | length'</span>                                  
2
6
1
0
</code></pre></div></div>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">keys</code>: 取出数组中的键</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'{"abc": 1, "abcd": 2, "Foo": 3}'</span> | jq <span class="s1">'keys'</span>                                        
<span class="o">[</span>
  <span class="s2">"Foo"</span>,
  <span class="s2">"abc"</span>,
  <span class="s2">"abcd"</span>
<span class="o">]</span>
</code></pre></div></div>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">,</code>: 使用多个过滤器</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'{ "foo": 42, "bar": "something else", "baz": true}'</span> | jq <span class="s1">'.foo, .bar'</span> 
42
<span class="s2">"something else"</span>
</code></pre></div></div>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">|</code>: 通过管道将一个过滤器的输出当做下一个过滤器的输入</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'[{"name":"JSON", "good":true}, {"name":"XML", "good":false}]'</span> | jq <span class="s1">'.[] | .name'</span>                                                 
<span class="s2">"JSON"</span>
<span class="s2">"XML"</span>
</code></pre></div></div>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">select(foo)</code>: 如果 foo 返回 true，则输入保持不变</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'[1,5,3,0,7]'</span> | jq <span class="s1">'map(select(. &gt;= 2))'</span>                                                    
<span class="o">[</span>
  5,
  3,
  7
<span class="o">]</span>
</code></pre></div></div>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">map(foo)</code>: 每个输入调用过滤器</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'[1,2,3]'</span> | jq <span class="s1">'map(.+1)'</span>
<span class="o">[</span>
  2,
  3,
  4
<span class="o">]</span>
</code></pre></div></div>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">if-then-else-end</code>: 条件判断</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'2'</span> | jq <span class="s1">'if . == 0 then "zero" elif . == 1 then "one" else "many" end'</span>
<span class="s2">"many"</span>
</code></pre></div></div>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">\(foo)</code>: 在字符串中插入值并进行运算</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">'42'</span> | jq <span class="s1">'"The input was \(.), which is one less than \(.+1)"'</span>          
<span class="s2">"The input was 42, which is one less than 43"</span>
</code></pre></div></div>

      
    </div>
    <br/>
    <div>
      <cite>2022-07-22</cite> <i class="icon-tag"></i>
      <a href="/tags.html#unix command">unix command</a>
      
      
      
    </div>
    <div style="clear: both;"></div>
    <hr/>
    
    
    <h1><a class="title" href="/post/2022/07/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%95%E6%93%8E%E7%BD%91%E5%85%B3%E8%83%BD%E5%8A%9B%E4%BB%8B%E7%BB%8D.html">微服务引擎网关能力介绍</a></h1>
    <div class="post_at_index">
      <p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1656640362731-d86ebb64-4193-4e1e-8f45-7248a8d70fc3.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="image" /></p>

<h2 id="产品介绍">产品介绍</h2>

<h3 id="什么是-skoala-gateway">什么是 Skoala-gateway？</h3>

<p>Skoala-gateway 是 DCE 5.0 云原生平台上微服务引擎 Skoala 模块内的微服务网关产品，基于云原生平台之上，提供了云原生微服务的南北向流量治理的分布式网关中间件，Skoala-gateway 原生提供了 API 管理、接口限流、多种策略安全认证、黑白名单、路由转发、MockAPI 等能力，同时提供了企业级高性能和高扩展的云服务能力。
Skoala-gateway 采用了业界领先的主流微服务网关开源项目 Contour 和 Envoy 的能力，可以做到全面兼容市面上主要的原生平台，如 Kubernetes、OpenShift 等，并保持着良好的后续迭代优势。
![image.png](../assets/qwoqr6/1656640383767-868c5dfc-73db-4cbe-8c93-5fa4aa8a2799.png</p>

<blockquote>
  <p>Skoala-gateway 能力介绍</p>
</blockquote>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1656651655498-71bcaa69-e6c0-4f04-93df-3587e749c182.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="image" /></p>

<h3 id="什么是微服务网关">什么是微服务网关？</h3>

<p>微服务网关作为云原生微服务的 API 统一的外部流量入口，网关承接了所有访问微服务 API 的请求，所以肩负着保护、增强和控制对于微服务的安全访问、管理授权、访问控制和流量限制等，这样微服务就会被微服务网关保护起来，对所有的调用者透明。因此，隐藏在 Skoala-gateway 后面的业务系统就可以更加专注于业务本身。
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1656641290967-99b03c4c-217a-408f-b77c-761ad5226417.png?x-oss-process=image/resize,w_960,m_lfit" alt="image.png" title="对比采用微服务网关前后" />
在云原生时代，采用统一的微服务网关来完成对外的流量治理、流量分发、鉴权能力等，这样微服务本身可以关注在业务内容背身；对于网络管理和安全这些基础能力，重复在不同的微服务实现成本极高且维护不变，另外微服务内无法很好的实现流量的治理，所以将流量管理和认证管理的能力，使用独立的微服务中间件来完成，会极大提升系统的自由度和专业性。</p>

<h3 id="产品优势">产品优势</h3>

<ul>
  <li><strong>多实例管理能力</strong>：只需简单的 2 个步骤，即可完成一个网关实例的部署，支持多实例聚合管理</li>
  <li><strong>完美兼容开源：</strong>100% 兼容开源网关，开箱即用，用户从自建网关迁移无门槛</li>
  <li><strong>强大的界面 UI</strong>：100% 网关功能支持 UI 操作和可视化查看，提供现今的网关结构拓扑，网关数据可视化，一目了然</li>
  <li><strong>高性能高可靠：</strong>依托于云原生平台，支持动态部署，无缝扩缩容，轻松应对流量洪峰</li>
  <li><strong>强大的集成能力</strong>：
    <ul>
      <li><strong>服务发现</strong>：依托于 DCE5.0 Skoala 微服务引擎和 Kpanda 容器服务，无缝集成容器和微服务体系，同时支持支持 Nacos、Mesh、Eureka、Zookeeper、K8s 等多种服务发现方式，均可实现自动发现</li>
      <li><strong>日志监控</strong>：依托于 DCE5.0 Insight 产品提供强大的监控预警和完善的日志追踪能力，极大提升问题排查分析效率</li>
    </ul>
  </li>
</ul>

<h3 id="应用场景">应用场景</h3>

<p>微服务网关提供多网关的高效管理能力，在 Contour 的基础上增加界面操作能力，大大降低了使用门槛和维护成本，而基于 DCE5.0 产品平台，您可以无感的实现多网关实例的管理；这样可以研发团队仅需关注对应网关的业务规则和业务逻辑，而不需关注网关的实现。</p>

<blockquote>
  <p><strong>需要 不同的项目组和集群需要独立的网关</strong></p>
</blockquote>

<p><strong>Skoala-gateway 原生支持多实例部署能力</strong>，当您存在较多集群和多项目同时对微服务网关有依赖时，而不希望所有项目在一个网关造成服务瓶颈或者网关资源开销过大，建议您采用 Skoala-gateway 微服务网关，您可以非常方便在不同集群和不同项目之间进行创建独立的网关，网关实例之间互相隔离，提高网关的可用性和稳定性。</p>

<blockquote>
  <p><strong>需要 针对 API 级别进行精细化认证和限流管理</strong></p>
</blockquote>

<p><strong>Skoala-gateway 原生支持针对 API 级别的限流控制</strong>，您只需要在 SKoala-gateway 内的插件中心，为网关实例开启限流服务，便可以在不同的 API 或 API 分组中，创建对应的限流策略，并且支持不同级联层级的网关限流控制</p>

<h3 id="名词说明">名词说明</h3>

<p>对 Skoala-gateway 提及的专有名词进行解释，所有文档应保持相同定义</p>

<table>
  <thead>
    <tr>
      <th>名词</th>
      <th>释义</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>DCE 5.0</td>
      <td>由 DaoCloud 自主研发的新一代云原生服务平台，包含了 Kpanda、Insight、Ghippo、Skoala 等众多强大产品模块</td>
    </tr>
    <tr>
      <td>目前已迭代到 第五代，下文简称“DCE5.0”</td>
      <td> </td>
    </tr>
    <tr>
      <td>Skoala</td>
      <td>DCE5.0 产品模块中负责 微服务引擎和流量治理、网关能力，承接全部云原生平台南北流量和东西流量的分配和治理能力，原生支持多实例网关联合管理</td>
    </tr>
    <tr>
      <td>Skoala-gateway</td>
      <td>Skoala 产品内负责南北向流量治理的产品模块，支持跨集群服务发现和详细化路由管理等能力</td>
    </tr>
    <tr>
      <td>Kpanda</td>
      <td>DCE5.0 产品模块中负责 容器集群的管理平台，支持接入和创建全部主流的云原生容器平台</td>
    </tr>
    <tr>
      <td>Insight</td>
      <td>DCE5.0 产品模块中负责 监控告警和日志管理模块，承接了整个 DCE 平台所有服务模块的日志和监控诉求，为 Skoala 提供了全生命周期的日志管理能力</td>
    </tr>
    <tr>
      <td>Ghippo</td>
      <td>DCE5.0 产品模块中负责 账号及权限、资源分配模块；创新实现 Workspace 设计；以 DCE5.0 视角，全面统一了资源划分和权限结构体系，为 Skoala 提供了完善的权限划分等能力</td>
    </tr>
  </tbody>
</table>

<h2 id="常见问题">常见问题</h2>

<h2 id="功能介绍">功能介绍</h2>

<h3 id="网关多实例管理模块">网关多实例管理模块</h3>

<p>Skoala-gateway 原生支持对 Kpanda 管理的多集群、多命名空间的的网关实例进行管理，您可以通过 Skoala-gateway 管理界面，仅需简单的操作，即可完成网关实例进行管理，包括创建、删除、查询、修改等操作。</p>

<p>每个网关支持在一个集群下对多个命名空间内的微服务网关管理的接管，您可以在配置中方便的进行调整；不过您需要注意一个命名空间同时只能被一个微服务网关管理。</p>

<h3 id="api-管理模块">API 管理模块</h3>

<p>您可以通过 Skoala-gateway 管理界面，非常方便的对网关下的路由 API 进行管理，通过简单的界面化操作即可完成，API 的创建、编辑等能力；这是原生 Contour 不支持的功能，当然在增加 Contour 管理能力的同时，我们也会保障原生 API 的能力不受影响；但非常建议您通过界面化的方式来管理。</p>

<p>您可以给 API 附加丰富的策略，例如：请求重写策略、重试机制以及限流策略等，默认情况下限流能力不开启，您可以在需要时针对开启，当然这些会需要一个资源支出。</p>

<h3 id="服务接入模块">服务接入模块</h3>

<p>Skoala-gateway 旨在让您可以方便的对 API 背后的服务进行路由管理，Skoala 支持非常丰富的服务接入能力，可以很轻易的将您的微服务接入到网关下，无论它部署在哪里，Skoala 同时支持对运行在 Kpanda 上的微服务自动进行服务发现。</p>

<h3 id="域名管理模块">域名管理模块</h3>

<p>Skoala-gateway 原生提供了便捷的域名管理能力，支持方便的将统一的服务域名预先配置，在创建 API 时，仅做简单的选取即可；同时支持 HTTP 和 HTTPS 服务域名管理，HTTPS 支持多种证书托管模式。</p>

<h3 id="插件中心模块">插件中心模块</h3>

<p>Skoala-gateway 同时也提供了丰富的的插件功能，支持安全、流量管控、缓存等组件，您可以根据实际的业务需求，方便您根据实际的业务需要，在网关中启用这些组件。</p>

<h3 id="监控告警模块">监控告警模块</h3>

<p>Skoala-gateway 在部署时会自动配置监控、告警等功能；每个网关都自带了完善的资源监控和网关业务监控，同时也支持接入待 Insight（DCE5.0 重磅观测产品），您可以利用 Insight 更加丰富的观测手段，自定义完成您的业务监控。</p>

<h3 id="日志查看模块">日志查看模块</h3>

<p>Skoala-gateway 原生接入了 DCE 5.0 强大 Insight 日志管理模块，提供了非常全面的业务日志和网关实例日志查看、链路追踪能力；支持实时更新，配合网关实例不同级别的日志提醒，您可以非常方便的完成详细日志的输出，提高业务分析和日志排查效率。</p>

<h4 id="业务日志查看">业务日志查看</h4>

<p>在 Skoala-gateway 日志查看模块，对业务日志提供了查询优化，您可以方便通过关键字、时间、日志内容、服务名、API 名称等进行秒级查询，通知支持您切换查看不用的后端服务日志，以便于快速定位问题。</p>

<h4 id="实例日志查看">实例日志查看</h4>

<p>Skoala-gateway 依托 Insight 提供了 微服务网关的全生命周期的日志记录能力，可以提供实时、准确的实例日志查看能力，为了网关容器和部署调试提供了详细的日志支持。</p>

<h3 id="权限管理模块">权限管理模块</h3>

<p>Skoala-gateway 同样支持 DCE5.0 权限管理模块的能力，支持利用 Ghippo 权限管理模块，自定义权限管理策略，授权不同成员对网关的管理权限，这一切都是 DCE5.0 平台内统一的标准化能力，您可以很轻易的完成。</p>

<h2 id="用户手册">用户手册</h2>

<p>SKoala-gateway 用户手册，帮助您快速了解本产品的全部功能。</p>

<h3 id="快速上手">快速上手</h3>

<p>带您快速了解并可以快速上手体验使用 Skoala-gateway 微服务网关的产品能力。</p>

<h4 id="操作步骤">操作步骤</h4>

<ol>
  <li>进入微服务网关管理页面</li>
  <li>完成创建微服务网关
    <ol>
      <li>输入网关名称</li>
      <li>选择部署区域</li>
    </ol>
  </li>
  <li><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1658858115798-1a9600e1-354a-44ac-a463-3c184725348e.jpeg?x-oss-process=image/resize,w_560,m_lfit" alt="CleanShot 2022-07-27 at 01.55.03@2x.jpg" /></li>
  <li>创建后等待网关初始化和启动成功，这是网关状态会展示为“运行中”</li>
  <li>在列表中点击网关名称进入网关详情，通过右侧导航栏，找到 API 列表</li>
  <li>点击创建 API，按步骤完成 API 创建
    <ol>
      <li>输入 API 名称</li>
      <li>选择关联域名，如果找不到域名，可以根据提示去接入域名</li>
      <li>填写 匹配规则</li>
      <li>选择 目标服务，目标服务会根据自动发现和手工接入（需要到服务列表接入）、重定向、直接返回多种类型</li>
    </ol>
  </li>
  <li><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1658858936831-6d6aa7e5-035e-4e68-bc23-681db50b9131.jpeg?x-oss-process=image/resize,w_560,m_lfit" alt="CleanShot 2022-07-27 at 02.08.44@2x.jpg" /></li>
  <li>完成 API 创建后，即可通过请求列表，查看对应的 API 结果</li>
  <li>通过左侧导航栏 日志查看，查看对应的请求信息</li>
  <li>通过 监控告警，查看对应的监控信息</li>
</ol>

<h3 id="微服务网关功能列表">微服务网关功能列表</h3>

<table>
  <thead>
    <tr>
      <th><strong>功能分类</strong></th>
      <th><strong>功能项</strong></th>
      <th><strong>子功能项</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>微服务网关多实例管理</td>
      <td>实例列表</td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td>添加实例</td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td>移除实例</td>
      <td> </td>
    </tr>
    <tr>
      <td>微服务网关详情</td>
      <td>实例概览</td>
      <td>基本信息</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td>连接信息</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td>网关数据</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td>资源数据</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td>API 请求排行</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td>资源负载</td>
    </tr>
    <tr>
      <td> </td>
      <td>API 管理</td>
      <td>创建 API</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td>编辑 API 规则</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td>API 上下线管理</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td>批量管理 API</td>
    </tr>
    <tr>
      <td> </td>
      <td>服务接入</td>
      <td>手工接入服务</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td>自动发现服务列表</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td>服务接入来源管理</td>
    </tr>
    <tr>
      <td> </td>
      <td>域名管理</td>
      <td>添加域名</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td>编辑域名信息</td>
    </tr>
    <tr>
      <td> </td>
      <td>监控告警</td>
      <td>业务监控看板</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td>网关实例监控看板</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td>监控告警规则</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td>自定义告警通知方式</td>
    </tr>
    <tr>
      <td> </td>
      <td>日志查看</td>
      <td>业务日志查看</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td>业务日志源数据查看</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td>网关实例日志查看</td>
    </tr>
    <tr>
      <td> </td>
      <td>插件中心</td>
      <td>全局限流插件</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td>安全认证插件</td>
    </tr>
    <tr>
      <td>微服务网关管理</td>
      <td>网关调试模式</td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td>网关手工重启</td>
      <td> </td>
    </tr>
  </tbody>
</table>

      
    </div>
    <br/>
    <div>
      <cite>2022-07-21</cite> <i class="icon-tag"></i>
      <a href="/tags.html#Skoala">Skoala</a>
      
      
      
    </div>
    <div style="clear: both;"></div>
    <hr/>
    

    <!-- Pagination links -->
    <nav>
      <ul class="pagination hidden-xs">
        
        
        <li>
          <a href="/">&laquo; Previous</a>
        </li>
        
        

        
        <li>
          <a href="/">1</a>
        </li>
        

        
          
            
              
                <li class="active"><a>2</a></li>
                
            
              
                <li><a href="/page3">3</a></li>
              
            
              
                <li><a href="/page4">4</a></li>
              
            
              
                <li><a href="/page5">5</a></li>
              
            
          
          <li class="disabled"><span>...</span></li>
          <li><a href="/page24">24</a></li>
        

        
        

        
        <li>
          <a href="/page3">Next &raquo;</a>
        </li>
        
      </ul>
    </nav>
  </div>
  <div class="col-xs-12 col-md-4">
		<!-- <div>
			<a class="twitter-timeline" data-width="390" data-height="640" data-theme="light" href="https://twitter.com/samzong_lu?ref_src=twsrc%5Etfw">Tweets by SAMZONG</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
		</div> -->
    <div>
      <h2>传送门</h2>
      <ul>
        <li><a href="https://yuque.com/samzong">语雀-花园</a></li>
        <li><a href="https://github.com/samzong">Github</a></li>
      </ul>
    </div>
    <div class="categories">
      <h2>文章分类</h2>
      <ul class="tag_box">
        
        


  
     
    	
      <li><a href="/categories.html#故事汇">
    		故事汇 <span>23</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#Linux">
    		Linux <span>22</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#前端">
    		前端 <span>5</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#数据库">
    		数据库 <span>30</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#Git">
    		Git <span>6</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#Mac">
    		Mac <span>16</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#Tools">
    		Tools <span>7</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#OpenSource">
    		OpenSource <span>11</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#Python">
    		Python <span>45</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#云平台">
    		云平台 <span>8</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#虚拟化">
    		虚拟化 <span>3</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#Java">
    		Java <span>6</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#Docker">
    		Docker <span>6</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#Blog">
    		Blog <span>7</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#安全">
    		安全 <span>1</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#读书笔记">
    		读书笔记 <span>16</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#微服务">
    		微服务 <span>2</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#Kubernetes">
    		Kubernetes <span>14</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#DaoCloud Enterprise">
    		DaoCloud Enterprise <span>2</span>
    	</a></li>
    
  



      </ul>
    </div>
    <div>
      <h2>最近文章</h2>
      <ul>
        
        <li>
          <a href="/post/2022/11/Copy-To-Markdwon.html">Copy to Markdown</a>
          背景


        </li>
        
        <li>
          <a href="/post/2022/11/Dubbo-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86.html">Dubbo 基础知识梳理</a>
          
  参考资料：



        </li>
        
        <li>
          <a href="/post/2022/11/Panads-fill-NaN-value-to-Zero.html">Panads fill NaN value to Zero</a>
          ```python
df = pandas.read_csv(‘somefile.txt’)


        </li>
        
        <li>
          <a href="/post/2022/10/Redash-for-Docker-%E9%83%A8%E7%BD%B2.html">Redash for Docker 部署</a>
          
  暗坑很多



        </li>
        
        <li>
          <a href="/post/2022/10/JWT-%E5%86%85%E7%BD%AE%E7%9A%84%E6%96%B9%E5%BC%8F.html">JWT 内置的方式</a>
          
  支持为 API 启用 jwt token 解码的能力 ,  读取网关的 jwt key
    
      读取请求 Header 中的 Authorization
    
  
  需要支持为网关配置多 jwt key , and 加密长度 ?
    
      解密的性能问题
      expire_time 过期时间的配置
      解密后的参数传递
    
  



        </li>
        
      </ul>
    </div>
  </div>
</div>

			</div>

		</div>

    <footer>
      <div class="container">
        <div class="row mobilepadding">
          			<hr>
      &copy; 2022 船长. Powered by <a href="http://jekyllrb.com" target="_blank" title="The simple, blog-aware, static site generator.">Jekyll</a>. Theme Creator <a href="https://github.com/einverne" target="_blank" title="Ein Verne's GitHub Repos">Ein Verne</a> . Host on <a href="https://github.com/samzong/samzong.me" target="_blank" title="Samzong's GitHub Repos">Github</a> .
      <br><br>
      </div>
    </div>
    </footer>

    




	<script async type="text/javascript" src="/assets/themes/evjekylltheme/bootstrap-3.3.5/js/bootstrap.min.js"></script>
	<script async type="text/javascript" src="/assets/themes/evjekylltheme/webcore.js"></script>

 </body>
</html>

