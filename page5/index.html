
<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/Blog">
  <head>
    <meta charset="utf-8">
	<link rel="manifest" href="/pwa/manifest.json">
	<title> Home | 船长的课记 </title>
    
		
    <meta name="author" content="船长">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="theme-color" content="#2196F3">
	<meta name="google-site-verification" content="puZt0ZyqB-t67BYdYAgLUyIPBeismG68J0dmEc01QeY" />

	
    <script>
		if ('serviceWorker' in navigator) {
			window.addEventListener('load', function () {
				navigator.serviceWorker
										.register('/sw.js')
										.then(function(registration) {
											console.log("Successfully registered service worker", registration.scope);
										}).catch(function(err) {
											console.log("Service worker registration failed: ", err);
										});
				//navigator.serviceWorker.ready always resolve
				navigator.serviceWorker.ready.then(function (registration) {
					console.log('Service worker successfully registered on scope', registration.scope);
				});
			});
		}
    </script>
	<script type="text/javascript" src="/assets/themes/evjekylltheme/jquery-3.6.0.slim.min.js"></script>

	<link href="/assets/themes/evjekylltheme/google-code-prettify/desert.css" type="text/css" rel="stylesheet" />

    <!-- Le styles -->
    <link href="/assets/themes/evjekylltheme/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/evjekylltheme/css/style.css" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="/images/favicon.ico">

    <!-- atom & rss feed -->
    <link href="" type="application/atom+xml" rel="alternate" title="Jekyll auto generate ATOM Feed">
    <link href="" type="application/atom+xml" rel="alternate" title="Site ATOM Feed">
    <link href="" type="application/rss+xml" rel="alternate" title="Site RSS Feed">
	<link rel="stylesheet" href="/assets/themes/evjekylltheme/font-awesome-4.4.0/css/font-awesome.min.css">
	<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
	new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
	j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
	'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
	})(window,document,'script','dataLayer','GTM-W2LDG64');</script>
		<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8529425670069509"
						crossorigin="anonymous"></script>
	<script async src="https://cdn.splitbee.io/sb.js"></script>
  </head>

  <body>
	<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W2LDG64"
	height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <div class="navbar navbar-default navbar-fixed-top">
				<div class="container">
          <div class="row mobilepadding">
					<!-- <a class="navbar-brand" href="/">船长的课记</a> -->
					<a class="navbar-brand" href="/">SAMZONG</a>
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#mNavbar">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <div class="collapse navbar-collapse" id="mNavbar">
  					<ul class="nav navbar-nav">
  						
  						
  						


  
    
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/friends.html">Friends</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  
    
  
    
  
    
  
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  



						  <li class="dropdown">
							  <a class="dropdown-toggle" data-toggle="dropdown" href="#">Other</a>
							  <ul class="dropdown-menu">
									<li><a href="/about.html">About</a></li>
									<li><a href="https://yuque.com/samzong/note" target="_blank">船长的课记</a></li>
									<li><a href="https://yuque.com/samzong/ap" target="_blank">果粉日记</a></li>
									<li><a href="https://yuque.com/samzong/code" target="_blank">Code Snippet</a></li>
									<li><a href="https://www.yuque.com/samzong/mcx" target="_blank">集</a></li>
									<li><a href="https://www.yuque.com/zooka" target="_blank">藏金阁</a></li>
								</ul>
						  </li>
  					</ul>
  					<form id="search-form" class="navbar-form navbar-right" role="search">
  						<div class="form-group">
  						<input type="text" class="form-control input-sm" placeholder="Search" id="query">
  						</div>
  					</form>
  					<div class="nav-icon">
  						<a href="/feed.xml"><i class="fa fa-rss fa-2x"></i></a>
  					</div>
          </div>
				</div>
      </div>
    </div>

    <div class="container">
			<div class="row mobilepadding">
        <div class="row">
					<div class="col-md-12">
						<div class="searchresult">
						</div>
						<div id="search-loader" class="img-wrap">
						</div>
					</div>
        </div>
				<meta itemprop="image" content="https://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com/uPic/telegram-cloud-photo-size-4-5971176114485308439-x.jpg">
<div class="row">
  <div class="col-xs-12 col-md-8">
    
    
    <h1><a class="title" href="/post/2017/05/Wannacry%E8%A0%95%E8%99%AB%E7%97%85%E6%AF%92%E4%BA%8B%E4%BB%B6%E5%8F%8A%E4%BF%AE%E5%A4%8D%E6%96%B9%E6%A1%88.html">Wannacry蠕虫病毒事件及修复方案</a></h1>
    <div class="post_at_index">
      <p><img src="https://samzong.oss-cn-shenzhen.aliyuncs.com/blog/3d0jo.png" alt="" /></p>

<h3 id="事件背景">事件背景</h3>

<p>5月12日晚， WannaCry 蠕虫病毒在全球大肆爆发。据BBC、CNN等媒体报道，恶意攻击者利用 NSA（美国国家安全局）泄露的 Windows 0day 利用工具对99个国家实施了超过75000次攻击，主要影响SMB和RDP服务，主要影响了137、138、139、445端口。</p>

<p>目前已知已知的Windows版本包括但不限于一下都受影响：</p>

<ul>
  <li>Windows NT</li>
  <li>Windows 2000</li>
  <li>Windows XP</li>
  <li>Windows 2003</li>
  <li>Windows Vista</li>
  <li>Windows 7</li>
  <li>Windows 8</li>
  <li>Windows 10</li>
  <li>Windows 2008</li>
  <li>Windows 2008 R2</li>
  <li>Windows Server 2012 SP0</li>
</ul>

<p>勒索者源头来自暗网，攻击具备兼容性、多语言支持，多个行业受到影响，国内高校网络系统沦为感染重灾区。据有关机构统计，目前国内每天有数万台机器遭到该蠕虫病毒袭击，国内的ATM机、火车站、自助终端、邮政、医院、政府办事终端、视频监控都可能遭受攻击。据报道，今日全国多地的中石油加油站无法进行网络支付，只能进行现金支付。中石油有关负责人表示，怀疑受到病毒攻击，具体情况还在核查。而截至目前，一些公安系统已经遭到入侵。</p>

<p>如果你也遇到了这样的问题，请不要担心，我在下面给出了如何修复这个漏洞的建议。</p>

<p><img src="https://samzong.oss-cn-shenzhen.aliyuncs.com/blog/9y7cc.jpg" alt="" /></p>

<h3 id="什么是比特币蠕虫病毒">什么是比特币蠕虫病毒？</h3>

<p>这次攻击的始作俑者是一款名为“WannaCry”（中文名：想哭）的勒索病毒，带有加密功能，它利用 Windows 在 445 端口的安全漏洞潜入电脑并对多种文件类型加密并添加后缀(.onion)使用户无法打开，用户电脑存在文档被加密的情况，攻击者称需支付比特币解锁。(比特币是一种全球通用的互联网加密货币)</p>

<h3 id="漏洞验证">漏洞验证</h3>

<ol>
  <li>
    <p>使用<code>Win</code>+<code>R</code>按键打开运行窗口，输入cmd，进入命令行工具，然后输入<code>netstat -an</code> 查看是否开放了对应的端口。</p>

    <p><img src="https://samzong.oss-cn-shenzhen.aliyuncs.com/blog/3m1jm.png" alt="" /></p>

    <p>上图中的服务器就是开放了445端口，这有很大的风险可能会WannaCry 蠕虫病毒被攻击到，所以我们应该关掉对应端口，并修复漏洞。</p>

    <h3 id="漏洞修复">漏洞修复</h3>

    <ol>
      <li>目前微软已发布补丁MS17-010修复了“永恒之蓝”攻击的系统漏洞，请尽快为电脑安装此补丁，网址为<a href="https://laod.cn/go.php?url=https://technet.microsoft.com/zh-cn/library/security/MS17-010">https://technet.microsoft.com/zh-cn/library/security/MS17-010</a></li>
      <li>对于XP、2003等微软已不再提供安全更新的机器，推荐使用360“NSA武器库免疫工具”检测系统是否存在漏洞，并关闭受到漏洞影响的端口，可以避免遭到勒索软件等病毒的侵害，可以在360电脑安全管家中找到。</li>
      <li>开启系统防火墙，利用系统防火墙的“高级设置”阻止外部对 445 端口进的访问（存在一定影响，该操作会影响使用 445 端口的服务）。</li>
    </ol>
  </li>
</ol>

<h3 id="修复脚本">修复脚本</h3>

<p>如果以上方式都不能修复漏洞，大家可以使用我以下的批处理脚本文件来尝试关闭端口及服务，批处理禁用该漏洞可能利用到的端口，全版本通用，右键管理员启动即可，注意这需要打开Windows的防火墙。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net stop SCardSvr
net stop SCPolicySvc
sc config SCardSvr <span class="nv">start</span><span class="o">=</span>disabled
sc config SCPolicySvc <span class="nv">start</span><span class="o">=</span>disabled
net start MpsSvc
sc config MpsSvc <span class="nv">start</span><span class="o">=</span>auto
netsh advfirewall <span class="nb">set </span>allprofiles state on
netsh advfirewall firewall add rule <span class="nv">name</span><span class="o">=</span><span class="s2">"deny udp 137"</span> <span class="nb">dir</span><span class="o">=</span><span class="k">in </span><span class="nv">protocol</span><span class="o">=</span>udp <span class="nv">localport</span><span class="o">=</span>137 <span class="nv">action</span><span class="o">=</span>block
netsh advfirewall firewall add rule <span class="nv">name</span><span class="o">=</span><span class="s2">"deny tcp 137"</span> <span class="nb">dir</span><span class="o">=</span><span class="k">in </span><span class="nv">protocol</span><span class="o">=</span>tcp <span class="nv">localport</span><span class="o">=</span>137 <span class="nv">action</span><span class="o">=</span>block
netsh advfirewall firewall add rule <span class="nv">name</span><span class="o">=</span><span class="s2">"deny udp 138"</span> <span class="nb">dir</span><span class="o">=</span><span class="k">in </span><span class="nv">protocol</span><span class="o">=</span>udp <span class="nv">localport</span><span class="o">=</span>138 <span class="nv">action</span><span class="o">=</span>block
netsh advfirewall firewall add rule <span class="nv">name</span><span class="o">=</span><span class="s2">"deny tcp 138"</span> <span class="nb">dir</span><span class="o">=</span><span class="k">in </span><span class="nv">protocol</span><span class="o">=</span>tcp <span class="nv">localport</span><span class="o">=</span>138 <span class="nv">action</span><span class="o">=</span>block
netsh advfirewall firewall add rule <span class="nv">name</span><span class="o">=</span><span class="s2">"deny udp 139"</span> <span class="nb">dir</span><span class="o">=</span><span class="k">in </span><span class="nv">protocol</span><span class="o">=</span>udp <span class="nv">localport</span><span class="o">=</span>139 <span class="nv">action</span><span class="o">=</span>block
netsh advfirewall firewall add rule <span class="nv">name</span><span class="o">=</span><span class="s2">"deny tcp 139"</span> <span class="nb">dir</span><span class="o">=</span><span class="k">in </span><span class="nv">protocol</span><span class="o">=</span>tcp <span class="nv">localport</span><span class="o">=</span>139 <span class="nv">action</span><span class="o">=</span>block
netsh advfirewall firewall add rule <span class="nv">name</span><span class="o">=</span><span class="s2">"deny udp 445"</span> <span class="nb">dir</span><span class="o">=</span><span class="k">in </span><span class="nv">protocol</span><span class="o">=</span>udp <span class="nv">localport</span><span class="o">=</span>445 <span class="nv">action</span><span class="o">=</span>block
netsh advfirewall firewall add rule <span class="nv">name</span><span class="o">=</span><span class="s2">"deny tcp 445"</span> <span class="nb">dir</span><span class="o">=</span><span class="k">in </span><span class="nv">protocol</span><span class="o">=</span>tcp <span class="nv">localport</span><span class="o">=</span>445 <span class="nv">action</span><span class="o">=</span>block
pause
</code></pre></div></div>

<p>我已经将脚本上传到百度云盘中，大家可以自行下载运行，注意解压缩Zip包之后的fix_WannaCry.bat</p>

<p>下载链接：https://pan.baidu.com/s/1gfceNRH</p>

<h3 id="添加防火规则">添加防火规则</h3>

<ol>
  <li>
    <p>打开控制面板中的Windows防火墙，并保证防火墙处于启用状态；</p>
  </li>
  <li>
    <p>打开防火墙的高级设置；</p>
  </li>
  <li>
    <p>在“入站规则”中新建一条规则，本地端口号选择445，操作选择阻止连接。</p>

    <p><img src="https://pic3.zhimg.com/v2-85f14330cdba1fbf89369b26b9e48f52_b.png" alt="" /></p>

    <p><img src="https://pic2.zhimg.com/v2-1bbe08395ec8ef8d0e2028cbccb01055_b.png" alt="" /></p>
  </li>
</ol>

<h3 id="手动导入安全策略">手动导入安全策略</h3>

<p>下载策略文件</p>

<p>https://share.weiyun.com/15b7bbd3f86c493a66721dd948a81c54</p>

<p>打开控制面板–管理工具-本地安全策略–IP安全策略 –&gt;所有任务–&gt;导入策略：</p>

<p><img src="https://samzong.oss-cn-shenzhen.aliyuncs.com/blog/hj9f4.jpg" alt="" /></p>

<p>或者，通过<code>Win</code>+<code>R</code>，输入<code>gpedit.msc</code></p>

<p><img src="https://samzong.oss-cn-shenzhen.aliyuncs.com/blog/9vsqx.jpg" alt="" /></p>

<p><img src="https://samzong.oss-cn-shenzhen.aliyuncs.com/blog/tosjk.jpg" alt="" /></p>

      
    </div>
    <br/>
    <div>
      <cite>2017-05-15</cite> <i class="icon-tag"></i>
      <a href="/tags.html#Windows">Windows</a>
      
      
      
    </div>
    <div style="clear: both;"></div>
    <hr/>
    
    
    <h1><a class="title" href="/post/2017/04/CentOS%E5%A2%9E%E5%8A%A0%E6%96%B0%E7%A1%AC%E7%9B%98%E7%BB%99%E6%A0%B9%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E6%89%A9%E5%AE%B9.html">CentOS增加新硬盘给根文件系统扩容</a></h1>
    <div class="post_at_index">
      <p>由于刚开始做磁盘空间规划时，失误给根分区分配磁盘较小，导致后续实验环境无法进行，所以在经过研究后，决定尝试增加根分区的磁盘空间，注意这仅适用于创建在LVM上的文件系统。</p>

<h3 id="实验环境">实验环境</h3>

<ul>
  <li>Parallels Desktop 12</li>
  <li>CentOS 6.9</li>
  <li>根分区空间 6.5GB</li>
  <li>已使用 5.8GB</li>
  <li>预计 增加12G 磁盘空间</li>
</ul>

<!-- more -->

<h3 id="增加一块物理磁盘">增加一块物理磁盘</h3>

<p>Parallels Desktop 不能在线增加磁盘，所以要先将VM关闭，然后添加：
<img src="https://samzong.oss-cn-shenzhen.aliyuncs.com/blog/m5e1d.jpg" alt="" />
增加12G的磁盘
<img src="https://samzong.oss-cn-shenzhen.aliyuncs.com/blog/prgyd.jpg" alt="" /></p>

<p>然后启动VM，这时可以通过<code>fdisk -l</code>查看当前已经增加了一块12G的磁盘</p>

<p><img src="https://samzong.oss-cn-shenzhen.aliyuncs.com/blog/tat9r.jpg" alt="" /></p>

<h3 id="格式化磁盘并加入到vgroup组内">格式化磁盘并加入到VGroup组内</h3>

<h4 id="查看当前pvdisplay磁盘列表将devsdb创建pv块">查看当前<code>pvdisplay</code>磁盘列表，将<code>/dev/sdb</code>创建pv块</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@centos ~]# pvdisplay
  <span class="nt">---</span> Physical volume <span class="nt">---</span>
  PV Name               /dev/sda2
  VG Name               vg_hadoop01
  PV Size               7.51 GiB / not usable 3.00 MiB
  Allocatable           <span class="nb">yes</span> <span class="o">(</span>but full<span class="o">)</span>
  PE Size               4.00 MiB
  Total PE              1922
  Free PE               0
  Allocated PE          1922
  PV UUID               MUCrDa-eJpZ-EXwE-YwwM-S2Az-p2m7-K9q3Fo

<span class="o">[</span>root@centos ~]# pvcreate /dev/sdb
  Physical volume <span class="s2">"/dev/sdb"</span> successfully created
<span class="o">[</span>root@centos ~]# pvdisplay
  <span class="nt">---</span> Physical volume <span class="nt">---</span>
  PV Name               /dev/sda2
  VG Name               vg_hadoop01
  PV Size               7.51 GiB / not usable 3.00 MiB
  Allocatable           <span class="nb">yes</span> <span class="o">(</span>but full<span class="o">)</span>
  PE Size               4.00 MiB
  Total PE              1922
  Free PE               0
  Allocated PE          1922
  PV UUID               MUCrDa-eJpZ-EXwE-YwwM-S2Az-p2m7-K9q3Fo

  <span class="nt">---</span> Physical volume <span class="nt">---</span>
  PV Name               /dev/sdb
  VG Name               vg_hadoop01
  PV Size               12.00 GiB / not usable 4.00 MiB
  Allocatable           <span class="nb">yes
  </span>PE Size               4.00 MiB
  Total PE              3071
  Free PE               3071
  Allocated PE          0
  PV UUID               XTpaBR-512W-vQIV-fwwz-So7L-ZCa3-yjDccQ
</code></pre></div></div>

<h4 id="查看当前vgdisplayvgroup组将devsdb加入根目录所在vgroup">查看当前<code>vgdisplay</code>VGroup组，将<code>/dev/sdb</code>加入根目录所在VGroup</h4>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@centos ~]# vgdisplay
  <span class="nt">---</span> Volume group <span class="nt">---</span>
  VG Name               vg_hadoop01
  System ID
  Format                lvm2
  Metadata Areas        1
  Metadata Sequence No  3
  VG Access             <span class="nb">read</span>/write
  VG Status             resizable
  MAX LV                0
  Cur LV                2
  Open LV               2
  Max PV                0
  Cur PV                1
  Act PV                1
  VG Size               7.51 GiB
  PE Size               4.00 MiB
  Total PE              1922
  Alloc PE / Size       1922 / 7.51 GiB
  Free  PE / Size       0 / 0
  VG UUID               szQ4fH-Sr1Z-V6c2-KVMp-ZUik-oUDP-rU8dQS

<span class="o">[</span>root@centos ~]# vgextend vg_hadoop01 /dev/sdb
  Volume group <span class="s2">"vg_hadoop01"</span> successfully extended
<span class="o">[</span>root@centos ~]# vgdisplay
  <span class="nt">---</span> Volume group <span class="nt">---</span>
  VG Name               vg_hadoop01
  System ID
  Format                lvm2
  Metadata Areas        2
  Metadata Sequence No  4
  VG Access             <span class="nb">read</span>/write
  VG Status             resizable
  MAX LV                0
  Cur LV                2
  Open LV               2
  Max PV                0
  Cur PV                2
  Act PV                2
  VG Size               19.50 GiB
  PE Size               4.00 MiB
  Total PE              4993
  Alloc PE / Size       1922 / 7.51 GiB
  Free  PE / Size       3071 / 12.00 GiB
  VG UUID               szQ4fH-Sr1Z-V6c2-KVMp-ZUik-oUDP-rU8dQS
</code></pre></div></div>

<h4 id="查看lvdisplay根卷的名称将磁盘加入根卷的lv">查看<code>lvdisplay</code>根卷的名称，将磁盘加入根卷的LV</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@centos ~]# lvdisplay
  --- Logical volume ---
  LV Path                /dev/vg_hadoop01/lv_root
  LV Name                lv_root
  VG Name                vg_hadoop01
  LV UUID                tJDetu-Theq-BQ5g-3ZFe-Gan7-1SSv-OHeYrH
  LV Write Access        read/write
  LV Creation host, time hadoop01, 2017-04-18 07:09:58 +0800
  LV Status              available
  # open                 1
  LV Size                6.71 GiB
  Current LE             1718
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     256
  Block device           253:0

  --- Logical volume ---
  LV Path                /dev/vg_hadoop01/lv_swap
  LV Name                lv_swap
  VG Name                vg_hadoop01
  LV UUID                D4K7I6-tPO0-HMbC-VWkR-2HV4-WjAe-M82wYq
  LV Write Access        read/write
  LV Creation host, time hadoop01, 2017-04-18 07:09:59 +0800
  LV Status              available
  # open                 1
  LV Size                816.00 MiB
  Current LE             204
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     256
  Block device           253:1

[root@centos ~]# lvextend -l +100%FREE /dev/vg_hadoop01/lv_root
  Size of logical volume vg_hadoop01/lv_root changed from 6.71 GiB (1718 extents) to 18.71 GiB (4789 extents).
  Logical volume lv_root successfully resized.
[root@centos ~]# lvdisplay
  --- Logical volume ---
  LV Path                /dev/vg_hadoop01/lv_root
  LV Name                lv_root
  VG Name                vg_hadoop01
  LV UUID                tJDetu-Theq-BQ5g-3ZFe-Gan7-1SSv-OHeYrH
  LV Write Access        read/write
  LV Creation host, time hadoop01, 2017-04-18 07:09:58 +0800
  LV Status              available
  # open                 1
  LV Size                18.71 GiB
  Current LE             4789
  Segments               2
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     256
  Block device           253:0

  --- Logical volume ---
  LV Path                /dev/vg_hadoop01/lv_swap
  LV Name                lv_swap
  VG Name                vg_hadoop01
  LV UUID                D4K7I6-tPO0-HMbC-VWkR-2HV4-WjAe-M82wYq
  LV Write Access        read/write
  LV Creation host, time hadoop01, 2017-04-18 07:09:59 +0800
  LV Status              available
  # open                 1
  LV Size                816.00 MiB
  Current LE             204
  Segments               1
  Allocation             inherit
  Read ahead sectors     auto
  - currently set to     256
  Block device           253:1
</code></pre></div></div>

<h3 id="更新磁盘分区表">更新磁盘分区表</h3>

<p>当你增加完成之后，这时使用<code>df -h</code>查看的磁盘空间仍然没有变化，因为我们还需要将根卷的分区表刷新。</p>

<h4 id="使用resize2fs刷新根卷信息">使用<code>resize2fs</code>刷新根卷信息</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@centos ~]# resize2fs /dev/vg_hadoop01/lv_root
resize2fs 1.41.12 (17-May-2010)
Filesystem at /dev/vg_hadoop01/lv_root is mounted on /; on-line resizing required
old desc_blocks = 1, new_desc_blocks = 2
Performing an on-line resize of /dev/vg_hadoop01/lv_root to 4903936 (4k) blocks.
The filesystem on /dev/vg_hadoop01/lv_root is now 4903936 blocks long.

[root@centos ~]# df -h
Filesystem            Size  Used Avail Use% Mounted on
/dev/mapper/vg_hadoop01-lv_root
                       19G  5.8G   12G  33% /
tmpfs                 244M     0  244M   0% /dev/shm
/dev/sda1             477M   52M  400M  12% /boot
</code></pre></div></div>

      
    </div>
    <br/>
    <div>
      <cite>2017-04-18</cite> <i class="icon-tag"></i>
      <a href="/tags.html#LVM">LVM</a>
      
      
      
    </div>
    <div style="clear: both;"></div>
    <hr/>
    
    
    <h1><a class="title" href="/post/2017/04/HowTo-Install-GitLab.html">HowTo Install GitLab</a></h1>
    <div class="post_at_index">
      <p>目前最为主流的在线Git版本控制系统可以说是非GitHub莫属，对于个人开发者和开源项目可以直接选择GitHub作为Git版本控制系统即可，但是，对于企业内部开发管理的Git版本控制系统，在对保密性有高要求时GitHub就不合适了，这时GitLab作为一个可以完全搭建在企业内部的Git版本控制系统，而且基本囊括了GitHub的所有功能。</p>

<h4 id="目前gitlab已经整合的功能">目前GitLab已经整合的功能</h4>

<ol>
  <li>Repository access</li>
  <li>Administration</li>
  <li>Issues</li>
  <li>Forks</li>
  <li>Code review</li>
  <li>Wiki</li>
  <li>Merge Requests</li>
  <li>Web Editor</li>
</ol>

<h4 id="测试环境">测试环境</h4>

<ul>
  <li>2 core 4GB</li>
  <li>50GB HDD</li>
  <li>CentOS 6.8</li>
  <li>Gitlab</li>
</ul>

<h4 id="安装需求">安装需求</h4>

<p>关于GitLab的安装需求，主要是针对用户量然后评估出服务器及相关资源的配置，<a href="https://docs.gitlab.com.cn/ce/install/requirements.html">查看</a></p>

<h3 id="gitlab-安装"><strong>GitLab 安装</strong></h3>

<h4 id="安装配置依赖项">安装配置依赖项</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo yum install curl openssh-server openssh-clients postfix cronie
sudo service postfix start
sudo chkconfig postfix on
sudo lokkit -s http -s ssh
</code></pre></div></div>

<h4 id="添加gitlab仓库并安装到服务器上">添加GitLab仓库,并安装到服务器上</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -sS http://packages.gitlab.cc/install/gitlab-ce/script.rpm.sh | sudo bash
sudo yum install gitlab-ce
</code></pre></div></div>

<h4 id="启动gitlab并初始化">启动GitLab并初始化</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo gitlab-ctl reconfigure
</code></pre></div></div>

<p>默认登录账号是：<strong>root</strong> ，你可以在首次打开时设置密码。</p>

<h3 id="gitlab-初始化"><strong>GitLab 初始化</strong></h3>

<h4 id="开机自启动">开机自启动</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> vi /etc/rc.local
 /opt/gitlab/bin/gitlab-ctl start
</code></pre></div></div>

<h4 id="gitlab-配置文件">GitLab 配置文件</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/etc/gitlab/gitlab.rb
</code></pre></div></div>

<h4 id="smtp-邮箱配置">SMTP 邮箱配置</h4>

<p>如果想使用SMTP代替sendmail来发送邮件，应该在gitlab.rb中启用对应的配置，然后运行<code class="language-plaintext highlighter-rouge">gitlab-ctl reconfigure</code>使修改生效。</p>

<h5 id="qq企业邮箱配置示例">QQ企业邮箱配置示例</h5>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gitlab_rails['smtp_enable'] = true
gitlab_rails['smtp_address'] = "smtp.exmail.qq.com"
gitlab_rails['smtp_port'] = 465
gitlab_rails['smtp_user_name'] = "xxxx@xx.com"
gitlab_rails['smtp_password'] = "password"
gitlab_rails['smtp_authentication'] = "login"
gitlab_rails['smtp_enable_starttls_auto'] = true
gitlab_rails['smtp_tls'] = true
gitlab_rails['gitlab_email_from'] = 'xxxx@xx.com'
</code></pre></div></div>

<h5 id="gmail邮箱配置示例">Gmail邮箱配置示例</h5>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gitlab_rails['smtp_enable'] = true
gitlab_rails['smtp_address'] = "smtp.gmail.com"
gitlab_rails['smtp_port'] = 587
gitlab_rails['smtp_user_name'] = "my.email@gmail.com"
gitlab_rails['smtp_password'] = "my-gmail-password"
gitlab_rails['smtp_domain'] = "smtp.gmail.com"
gitlab_rails['smtp_authentication'] = "login"
gitlab_rails['smtp_enable_starttls_auto'] = true
gitlab_rails['smtp_tls'] = false
gitlab_rails['smtp_openssl_verify_mode'] = 'peer'
</code></pre></div></div>

<h5 id="outlook邮箱配置示例">Outlook邮箱配置示例</h5>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gitlab_rails['smtp_enable'] = true
gitlab_rails['smtp_address'] = "smtp-mail.outlook.com"
gitlab_rails['smtp_port'] = 587
gitlab_rails['smtp_user_name'] = "username@outlook.com"
gitlab_rails['smtp_password'] = "password"
gitlab_rails['smtp_domain'] = "smtp-mail.outlook.com"
gitlab_rails['smtp_authentication'] = "login"
gitlab_rails['smtp_enable_starttls_auto'] = true
gitlab_rails['smtp_openssl_verify_mode'] = 'peer'
</code></pre></div></div>

<blockquote>
  <p>​:warning: ‘smtp_password’字段不应包含任何 Ruby或者YAML语法中的分隔符 (如<code class="language-plaintext highlighter-rouge">'</code>),以避免处理配置文件的过程中发生不必要的意外。</p>
</blockquote>

<h4 id="gitlab-日常维护">GitLab 日常维护</h4>

<h5 id="1-查看服务状态">1. 查看服务状态</h5>

<p>使用 gitlab-ctl status 查看服务状态</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@6 ~]# sudo gitlab-ctl status
run: gitaly: (pid 15055) 23089s; run: log: (pid 3142) 55379s
run: gitlab-monitor: (pid 15060) 23088s; run: log: (pid 3325) 55357s
run: gitlab-workhorse: (pid 15063) 23088s; run: log: (pid 3156) 55377s
run: logrotate: (pid 17867) 1487s; run: log: (pid 3197) 55369s
run: nginx: (pid 15077) 23087s; run: log: (pid 3169) 55375s
run: node-exporter: (pid 15083) 23087s; run: log: (pid 3247) 55366s
run: postgres-exporter: (pid 15088) 23086s; run: log: (pid 3311) 55358s
run: postgresql: (pid 15093) 23086s; run: log: (pid 2988) 55412s
run: prometheus: (pid 15101) 23085s; run: log: (pid 3230) 55368s
run: redis: (pid 15109) 23085s; run: log: (pid 2931) 55419s
run: redis-exporter: (pid 15113) 23085s; run: log: (pid 3290) 55364s
run: sidekiq: (pid 17029) 22450s; run: log: (pid 3131) 55380s
run: unicorn: (pid 17001) 22460s; run: log: (pid 3100) 55386s
</code></pre></div></div>

<h5 id="2-启动关闭重启">2. 启动、关闭、重启</h5>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 启动Gitlab所有组件
sudo gitlab-ctl start

# 停止Gitlab所有组件
sudo gitlab-ctl stop

# 重启Gitlab所有组件
sudo gitlab-ctl restart

# 重启单个组件
sudo gitlab-ctl restart sidekiq
</code></pre></div></div>

<h5 id="3-控制台实时查看日志">3. 控制台实时查看日志</h5>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 查看所有的logs; 按 Ctrl-C 退出
sudo gitlab-ctl tail

# 拉取/var/log/gitlab下子目录的日志
sudo gitlab-ctl tail gitlab-rails

# 拉取某个指定的日志文件
sudo gitlab-ctl tail nginx/gitlab_error.log
</code></pre></div></div>

<h3 id="gitlab-安装后优化"><strong>GitLab 安装后优化</strong></h3>

<h4 id="启用https">启用HTTPS</h4>

<p>首先，你需要提供一个有可信任CA证书，默认情况下GitLab是没有启用HTTPS的，如果要启用HTTPS时，首先要修改<code>/etc/gitlab/gitlab.rb</code>中的<code>external_url</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 修改为https
external_url "https://git.ultraera.org"

# 设置默认将http重定向到https
nginx['redirect_http_to_https'] = true
</code></pre></div></div>

<p>如果你暂时没有https证书，那么你可以临时自己颁发一个证书，注意这个证书是不受信任的。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir -p /etc/nginx/ssl/
cd /etc/nginx/ssl/
sudo openssl req -newkey rsa:2048 -x509 -nodes -days 3560 -out gitlab.crt -keyout gitlab.key
sudo chmod o-r gitlab.key
sudo mv gitlab.key gitlab.crt /etc/ssl/
</code></pre></div></div>

<p>另外，还需要在gitlab-shell中的config.yml中将self_signed_cert 修改为启用:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>self_signed_cert = true
</code></pre></div></div>

<h4 id="设置延迟启动">设置延迟启动</h4>

<p>为保证服务质量，我们可以设置让omnibus-gitlab的服务(Nginx, Redis, Unicorn等) 在指定的文件系统挂载成功后再启动，在<code>/etc/gitlab/gitlab.rb</code> 文件中添加如下内容：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 等待/var/opt/gitlab 先被挂载
high_availability['mountpoint'] = '/var/opt/gitlab'
</code></pre></div></div>

<blockquote>
  <p>注意在修改配置之后，要使用重新reconfigure配置</p>
</blockquote>

<h4 id="backups-备份还原">Backups 备份还原</h4>

<h5 id="备份">备份</h5>

<p>Gitlab的配置也非常简单,使用一条命令即可创建完整的Gitlab备份:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gitlab-rake gitlab:backup:create
</code></pre></div></div>

<p>该命令会在<code class="language-plaintext highlighter-rouge">/var/opt/gitlab/backups</code>目录下创建一个名称类似为<code class="language-plaintext highlighter-rouge">1491989249_2017_04_12_gitlab_backup.tar</code>的压缩包, 这个压缩包就是Gitlab整个的完整部分，其中开头的<code class="language-plaintext highlighter-rouge">1491989249_2017_04_12</code>是备份创建的日期，这也是我们等下恢复是要用的字段。</p>

<h5 id="修改默认备份路径">修改默认备份路径</h5>

<p>如果你像我一样，是使用yum安装的，那么GitLab默认的备份目录应该在<code class="language-plaintext highlighter-rouge">/var/opt/gitlab/backups</code>，我建议将备份目录修改为其他位置，并添加定时自动备份脚本，可以通过修改<code class="language-plaintext highlighter-rouge">/etc/gitlab/gitlab.rb</code>来修改默认位置：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gitlab_rails['backup_path'] = '/mnt/backups'
</code></pre></div></div>

<h5 id="使用crontab-添加自动备份">使用crontab 添加自动备份</h5>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 每天凌晨00:00 自动备份
00 00 * * * /opt/gitlab/bin/gitlab-rake gitlab:backup:create
</code></pre></div></div>

<h5 id="备份恢复">备份恢复</h5>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 停止相关数据连接服务
gitlab-ctl stop unicorn
gitlab-ctl stop sidekiq

# 从1491989249_2017_04_12编号备份中恢复
gitlab-rake gitlab:backup:restore BACKUP=1491989249_2017_04_12

# 启动Gitlab
sudo gitlab-ctl start unicorn
sudo gitlab-ctl start sidekiq
</code></pre></div></div>

<h3 id="gitlab-迁移"><strong>GitLab 迁移</strong></h3>

<p>只需将原服务器<code class="language-plaintext highlighter-rouge">/var/opt/gitlab/backups</code>目录下的备份文件拷贝到新服务器上的<code class="language-plaintext highlighter-rouge">/var/opt/gitlab/backups</code>上即可(如果你没修改过默认备份目录的话)， 但是需要注意的是新服务器上的Gitlab的版本必须与创建备份时的Gitlab版本号相同， 比如新服务器安装的是最新的9.0.5版本的Gitlab, 那么迁移之前，最好将老服务器的Gitlab 升级为9.0.5在进行备份。</p>

<p>/Users/Alex/Documents/Hexo/source/_posts/</p>

      
    </div>
    <br/>
    <div>
      <cite>2017-04-13</cite> <i class="icon-tag"></i>
      <a href="/tags.html#Gitlab">Gitlab</a>
      
      
      
    </div>
    <div style="clear: both;"></div>
    <hr/>
    
    
    <h1><a class="title" href="/post/2017/04/%E5%85%B3%E4%BA%8E%E8%80%83%E8%AF%95.html">关于考试</a></h1>
    <div class="post_at_index">
      <blockquote>
  <p>时光飞逝，那大概是世界上最糟糕的一种感觉了吧。</p>
</blockquote>

<p>有点记不大清楚，上一次为了考试是什么时间了。</p>

<p>我说的考试不是各种面试等无形的考试，而是，你坐在四四方方的台子前，给你纸笔，限定时间，那种紧张的感觉，那种备考的心态。</p>

<p>所以时光会消磨人的斗志，让你不大能聚精会神的准备考试，让你变得懒散，让你变得不再有血性；所以，时间这种东西，不仅会在你的身上刻下斑驳印记，还会磨去你内心的棱角，一旦这样，你就会停下了脚步，大家的生活成了日复一日的重复，日子也过得索然无味，好像很多很多你想做的事，最后都是选择plan B。</p>

<p>促使我写这篇的动力来自于，最近AWS助理级系统架构师的考试，而就在年前的时候，第一次去参加考试，没有通过，而且我一直在想到底是哪里出了问题，尽管我不愿意承认，问题根本是，我根本没有静下心来去准备考试，其实是，现在真的很难去静下心来去做考试这种事情，心气浮躁，要做的事情很多堆积在面前，你可能会被这些事情唬到，所以你很焦虑，光顾着去焦虑了，却没想着去解决这些问题，所以难道你的不是这些看起来很困难的问题，而是，你丧失了解决这些问题的勇气很血性；一方面反映在这里，另一方面也反映在你生活的各个方面，你好像没有动力去处理这些事情，总是在最后关头，勉勉强强叫上一份拼拼凑凑的答卷，这不会是你想要的样子，这是一种病，拖延。</p>

<p><a href="https://www.youtube.com/watch?v=Q6ZgU7KyQsM">每個人的遺憾，都大抵相似</a></p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/Q6ZgU7KyQsM" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

<p>之前看到过的一个视频，讲述的是在New York的街头方一块黑板，让你写下最后悔的事，很多都是自己真正想要做的，却未曾努力去做的事，“最后总是选择plan B”，“未曾跳出自己的舒适圈”，人生总是带有遗憾，总是想象着自己会多么的闪耀，却没有勇气付出真心努力，对我是这样，学习，考试，减肥，很多自己想做的事，如果不能够鼓足勇气去做，人生过着便没有意义。</p>

<p>所以，很多事情，并非要你一定做到，而是，你是否真的努力去付出过，还是假意的敷衍，拖延妥协，这种感觉只有你自己真的知道，最后的遗憾，也只有自己知道，为什么要放手自己想要的。</p>

<p>不要怀疑，不要犹豫，努力去做自己想做的事，努力成为那个，你想要成为的人，永远怀揣着梦想，永远热泪盈眶。</p>

      
    </div>
    <br/>
    <div>
      <cite>2017-04-11</cite> <i class="icon-tag"></i>
      <a href="/tags.html#Zero">Zero</a>
      
      
      
    </div>
    <div style="clear: both;"></div>
    <hr/>
    
    
    <h1><a class="title" href="/post/2017/04/HowTo-set-Tomcat-7-automatic-startup-with-CentOS-7.html">HowTo set Tomcat 7 automatic startup with CentOS 7</a></h1>
    <div class="post_at_index">
      <p>因CentOS7与6在系统上，变化较大，所以在之前的文章中讲到的使用Tomcat7开机自启动的方式在CentOS7是是无法使用的，所以这篇文章的目的是如何在CentOS7上将Tomcat7设置为开机自启动。</p>

<h4 id="安装java环境">安装JAVA环境</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
[root@7 ~]# curl -LO -H "Cookie: oraclelicense=accept-securebackup-cookie" \
"http://download.oracle.com/otn-pub/java/jdk/7u75-b13/jdk-7u75-linux-x64.rpm"

[root@7 ~]# rpm -Uvh jdk-7u75-linux-x64.rpm
Preparing...                ########################################### [100%]
   1:jdk                    ########################################### [100%]
Unpacking JAR files...
        rt.jar...
        jsse.jar...
        charsets.jar...
        tools.jar...
        localedata.jar...
        jfxrt.jar...

[root@7 ~]# vi /etc/profile
# add follows to the end
export JAVA_HOME=/usr/java/default
export PATH=$PATH:$JAVA_HOME/bin
export CLASSPATH=.:$JAVA_HOME/jre/lib:$JAVA_HOME/lib:$JAVA_HOME/lib/tools.jar
[root@7 ~]# source /etc/profile
</code></pre></div></div>

<h4 id="安装tomcat7">安装Tomcat7</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
[root@7 ~]# wget http://ftp.riken.jp/net/apache/tomcat/tomcat-7/v7.0.77/bin/apache-tomcat-7.0.77.tar.gz
[root@7 ~]# tar zxvf apache-tomcat-7.0.77.tar.gz
[root@7 ~]# mv apache-tomcat-7.0.77 /usr/tomcat7
[root@7 ~]# useradd -M -d /usr/tomcat7 tomcat7
[root@7 ~]# chown -R tomcat7. /usr/tomcat7
</code></pre></div></div>

<h4 id="创建开机自启动脚本">创建开机自启动脚本</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@7 ~]# cat /usr/lib/systemd/system/tomcat7.service
# create new
 [Unit]
Description=Apache Tomcat 7
After=network.target

[Service]
Type=oneshot
ExecStart=/usr/tomcat7/bin/startup.sh
ExecStop=/usr/tomcat7/bin/shutdown.sh
RemainAfterExit=yes
User=tomcat7
Group=tomcat7

[Install]
WantedBy=multi-user.target
</code></pre></div></div>

<h4 id="启动tomcat7">启动Tomcat7</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@7 ~]# systemctl start tomcat7.service
[root@7 ~]# systemctl enable tomcat7.service
</code></pre></div></div>

      
    </div>
    <br/>
    <div>
      <cite>2017-04-05</cite> <i class="icon-tag"></i>
      <a href="/tags.html#Tomcat">Tomcat</a>
      , 
      <a href="/tags.html#CentOS">CentOS</a>
      
      
      
    </div>
    <div style="clear: both;"></div>
    <hr/>
    
    
    <h1><a class="title" href="/post/2017/03/%E5%9C%A8Linux%E7%BB%88%E7%AB%AF%E4%BD%BF%E7%94%A8SSR%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91.html">在Linux终端使用SSR服务实现科学上网</a></h1>
    <div class="post_at_index">
      <p>昨天在群内看到有朋友在询问如何在Linux终端内使用SSR来实现科学上网，所以抽空研究了下在Linux中如何使用，本文参考了<a href="https://www.zfl9.com/">Otokaze</a> 和 <a href="https://www.djangoz.com">Django</a> 两位的博客，文章链接在博文最后；SSR服务提供商依然采用了<a href="http://ssglobal.co/wp">ssGlobal</a>，在Google的过程中，找了不少解决方案，这里仅做一种简单整理，实验操作系统有CentOS 7.4 &amp; Ubuntu 16.04.3。</p>

<h4 id="ssr-代理服务">ssr 代理服务</h4>

<h5 id="下载">下载</h5>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 需要本地git 环境</span>
yum <span class="nb">install</span> <span class="nt">-y</span> git
git clone https://github.com/SAMZONG/gfwlist2privoxy.git
<span class="nb">cd </span>gfwlist2privoxy/
<span class="nb">mv </span>ssr /usr/local/bin
<span class="nb">chmod</span> +x /usr/local/bin/ssr
</code></pre></div></div>

<h5 id="安装配置">安装配置</h5>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@localhost ~]# ssr <span class="nb">install
</span>Cloning into <span class="s1">'/usr/local/share/shadowsocksr'</span>...
remote: Counting objects: 5490, <span class="k">done</span><span class="nb">.</span>
remote: Total 5490 <span class="o">(</span>delta 0<span class="o">)</span>, reused 0 <span class="o">(</span>delta 0<span class="o">)</span>, pack-reused 5490
Receiving objects: 100% <span class="o">(</span>5490/5490<span class="o">)</span>, 1.71 MiB | 410.00 KiB/s, <span class="k">done</span><span class="nb">.</span>
Resolving deltas: 100% <span class="o">(</span>3799/3799<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>

<span class="o">[</span>root@localhost ~]# ssr config 		<span class="c"># 配置文件路径 /usr/local/share/shadowsocksr/config.json</span>
<span class="o">{</span>
    <span class="s2">"server"</span>: <span class="s2">"0..0.0.0"</span>,	// ssr服务器ip
    <span class="s2">"server_ipv6"</span>: <span class="s2">"::"</span>,
    <span class="s2">"server_port"</span>: 8080,	// ssr服务器端口
    <span class="s2">"local_address"</span>: <span class="s2">"127.0.0.1"</span>,
    <span class="s2">"local_port"</span>: 1080,

    <span class="s2">"password"</span>: <span class="s2">"123456"</span>,		// 对应password
    <span class="s2">"method"</span>: <span class="s2">"none"</span>,			// 这里对应SSGlobal配置中的Encryption
    <span class="s2">"protocol"</span>: <span class="s2">"auth_chain_a"</span>,		//对应protocl
    <span class="s2">"protocol_param"</span>: <span class="s2">""</span>,
    <span class="s2">"obfs"</span>: <span class="s2">"http_simple"</span>,		//对应obfs
    <span class="s2">"obfs_param"</span>: <span class="s2">"hello.world"</span>,	//对应obfs_param
    <span class="s2">"speed_limit_per_con"</span>: 0,
    <span class="s2">"speed_limit_per_user"</span>: 0,

    <span class="s2">"additional_ports"</span> : <span class="o">{}</span>, // only works under multi-user mode
    <span class="s2">"additional_ports_only"</span> : <span class="nb">false</span>, // only works under multi-user mode
    <span class="s2">"timeout"</span>: 120,
    <span class="s2">"udp_timeout"</span>: 60,
    <span class="s2">"dns_ipv6"</span>: <span class="nb">false</span>,
    <span class="s2">"connect_verbose_info"</span>: 0,
    <span class="s2">"redirect"</span>: <span class="s2">""</span>,
    <span class="s2">"fast_open"</span>: <span class="nb">false</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="启动关闭">启动/关闭</h5>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssr start
ssr stop 
</code></pre></div></div>

<h5 id="卸载">卸载</h5>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssr uninstall <span class="c"># 这里操作会删除/usr/local/share/shadowsocksr</span>
</code></pre></div></div>

<p>以上，本地监听服务已经配置完成了，在填写的过程中，要注意你的本地监听地址和监听端口，默认是127.0.0.1:1080，如果你修改了设置，那么在后续配置中也要配合修改。</p>

<h4 id="privoxy-配置">Privoxy 配置</h4>

<p>首先，需要安装privoxy</p>

<h6 id="centos-74">CentOS 7.4</h6>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum <span class="nb">install</span> <span class="nt">-y</span> epel-release
yum <span class="nb">install</span> <span class="nt">-y</span> privoxy
</code></pre></div></div>

<h6 id="ubuntu-1604">Ubuntu 16.04</h6>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt <span class="nb">install</span> <span class="nt">-y</span> privoxy
</code></pre></div></div>

<h5 id="全局模式">全局模式</h5>

<p>代理模式同其他平台上方式，将所有http/https请求走代理服务，如果需要全局代理的话按照如下操作即可，如果要使用PAC模式，请跳过此部分。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 添加本地ssr服务到配置文件</span>
<span class="nb">echo</span> <span class="s1">'forward-socks5 / 127.0.0.1:1080 .'</span> <span class="o">&gt;&gt;</span> /etc/privoxy/config

<span class="c"># Privoxy 默认监听端口是是8118</span>
<span class="nb">export </span><span class="nv">http_proxy</span><span class="o">=</span>http://127.0.0.1:8118
<span class="nb">export </span><span class="nv">https_proxy</span><span class="o">=</span>http://127.0.0.1:8118
<span class="nb">export </span><span class="nv">no_proxy</span><span class="o">=</span>localhost

<span class="c"># 启动服务</span>
systemctl start privoxy.service
</code></pre></div></div>

<h5 id="pac模式">PAC模式</h5>

<p>使用GFWList是由AutoProxy官方维护，由众多网民收集整理的一个中国大陆防火长城的屏蔽列表，这里感谢<a href="https://www.zfl9.com/">@Otokaze</a> 为我们提供了转换shell自动转换脚本，为了方便修改，我fork了这个项目，将这篇教程所用到的资源进行了汇总，你可以在最开始<code class="language-plaintext highlighter-rouge">git clone</code>的目录中找到执行脚本。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@localhost ~]# <span class="nb">cd </span>gfwlist2privoxy/
<span class="o">[</span>root@localhost gfwlist2privoxy]# <span class="nb">ls
</span>gfw.action  gfwlist2privoxy  README.md  ssr
<span class="o">[</span>root@localhost gfwlist2privoxy]# bash gfwlist2privoxy
proxy<span class="o">(</span>socks5<span class="o">)</span>: 127.0.0.1:1080		<span class="c"># 注意，如果你修改了ssr本地监听端口是需要设置对应的</span>
<span class="o">{</span>+forward-override<span class="o">{</span>forward-socks5 127.0.0.1:1080 .<span class="o">}}</span>

<span class="o">=================================================================</span>

<span class="s2">"cp -af /root/gfwlist2privoxy/gfw.action /etc/privoxy/"</span>

<span class="o">[</span>root@localhost ~]# <span class="nb">cp</span> <span class="nt">-af</span> gfw.action /etc/privoxy/
<span class="o">[</span>root@localhost ~]# <span class="nb">echo</span> <span class="s1">'actionsfile gfw.action'</span> <span class="o">&gt;&gt;</span> /etc/privoxy/config

<span class="c"># Privoxy 默认监听端口是是8118</span>
<span class="nb">export </span><span class="nv">http_proxy</span><span class="o">=</span>http://127.0.0.1:8118
<span class="nb">export </span><span class="nv">https_proxy</span><span class="o">=</span>http://127.0.0.1:8118
<span class="nb">export </span><span class="nv">no_proxy</span><span class="o">=</span>localhost

<span class="c"># 启动服务</span>
systemctl start privoxy.service
</code></pre></div></div>

<h5 id="proxy-环境变量">proxy 环境变量</h5>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># privoxy默认监听端口为8118</span>
<span class="nb">export </span><span class="nv">http_proxy</span><span class="o">=</span>http://127.0.0.1:8118
<span class="nb">export </span><span class="nv">https_proxy</span><span class="o">=</span>http://127.0.0.1:8118
<span class="nb">export </span><span class="nv">no_proxy</span><span class="o">=</span>localhost

<span class="c"># no_proxy是不经过privoxy代理的地址</span>
<span class="c"># 只能填写具体的ip、域名后缀，多个条目之间使用','逗号隔开</span>
<span class="c"># 比如: export no_proxy="localhost, 192.168.1.1, ip.cn, chinaz.com"</span>
<span class="c"># 访问 localhost、192.168.1.1、ip.cn、*.ip.cn、chinaz.com、*.chinaz.com 将不使用代理</span>
</code></pre></div></div>

<h4 id="代理测试">代理测试</h4>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 访问各大网站，如果都有网页源码输出说明代理没问题</span>
curl <span class="nt">-sL</span> www.baidu.com
curl <span class="nt">-sL</span> www.google.com
curl <span class="nt">-sL</span> www.google.com.hk
curl <span class="nt">-sL</span> www.google.co.jp
curl <span class="nt">-sL</span> www.youtube.com
curl <span class="nt">-sL</span> mail.google.com
curl <span class="nt">-sL</span> facebook.com
curl <span class="nt">-sL</span> twitter.com
curl <span class="nt">-sL</span> www.wikipedia.org

<span class="c"># 获取当前 IP 地址</span>
<span class="c"># 如果使用 privoxy 全局模式，则应该显示 ss 服务器的 IP</span>
<span class="c"># 如果使用 privoxy gfwlist模式，则应该显示本地公网 IP</span>
curl <span class="nt">-sL</span> ip.chinaz.com/getip.aspx
</code></pre></div></div>

<h5 id="管理脚本">管理脚本</h5>

<p>在以上部署操作完成后，应该已经可以正常科学上网了，但是如果需要进行管理时，需要分别管理ssr和privoxy，为了方便管理，这里写了一个shell脚本方便管理: ssr_manager</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c"># Author Samzong.lu</span>

<span class="k">case</span> <span class="nv">$1</span> <span class="k">in
	</span>start<span class="p">)</span>
		ssr start &amp;&gt; /var/log/ssr-local.log
		systemctl start privoxy.service
		<span class="nb">export </span><span class="nv">http_proxy</span><span class="o">=</span>http://127.0.0.1:8118
		<span class="nb">export </span><span class="nv">https_proxy</span><span class="o">=</span>http://127.0.0.1:8118
		<span class="nb">export </span><span class="nv">no_proxy</span><span class="o">=</span><span class="s2">"localhost, ip.cn, chinaz.com"</span>
		<span class="p">;;</span>
	stop<span class="p">)</span>
		<span class="nb">unset </span>http_proxy https_proxy no_proxy
		systemctl stop privoxy.service
		ssr stop &amp;&gt; /var/log/ssr-log.log
		<span class="p">;;</span>
	autostart<span class="p">)</span>
		<span class="nb">echo</span> <span class="s2">"ssr start"</span> <span class="o">&gt;&gt;</span> /etc/rc.local
		systemctl <span class="nb">enable </span>privoxy.service
		<span class="nb">echo</span> <span class="s2">"http_proxy=http://127.0.0.1:8118"</span> <span class="o">&gt;&gt;</span> /etc/bashrc
		<span class="nb">echo</span> <span class="s2">"https_proxy=http://127.0.0.1:8118"</span> <span class="o">&gt;&gt;</span> /etc/bashrc
		<span class="nb">echo</span> <span class="s2">"no_proxy='localhost, ip.cn, chinaz.com'"</span> <span class="o">&gt;&gt;</span> /etc/bashrc
		<span class="p">;;</span>
	<span class="k">*</span><span class="p">)</span>
		<span class="nb">echo</span> <span class="s2">"usage: source </span><span class="nv">$0</span><span class="s2"> start|stop|autostart"</span>
		<span class="nb">exit </span>1
		<span class="p">;;</span>
<span class="k">esac</span>
</code></pre></div></div>

<h5 id="使用">使用</h5>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mv </span>gfwlist2privoxy/ssr_manager /usr/local/bin
<span class="nb">chmod</span> +x ssr_manager

<span class="c"># 启动服务</span>
ssr_manager start

<span class="c"># 关闭服务</span>
ssr_manager stop 

<span class="c"># 添加开机自启动</span>
ssr_manager autostart
</code></pre></div></div>

<h4 id="参考链接">参考链接</h4>

<ul>
  <li>https://www.zfl9.com/ss-local.html</li>
  <li>https://www.djangoz.com/2017/08/16/linux_setup_ssr/</li>
</ul>


      
    </div>
    <br/>
    <div>
      <cite>2017-03-23</cite> <i class="icon-tag"></i>
      <a href="/tags.html#VPN">VPN</a>
      
      
      
    </div>
    <div style="clear: both;"></div>
    <hr/>
    
    
    <h1><a class="title" href="/post/2017/03/HowTo-install-Zoomdata.html">HowTo install Zoomdata</a></h1>
    <div class="post_at_index">
      <p>Zoomdata是一个大数据可视化展示的工具，由ZoomData企业创建，是为数不多的同时支持移动端的数据分析公司，Zoomdata的可视化可将大数据流转化为触屏友好的，艺术感十足的三维形态，Zoomdata的定位是非ETL(传统的提取、转换和加载的数据处理过程)工具，Zoomdata支持多种数据源，包括社交媒体等，其中应用最主流是大数据平台的展示工具，并且Zoomdata对Cloudera Impala做了很好的支持，所以我们做了Zoomdata+Cloudera技术实施。[^1]</p>

<h4 id="系统要求"><strong>系统要求</strong></h4>
<p>Zoomdata最新版是v2.4，支持常见主流的操作系统，并且有非常友好的安装帮助，但是Zoomdata不支持安装在32位的操作系统之上
<br />
|biaoti|biaoti|baiiti|
|——|——|——|
|list|file|china|
|letian|zhong|hongkong|</p>

<p><br />
[^1]: 这是一个示意的文档</p>

      
    </div>
    <br/>
    <div>
      <cite>2017-03-06</cite> <i class="icon-tag"></i>
      <a href="/tags.html#Zoomdata">Zoomdata</a>
      
      
      
    </div>
    <div style="clear: both;"></div>
    <hr/>
    
    
    <h1><a class="title" href="/post/2017/03/%E5%9B%9B%E9%98%B6%E9%AD%94%E6%96%B9%E7%89%B9%E6%AE%8A%E6%83%85%E5%86%B5%E4%B9%8B%E5%A4%84%E7%90%86.html">四阶魔方特殊情况之处理</a></h1>
    <div class="post_at_index">
      <p>在还原高阶魔方(四阶及以上)时，采用的处理方法是，将魔方降级为三阶魔方，然后按照三阶魔方的技巧进行还原即可，但是在还原四阶魔方时会遇到2个不可能出现在三阶魔方的特殊情况，下面是针对这两个特殊情况的公式。</p>

<blockquote>
  <p>注意，本文不是四阶魔方的还原教程。</p>
</blockquote>

<h4 id="特殊情况顶层黄色无法形成十或l">特殊情况：顶层黄色无法形成“十”或“L”</h4>

<p>1.手势：黄色面朝上
2.右边两层旋转180’（这时应该黄色面有右面两层为白色）
3.后面一层旋转180’
4.上面一层旋转180’
5.左边两层靠近你身体旋转90’
6.上面一层旋转180’
7.右面两层靠近你身体旋转90’
8.上面一层旋转180’
9.右面两层远离你身体旋转90’
10.上面一层旋转180’
11.前面一层旋转180’
12.右面两层远离你身体旋转90’
13.前面一层旋转180’
14.左边两层远离你身体旋转90’
15.后面一层旋转180’
16.右边两层旋转180’</p>

<h4 id="特殊情况最后四对棱角只有两对还原">特殊情况：最后四对棱角只有两对还原</h4>

<p>1.黄色面已经还原的情况下，黄色面朝上
2.右面夹层旋转180’
3.上面一层旋转180‘
4.右面夹层旋转180’
5.上面两层旋转180’
6.右面夹层旋转180’
7.上面两层旋转180’</p>

      
    </div>
    <br/>
    <div>
      <cite>2017-03-04</cite> <i class="icon-tag"></i>
      <a href="/tags.html#随笔">随笔</a>
      
      
      
    </div>
    <div style="clear: both;"></div>
    <hr/>
    
    
    <h1><a class="title" href="/post/2017/02/MacTips-%E4%BD%BF%E7%94%A8%E5%91%BD%E4%BB%A4%E5%85%B3%E9%97%AD%E5%92%8C%E5%90%AF%E5%8A%A8AirPort.html">MacTips 使用命令关闭和启动AirPort</a></h1>
    <div class="post_at_index">
      <p>今天在给妹妹调试新的MacBookAir 13’时遇到一个问题，无法检测到她家的WiFi，一开始怀疑是不是无线路由器长时间未重启导致，所以重启了路由器，但是问题依然没有解决，于是我们将问题转向排查设备，因我们基本正好有iPad，iPhone，MacBook这些设备，发现唯独他的这个Macbook无法识别WiFi，后来在Google的帮助下，发现多个版本的Mac OS X都出现了类似的问题，可以通过重启AirPort解决问题，但是AirPort在System Preferences找不到选项，所以需要使用命令行来重启。</p>

<h5 id="查看网络接口"><strong>查看网络接口</strong></h5>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ifconfig
en0: flags=8863&lt;UP,BROADCAST,SMART,RUNNING,SIMPLEX,MULTICAST&gt; mtu 1500
	ether 60:f8:1d:ad:85:76
	inet6 fe80::18a9:fa23:b02f:5d8a%en0 prefixlen 64 secured scopeid 0x4
	inet 192.168.199.200 netmask 0xffffff00 broadcast 192.168.199.255
	nd6 options=201&lt;PERFORMNUD,DAD&gt;
	media: autoselect
	status: active
</code></pre></div></div>
<h5 id="关闭airport"><strong>关闭AirPort</strong></h5>
<p>有时候设备的名称是en0、en1这样，所以，可以用过设备名称来重启airport，例如en0</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>networksetup -setairportpower en0 off
</code></pre></div></div>

<h5 id="查看状态"><strong>查看状态</strong></h5>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>networksetup -getairportpower en0
</code></pre></div></div>

<h5 id="关闭airport-1"><strong>关闭AirPort</strong></h5>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>networksetup -setairportpower en0 on
</code></pre></div></div>

      
    </div>
    <br/>
    <div>
      <cite>2017-02-27</cite> <i class="icon-tag"></i>
      <a href="/tags.html#Mac">Mac</a>
      
      
      
    </div>
    <div style="clear: both;"></div>
    <hr/>
    
    
    <h1><a class="title" href="/post/2017/02/HowTo-Install-NextCloud.html">HowTo Install NextCloud</a></h1>
    <div class="post_at_index">
      <p>随着最近一个云盘厂家不再提供个人服务，或者开始各种收费限速，自己存放在第三方云盘厂商的数据被盗取，数据的安全性和数据的稳定性都得不到保证，而且随着智能终端的普及，我也有一些更加高质量的图片文件需要大量储存，所以我想到了自建存储服务的方式，在甄别了OwnCloud，Seafiles和NextCloud，最后选择了NextCloud作为自己今后数据存储节点，NextCloud源自OwnCloud，但是近些年来OwnCloud的发展进度几乎停滞，多数开发者也转战NextCloud，当然NextCloud也继承了搭建简单，依赖于PHP环境的特性。</p>

<h4 id="运行环境"><strong>运行环境</strong></h4>

<ul>
  <li>阿里云ECS CentOS 6.x</li>
  <li>免费SSL证书(腾讯云申请)</li>
</ul>

<h4 id="搭建lnmp环境"><strong>搭建LNMP环境</strong></h4>

<h5 id="软件版本">软件版本</h5>

<ul>
  <li>PHP 5.6.30   <a href="https://samzong.me/php54-centos6/">安装教程</a></li>
  <li>MySQL 5.6.35  <a href="https://samzong.me/how-to-install-mysql-5-6-on-centos/">安装教程</a></li>
  <li>Nginx 1.10.2</li>
</ul>

<h5 id="基础环境安装">基础环境安装</h5>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@ultraera ~]# yum update -y
[root@ultraera ~]# yum groupinstall -y "Base"
[root@ultraera ~]# yum groupinstall -y "Development tools"

# Install epel
[root@ultraera ~]# yum install -y epel-release

# Install remi
[root@ultraera ~]# yum install http://rpms.famillecollet.com/enterprise/remi-release-6.rpm

# Install mysql-community
[root@ultraera ~]# yum install http://repo.mysql.com/yum/mysql-5.6-community/el/6/x86_64/mysql-community-release-el6-7.noarch.rpm
</code></pre></div></div>

<h5 id="install-lnmp">Install LNMP</h5>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Install MySQL
[root@ultraera ~]# yum --enablerepo=mysql-community install -y mysql-server mysql-libs mysql-devel
[root@ultraera ~]# service mysqld start
[root@ultraera ~]# mysql_secure_installation
[root@ultraera ~]# chkconfig mysqld on

# Install Nginx
[root@ultraera ~]# yum --enablerepo=epel install -y nginx
[root@ultraera ~]# service nginx start
[root@ultraera ~]# chkconfig nginx on

# Install PHP and php-fpm
[root@ultraera ~]# yum --enablerepo=remi-php56 install php php-fpm php-mysql php-gd php-xml php-redis php-libs php-devel php-zlib
[root@ultraera ~]# service php-fpm start
[root@ultraera ~]# chkconfig php-fpm on
[root@ultraera ~]# service nginx restart
</code></pre></div></div>

<h5 id="下载nextcloud">下载NextCloud</h5>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@ultraera ~]# wget https://download.nextcloud.com/server/releases/nextcloud-11.0.1.tar.bz2
[root@ultraera ~]# tar xf nextcloud-11.0.1.tar.bz2
[root@ultraera ~]# mv nextcloud-11.0.1 /opt/nextcloud
</code></pre></div></div>

<h5 id="配置nginx和php-fpm">配置Nginx和php-fpm</h5>

<p>因为php-fpm默认运行的用户身份是apache，我们这里使用的环境是nginx，所有要修改php-fpm配置文件的用户和组，注意不要为了省事直接改为root，这在php-fpm中是不允许的</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@ultraera ~]# vim /etc/php-fpm.d/www.conf
user=nginx
group=nginx
[root@ultraera ~]# service php-fpm restart
</code></pre></div></div>

<p>因为NextCloud默认是以Apache的身份运行的，所以我们需要单独配置NextCloud的Nginx配置文件，以下配置文件，你可以直接拿去用，注意在文件中说明了，需要修改的地方：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@ultraera ~]# vim /etc/nginx/conf.d/nextcloud.conf
 upstream php-handler {
  	# 这里是你php-fpm的服务端口，默认是9000
    server 127.0.0.1:9000;
    #server unix:/var/run/php5-fpm.sock;
}

server {
  	# 你的域名
    listen pan.ultraera.org:80;
    server_name pan.ultraera.org;
    # enforce https
    return 301 https://$server_name$request_uri;
}

server {
    # 你的域名
    listen pan.ultraera.org:443 ssl;
    server_name pan.ultraera.org;

  	# 以下是你的ssl证书文件存放路径
    ssl_certificate /etc/nginx/ssl/1_pan.ultraera.org_bundle.crt;
    ssl_certificate_key /etc/nginx/ssl/2_pan.ultraera.org.key;

    # Add headers to serve security related headers
    # Before enabling Strict-Transport-Security headers please read into this
    # topic first.
    # add_header Strict-Transport-Security "max-age=15768000;
    # includeSubDomains; preload;";
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Robots-Tag none;
    add_header X-Download-Options noopen;
    add_header X-Permitted-Cross-Domain-Policies none;
	add_header Strict-Transport-Security "max-age=15552000; includeSubdomains; ";

    # 设定你的NextCloud的根目录，请根据实际修改
    root /opt/nextcloud/;

    location = /robots.txt {
        allow all;
        log_not_found off;
        access_log off;
    }

    # The following 2 rules are only needed for the user_webfinger app.
    # Uncomment it if you're planning to use this app.
    #rewrite ^/.well-known/host-meta /public.php?service=host-meta last;
    #rewrite ^/.well-known/host-meta.json /public.php?service=host-meta-json
    # last;

    location = /.well-known/carddav {
      return 301 $scheme://$host/remote.php/dav;
    }
    location = /.well-known/caldav {
      return 301 $scheme://$host/remote.php/dav;
    }

    # set max upload size
    client_max_body_size 512M;
    fastcgi_buffers 64 4K;

    # Disable gzip to avoid the removal of the ETag header
    gzip off;

    # Uncomment if your server is build with the ngx_pagespeed module
    # This module is currently not supported.
    #pagespeed off;

    error_page 403 /core/templates/403.php;
    error_page 404 /core/templates/404.php;

    location / {
        rewrite ^ /index.php$uri;
   }

    location ~ ^/(?:build|tests|config|lib|3rdparty|templates|data)/ {
        deny all;
    }
    location ~ ^/(?:\.|autotest|occ|issue|indie|db_|console) {
        deny all;
    }

    location ~ ^/(?:index|remote|public|cron|core/ajax/update|status|ocs/v[12]|updater/.+|ocs-provider/.+|core/templates/40[34])\.php(?:$|/) {
        include fastcgi_params;
        fastcgi_split_path_info ^(.+\.php)(/.*)$;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param HTTPS on;
        #Avoid sending the security headers twice
        fastcgi_param modHeadersAvailable true;
        fastcgi_param front_controller_active true;
        fastcgi_pass php-handler;
        fastcgi_intercept_errors on;
        fastcgi_request_buffering off;
    }

    location ~ ^/(?:updater|ocs-provider)(?:$|/) {
        try_files $uri/ =404;
        index index.php;
    }

    # Adding the cache control header for js and css files
    # Make sure it is BELOW the PHP block
    location ~* \.(?:css|js|woff|svg|gif)$ {
        try_files $uri /index.php$uri$is_args$args;
        add_header Cache-Control "public, max-age=7200";
        # Add headers to serve security related headers (It is intended to
        # have those duplicated to the ones above)
        # Before enabling Strict-Transport-Security headers please read into
        # this topic first.
        # add_header Strict-Transport-Security "max-age=15768000;
        #  includeSubDomains; preload;";
        add_header X-Content-Type-Options nosniff;
        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-XSS-Protection "1; mode=block";
        add_header X-Robots-Tag none;
        add_header X-Download-Options noopen;
        add_header X-Permitted-Cross-Domain-Policies none;
        # Optional: Don't log access to assets
        access_log off;
    }

    location ~* \.(?:png|html|ttf|ico|jpg|jpeg)$ {
        try_files $uri /index.php$uri$is_args$args;
        # Optional: Don't log access to other assets
        access_log off;
    }
}
[root@ultraera ~]# service nginx restart
</code></pre></div></div>

<h5 id="文件权限调整">文件权限调整</h5>

<p>因为NextCloud运行是以nginx程序，注意修改目录所属用户和组为nginx</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@ultraera ~]# chown -R nginx:nginx /opt/nextcloud
</code></pre></div></div>

<h5 id="创建mysql数据库">创建MySQL数据库</h5>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; CREATE DATABASE nextcloud CHARACTER SET UTF-8;
mysql&gt; GRANT ALL PRIVILEGES ON nextcloud.* TO 'nextcloud'@'localhost' IDENTIFIED BY 'your_password';
mysql&gt; FLUSH PRIVILEGES;
</code></pre></div></div>

<h4 id="初始化nextcloud">初始化NextCloud</h4>

<p>在浏览器打开你在nginx中配置的域名，NextCloud初始化非常简单，设定一个管理员账户和密码，然后设定数据库即可，按照我们上一步针对MySQL的设定，你会非常清楚地知道你的数据库信息：</p>

<p><img src="https://samzong.oss-cn-shenzhen.aliyuncs.com/blog/jjkqh.png" alt="" /></p>

<p>登录之后的界面是这样：</p>

<p><img src="https://samzong.oss-cn-shenzhen.aliyuncs.com/blog/7n28v.png" alt="" /></p>

<p>你可以在登录之后，在你的右上角点击头像选择Admin进入管理界面查看和修改你的服务器设置，你还可以在浏览器上方看到你的服务器现有哪些问题，会有对应文档提醒你如何解决这些问题。</p>

<p><img src="https://samzong.oss-cn-shenzhen.aliyuncs.com/blog/yx34e.png" alt="" /></p>

<h4 id="other"><strong>Other</strong></h4>

<h5 id="修改默认data目录">修改默认data目录</h5>

<p>在我们首次打开NextCloud网页时，需要我们设定datadir目录，这里有个默认目录在nextcloud项目包，这其实是不安全的，我们最后将目录路径修改为其他位置:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@ultraera ~]# mkdir /nextcloud_files/
[root@ultraera ~]# chown -R nginx:nginx /nextcloud_files/

# 修改datadirectory的路径
[root@ultraera ~]# vim /opt/nextcloud/config/config.php
datadirectory' =&gt; '/nextcloud/data
</code></pre></div></div>

<h5 id="无法登陆到个人用户界面">无法登陆到个人用户界面</h5>

<p>我在安装时碰到这个问题，折腾了很久才解决，因为我们是使用nginx程序，但是php-fpm默认用户身份为apache，所以<code>/var/lib/php/session</code>目录的所属用户和组都是apache，导致我们没有权限去写入session，所以无法登入系统，报错信息可以在NextCloud的log文件下看到：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@ultraera ~]# tail -n 1 /usr/nextcloud/data/nextcloud.log
{"reqId":"NNnIwMCCPDMQtzZW5Ndc","remoteAddr":"180.166.66.226","app":"PHP","message":"session_write_close(): Failed to write session data (files). Please verify that the current setting of session.save_path is correct (\/var\/lib\/php\/session) at \/usr\/nextcloud\/lib\/private\/Session\/Internal.php#104","level":3,"time":"2017-02-24T10:46:13+00:00","method":"POST","url":"\/index.php","user":"samzong","version":"11.0.0.10"}

# 修改/var/lib/php/的属组为nginx即可
[root@ultraera ~]# chgrp -R nginx /var/lib/php
</code></pre></div></div>

<h5 id="增加redis组件提高性能">增加redis组件，提高性能</h5>

<p>关于如何安装redis我在之前的文章中也有讲到，大家可以去看下 <a href="https://samzong.me/redis01/">安装教程</a></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@ultraera ~]# yum --enablerepo=remi install -y redis

# 增加php的redis插件
[root@ultraera ~]# yum --enablerepo=remi-php56 install php-redis

# 配置文件增加redis
  'memcache.local' =&gt; '\\OC\\Memcache\\Redis',
  'memcache.locking' =&gt; '\\OC\\Memcache\\Redis',
  'redis' =&gt;
   array (
    'host' =&gt; 'localhost',
    'port' =&gt; 6379,
   )

# 重启令服务生效
[root@ultraera ~]# service php-fpm restart
[root@ultraera ~]# service nginx restart
</code></pre></div></div>

<p>我的NextCloud配置如下：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?php
$CONFIG = array (
  'memcache.local' =&gt; '\\OC\\Memcache\\Redis',
  'memcache.locking' =&gt; '\\OC\\Memcache\\Redis',
  'redis' =&gt;
  array (
    'host' =&gt; 'localhost',
    'port' =&gt; 6379,
  ),
  'enable_previews' =&gt; false,
  'instanceid' =&gt; 'ockhup01dxbf',
  'passwordsalt' =&gt; 'TlJgWGrE0N7vOrRfZkOojwdYh/BixL',
  'secret' =&gt; '/IQh0LioZp5eYFQJhicY7n324Q80WQUYOzWL+8OcxcXVw3Ef',
  'trusted_domains' =&gt;
  array (
    0 =&gt; 'pan.ultraera.org',
  ),
  'datadirectory' =&gt; '/nextcloud',
  'overwrite.cli.url' =&gt; 'https://pan.ultraera.org',
  'dbtype' =&gt; 'mysql',
  'version' =&gt; '11.0.0.10',
  'dbname' =&gt; 'nextcloud',
  'dbhost' =&gt; 'localhost',
  'dbport' =&gt; '',
  'dbtableprefix' =&gt; 'oc_',
  'dbuser' =&gt; 'nextcloud',
  'dbpassword' =&gt; 'nextcloud',
  'logtimezone' =&gt; 'CST',
  'installed' =&gt; true,
  'mail_from_address' =&gt; 'luchuanjia',
  'mail_smtpmode' =&gt; 'php',
  'mail_domain' =&gt; 'msn.com',
);
</code></pre></div></div>

<h5 id="ssl证书">SSL证书</h5>

<p>现国内提供免费的SSL证书的服务商很多，作为个人站点，免费SSL证书是个挺不错的选择，我在之前nginx配置时将ssl的配置方式写在了配置文件中了，注意如果不启用ssl时，不要启用https的虚拟主机，当然你可以自己生成一个ssl证书来提供服务，但这样在别人访问你的网站时，会不提示不受信任的证书，具体如何获取的证书的方式，因各个厂家方式有些区别，这里就不赘述，可以联系对应的厂商的技术人员咨询。</p>

<h4 id="使用现状"><strong>使用现状</strong></h4>

<p>在将服务搭建完成之后，对于存储的文件加密，现在通过jobs，每日凌晨将文件推送到oss内，保存2天的数据，避免因为服务器宕机导致文件丢失；使用端，自己的电脑和手机，还有家人的手机，都安装了应用，后台自动将拍照图片等自动上传到云盘，使用起来目前很稳定，只是iOS应用是收费的，因为NextCloud源于OwnCloud，如果你之前购买了OwnCloud的App也可以直接使用，当然NextCloud也有很多其他功能，可以根据你的实际需求发掘。</p>

      
    </div>
    <br/>
    <div>
      <cite>2017-02-27</cite> <i class="icon-tag"></i>
      <a href="/tags.html#NextCloud">NextCloud</a>
      
      
      
    </div>
    <div style="clear: both;"></div>
    <hr/>
    

    <!-- Pagination links -->
    <nav>
      <ul class="pagination hidden-xs">
        
        
        <li>
          <a href="/page4">&laquo; Previous</a>
        </li>
        
        

        
        <li>
          <a href="/">1</a>
        </li>
        

        
          
            
              
                <li><a href="/page2">2</a></li>
              
            
              
                <li><a href="/page3">3</a></li>
              
            
              
                <li><a href="/page4">4</a></li>
              
            
              
                <li class="active"><a>5</a></li>
                
            
          
          <li class="disabled"><span>...</span></li>
          <li><a href="/page14">14</a></li>
        

        
        

        
        <li>
          <a href="/page6">Next &raquo;</a>
        </li>
        
      </ul>
    </nav>
  </div>
  <div class="col-xs-12 col-md-4">
		<!-- <div>
			<a class="twitter-timeline" data-width="390" data-height="640" data-theme="light" href="https://twitter.com/samzong_lu?ref_src=twsrc%5Etfw">Tweets by SAMZONG</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
		</div> -->
    <div>
      <h2>传送门</h2>
      <ul>
        <li><a href="https://yuque.com/samzong">语雀-花园</a></li>
        <li><a href="https://github.com/samzong">Github</a></li>
      </ul>
    </div>
    <div class="categories">
      <h2>文章分类</h2>
      <ul class="tag_box">
        
        


  
     
    	<li><a href="/categories.html#Linux">
    		Linux <span>21</span>
    	</a></li>
     
    	<li><a href="/categories.html#CentOS">
    		CentOS <span>14</span>
    	</a></li>
     
    	<li><a href="/categories.html#Tools">
    		Tools <span>4</span>
    	</a></li>
     
    	<li><a href="/categories.html#VPN">
    		VPN <span>2</span>
    	</a></li>
     
    	<li><a href="/categories.html#HTML">
    		HTML <span>1</span>
    	</a></li>
     
    	<li><a href="/categories.html#数据库">
    		数据库 <span>19</span>
    	</a></li>
     
    	<li><a href="/categories.html#MySQL">
    		MySQL <span>15</span>
    	</a></li>
     
    	<li><a href="/categories.html#Git">
    		Git <span>5</span>
    	</a></li>
     
    	<li><a href="/categories.html#TortoiseGit">
    		TortoiseGit <span>1</span>
    	</a></li>
     
    	<li><a href="/categories.html#MongoDB">
    		MongoDB <span>1</span>
    	</a></li>
     
    	<li><a href="/categories.html#PHP">
    		PHP <span>1</span>
    	</a></li>
     
    	<li><a href="/categories.html#Mac">
    		Mac <span>6</span>
    	</a></li>
     
    	<li><a href="/categories.html#SourceTree">
    		SourceTree <span>2</span>
    	</a></li>
     
    	<li><a href="/categories.html#OpenSource">
    		OpenSource <span>11</span>
    	</a></li>
     
    	<li><a href="/categories.html#Piwik">
    		Piwik <span>1</span>
    	</a></li>
     
    	<li><a href="/categories.html#Python">
    		Python <span>7</span>
    	</a></li>
     
    	<li><a href="/categories.html#云服务">
    		云服务 <span>6</span>
    	</a></li>
     
    	<li><a href="/categories.html#Azure">
    		Azure <span>4</span>
    	</a></li>
     
    	<li><a href="/categories.html#虚拟化">
    		虚拟化 <span>7</span>
    	</a></li>
     
    	<li><a href="/categories.html#OpenStack">
    		OpenStack <span>1</span>
    	</a></li>
     
    	<li><a href="/categories.html#CloudStack">
    		CloudStack <span>1</span>
    	</a></li>
     
    	<li><a href="/categories.html#Zabbix">
    		Zabbix <span>2</span>
    	</a></li>
     
    	<li><a href="/categories.html#Tomcat">
    		Tomcat <span>5</span>
    	</a></li>
     
    	<li><a href="/categories.html#Redis">
    		Redis <span>1</span>
    	</a></li>
     
    	<li><a href="/categories.html#Docker">
    		Docker <span>4</span>
    	</a></li>
     
    	<li><a href="/categories.html#Shell">
    		Shell <span>2</span>
    	</a></li>
     
    	<li><a href="/categories.html#Blog">
    		Blog <span>4</span>
    	</a></li>
     
    	<li><a href="/categories.html#Ghost">
    		Ghost <span>2</span>
    	</a></li>
     
    	<li><a href="/categories.html#PostgreSQL">
    		PostgreSQL <span>1</span>
    	</a></li>
     
    	<li><a href="/categories.html#AWS">
    		AWS <span>1</span>
    	</a></li>
     
    	<li><a href="/categories.html#Aliyun">
    		Aliyun <span>1</span>
    	</a></li>
     
    	<li><a href="/categories.html#Redmine">
    		Redmine <span>2</span>
    	</a></li>
     
    	<li><a href="/categories.html#Bigdata">
    		Bigdata <span>1</span>
    	</a></li>
     
    	<li><a href="/categories.html#Windows">
    		Windows <span>1</span>
    	</a></li>
     
    	<li><a href="/categories.html#Jmeter">
    		Jmeter <span>1</span>
    	</a></li>
     
    	<li><a href="/categories.html#随笔">
    		随笔 <span>1</span>
    	</a></li>
     
    	<li><a href="/categories.html#闲聊">
    		闲聊 <span>3</span>
    	</a></li>
     
    	<li><a href="/categories.html#Hexo">
    		Hexo <span>1</span>
    	</a></li>
     
    	<li><a href="/categories.html#Javascript">
    		Javascript <span>1</span>
    	</a></li>
     
    	<li><a href="/categories.html#Telegram">
    		Telegram <span>1</span>
    	</a></li>
     
    	<li><a href="/categories.html#Metabase">
    		Metabase <span>1</span>
    	</a></li>
     
    	<li><a href="/categories.html#学习">
    		学习 <span>2</span>
    	</a></li>
     
    	<li><a href="/categories.html#Github">
    		Github <span>1</span>
    	</a></li>
    
  



      </ul>
    </div>
    <div>
      <h2>最近文章</h2>
      <ul>
        
        <li>
          <a href="/post/2022/09/K8s%E7%B3%BB%E5%88%97-%E5%8D%97%E5%8C%97%E6%B5%81%E9%87%8F%E5%92%8C%E4%B8%9C%E8%A5%BF%E6%B5%81%E9%87%8F.html">K8s系列 南北流量和东西流量</a>
          南北流量和东西流量 是什么意思？


        </li>
        
        <li>
          <a href="/post/2022/07/jq-%E5%91%BD%E4%BB%A4%E8%A1%8C-Json-%E5%A4%84%E7%90%86%E7%A5%9E%E5%99%A8.html">jq 命令行 Json 处理神器</a>
          
  https://mozillazg.com/2018/01/jq-use-examples-cookbook.htm-



        </li>
        
        <li>
          <a href="/post/2022/07/%E9%97%AD%E5%85%B3%E5%A4%87%E6%88%98-11%E6%9C%88.html">闭关备战 11月</a>
          title: 闭关备战 11月
toc: true
author: samzong.lu
author_id: defaultAuthorId
language: zh
abbrlink: 13757
tags: []
categories: []
date: 2022-07-18 00:35:00
—
目标


        </li>
        
        <li>
          <a href="/post/2022/05/hexo-admonition.html">Hexo 增加admonition样式支持</a>
          背景


        </li>
        
        <li>
          <a href="/post/2022/05/%E5%9B%BD%E5%86%85%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-MacOS-K8s-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83.html">国内环境搭建 MacOS K8s 开发环境</a>
          Minikube


        </li>
        
      </ul>
    </div>
  </div>
</div>

			</div>

		</div>

    <footer>
      <div class="container">
        <div class="row mobilepadding">
          			<hr>
      &copy; 2022 船长. Powered by <a href="http://jekyllrb.com" target="_blank" title="The simple, blog-aware, static site generator.">Jekyll</a>. Theme Creator <a href="https://github.com/einverne" target="_blank" title="Ein Verne's GitHub Repos">Ein Verne</a> . Host on <a href="https://github.com/samzong/samzong.me" target="_blank" title="Samzong's GitHub Repos">Github</a> .
      <br><br>
      </div>
    </div>
    </footer>

    




	<script async type="text/javascript" src="/assets/themes/evjekylltheme/bootstrap-3.3.5/js/bootstrap.min.js"></script>
	<script async type="text/javascript" src="/assets/themes/evjekylltheme/webcore.js"></script>

 </body>
</html>

