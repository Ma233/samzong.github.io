<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">HowTo Install NextCloud | SAMZONG</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://samzong.me/2017/02/27/HowTo-Install-NextCloud"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="HowTo Install NextCloud | SAMZONG"><meta data-rh="true" name="description" content="随着最近一个云盘厂家不再提供个人服务，或者开始各种收费限速，自己存放在第三方云盘厂商的数据被盗取，数据的安全性和数据的稳定性都得不到保证，而且随着智能终端的普及，我也有一些更加高质量的图片文件需要大量储存，所以我想到了自建存储服务的方式，在甄别了 OwnCloud，Seafiles 和 NextCloud，最后选择了 NextCloud 作为自己今后数据存储节点，NextCloud 源自 OwnCloud，但是近些年来 OwnCloud 的发展进度几乎停滞，多数开发者也转战 NextCloud，当然 NextCloud 也继承了搭建简单，依赖于 PHP 环境的特性。"><meta data-rh="true" property="og:description" content="随着最近一个云盘厂家不再提供个人服务，或者开始各种收费限速，自己存放在第三方云盘厂商的数据被盗取，数据的安全性和数据的稳定性都得不到保证，而且随着智能终端的普及，我也有一些更加高质量的图片文件需要大量储存，所以我想到了自建存储服务的方式，在甄别了 OwnCloud，Seafiles 和 NextCloud，最后选择了 NextCloud 作为自己今后数据存储节点，NextCloud 源自 OwnCloud，但是近些年来 OwnCloud 的发展进度几乎停滞，多数开发者也转战 NextCloud，当然 NextCloud 也继承了搭建简单，依赖于 PHP 环境的特性。"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2017-02-27T14:57:00.000Z"><meta data-rh="true" property="article:tag" content="Tools"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://samzong.me/2017/02/27/HowTo-Install-NextCloud"><link data-rh="true" rel="alternate" href="https://samzong.me/2017/02/27/HowTo-Install-NextCloud" hreflang="en"><link data-rh="true" rel="alternate" href="https://samzong.me/2017/02/27/HowTo-Install-NextCloud" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/rss.xml" title="SAMZONG RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="SAMZONG Atom Feed"><link rel="stylesheet" href="/assets/css/styles.44c5c7e5.css">
<link rel="preload" href="/assets/js/runtime~main.dedf9ab4.js" as="script">
<link rel="preload" href="/assets/js/main.e77dfce3.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(e){}return e}()||function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):window.matchMedia("(prefers-color-scheme: light)").matches?e("light"):e("dark")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/"></a></div><div class="navbar__items navbar__items--right"><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><main class="col col--9 col--offset-1" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="title_f1Hy" itemprop="headline">HowTo Install NextCloud</h1><div class="container_mt6G margin-vert--md"><time datetime="2017-02-27T14:57:00.000Z" itemprop="datePublished">February 27, 2017</time> · <!-- -->11 min read</div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>随着最近一个云盘厂家不再提供个人服务，或者开始各种收费限速，自己存放在第三方云盘厂商的数据被盗取，数据的安全性和数据的稳定性都得不到保证，而且随着智能终端的普及，我也有一些更加高质量的图片文件需要大量储存，所以我想到了自建存储服务的方式，在甄别了 OwnCloud，Seafiles 和 NextCloud，最后选择了 NextCloud 作为自己今后数据存储节点，NextCloud 源自 OwnCloud，但是近些年来 OwnCloud 的发展进度几乎停滞，多数开发者也转战 NextCloud，当然 NextCloud 也继承了搭建简单，依赖于 PHP 环境的特性。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="运行环境">运行环境<a href="#运行环境" class="hash-link" aria-label="Direct link to 运行环境" title="Direct link to 运行环境">​</a></h2><ul><li>阿里云 ECS CentOS 6.x</li><li>免费 SSL 证书 (腾讯云申请)</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="搭建-lnmp-环境">搭建 LNMP 环境<a href="#搭建-lnmp-环境" class="hash-link" aria-label="Direct link to 搭建 LNMP 环境" title="Direct link to 搭建 LNMP 环境">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="软件版本">软件版本<a href="#软件版本" class="hash-link" aria-label="Direct link to 软件版本" title="Direct link to 软件版本">​</a></h3><ul><li>PHP 5.6.30   <a href="https://samzong.me/php54-centos6/" target="_blank" rel="noopener noreferrer">安装教程</a></li><li>MySQL 5.6.35  <a href="https://samzong.me/how-to-install-mysql-5-6-on-centos/" target="_blank" rel="noopener noreferrer">安装教程</a></li><li>Nginx 1.10.2</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="基础环境安装">基础环境安装<a href="#基础环境安装" class="hash-link" aria-label="Direct link to 基础环境安装" title="Direct link to 基础环境安装">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># yum update -y</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># yum groupinstall -y &quot;Base&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># yum groupinstall -y &quot;Development tools&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Install epel</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># yum install -y epel-release</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Install remi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># yum install http://rpms.famillecollet.com/enterprise/remi-release-6.rpm</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Install mysql-community</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># yum install http://repo.mysql.com/yum/mysql-5.6-community/el/6/x86_64/mysql-community-release-el6-7.noarch.rpm</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="install-lnmp">Install LNMP<a href="#install-lnmp" class="hash-link" aria-label="Direct link to Install LNMP" title="Direct link to Install LNMP">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># Install MySQL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># yum --enablerepo=mysql-community install -y mysql-server mysql-libs mysql-devel</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># service mysqld start</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># mysql_secure_installation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># chkconfig mysqld on</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Install Nginx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># yum --enablerepo=epel install -y nginx</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># service nginx start</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># chkconfig nginx on</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># Install PHP and php-fpm</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># yum --enablerepo=remi-php56 install php php-fpm php-mysql php-gd php-xml php-redis php-libs php-devel php-zlib</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># service php-fpm start</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># chkconfig php-fpm on</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># service nginx restart</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="下载-nextcloud">下载 NextCloud<a href="#下载-nextcloud" class="hash-link" aria-label="Direct link to 下载 NextCloud" title="Direct link to 下载 NextCloud">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># wget https://download.nextcloud.com/server/releases/nextcloud-11.0.1.tar.bz2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># tar xf nextcloud-11.0.1.tar.bz2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># mv nextcloud-11.0.1 /opt/nextcloud</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="配置-nginx-和-php-fpm">配置 Nginx 和 php-fpm<a href="#配置-nginx-和-php-fpm" class="hash-link" aria-label="Direct link to 配置 Nginx 和 php-fpm" title="Direct link to 配置 Nginx 和 php-fpm">​</a></h3><p>因为 php-fpm 默认运行的用户身份是 apache，我们这里使用的环境是 nginx，所有要修改 php-fpm 配置文件的用户和组，注意不要为了省事直接改为 root，这在 php-fpm 中是不允许的</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># vim /etc/php-fpm.d/www.conf</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">user</span><span class="token operator">=</span><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">group</span><span class="token operator">=</span><span class="token plain">nginx</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># service php-fpm restart</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>因为 NextCloud 默认是以 Apache 的身份运行的，所以我们需要单独配置 NextCloud 的 Nginx 配置文件，以下配置文件，你可以直接拿去用，注意在文件中说明了，需要修改的地方：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># vim /etc/nginx/conf.d/nextcloud.conf</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> upstream php-handler </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   </span><span class="token comment" style="color:rgb(98, 114, 164)"># 这里是你php-fpm的服务端口，默认是9000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    server </span><span class="token number">127.0</span><span class="token plain">.0.1:9000</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">#server unix:/var/run/php5-fpm.sock;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">server </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   </span><span class="token comment" style="color:rgb(98, 114, 164)"># 你的域名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    listen pan.ultraera.org:80</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    server_name pan.ultraera.org</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># enforce https</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">return</span><span class="token plain"> </span><span class="token number">301</span><span class="token plain"> https://</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$server_name</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$request_uri</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">server </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># 你的域名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    listen pan.ultraera.org:443 ssl</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    server_name pan.ultraera.org</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   </span><span class="token comment" style="color:rgb(98, 114, 164)"># 以下是你的ssl证书文件存放路径</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ssl_certificate /etc/nginx/ssl/1_pan.ultraera.org_bundle.crt</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ssl_certificate_key /etc/nginx/ssl/2_pan.ultraera.org.key</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Add headers to serve security related headers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Before enabling Strict-Transport-Security headers please read into this</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># topic first.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># add_header Strict-Transport-Security &quot;max-age=15768000;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># includeSubDomains; preload;&quot;;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    add_header X-Content-Type-Options nosniff</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    add_header X-Frame-Options </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;SAMEORIGIN&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    add_header X-XSS-Protection </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;1; mode=block&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    add_header X-Robots-Tag none</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    add_header X-Download-Options noopen</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    add_header X-Permitted-Cross-Domain-Policies none</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> add_header Strict-Transport-Security </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;max-age=15552000; includeSubdomains; &quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># 设定你的NextCloud的根目录，请根据实际修改</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    root /opt/nextcloud/</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    location </span><span class="token operator">=</span><span class="token plain"> /robots.txt </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        allow all</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        log_not_found off</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        access_log off</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># The following 2 rules are only needed for the user_webfinger app.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Uncomment it if you&#x27;re planning to use this app.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">#rewrite ^/.well-known/host-meta /public.php?service=host-meta last;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">#rewrite ^/.well-known/host-meta.json /public.php?service=host-meta-json</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># last;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    location </span><span class="token operator">=</span><span class="token plain"> /.well-known/carddav </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">return</span><span class="token plain"> </span><span class="token number">301</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$scheme</span><span class="token plain">://</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$host</span><span class="token plain">/remote.php/dav</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    location </span><span class="token operator">=</span><span class="token plain"> /.well-known/caldav </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">return</span><span class="token plain"> </span><span class="token number">301</span><span class="token plain"> </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$scheme</span><span class="token plain">://</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$host</span><span class="token plain">/remote.php/dav</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># set max upload size</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    client_max_body_size 512M</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    fastcgi_buffers </span><span class="token number">64</span><span class="token plain"> 4K</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Disable gzip to avoid the removal of the ETag header</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">gzip</span><span class="token plain"> off</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Uncomment if your server is build with the ngx_pagespeed module</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># This module is currently not supported.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">#pagespeed off;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    error_page </span><span class="token number">403</span><span class="token plain"> /core/templates/403.php</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    error_page </span><span class="token number">404</span><span class="token plain"> /core/templates/404.php</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    location / </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        rewrite ^ /index.php</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$uri</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    location ~ ^/</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">?:build</span><span class="token operator">|</span><span class="token plain">tests</span><span class="token operator">|</span><span class="token plain">config</span><span class="token operator">|</span><span class="token plain">lib</span><span class="token operator">|</span><span class="token plain">3rdparty</span><span class="token operator">|</span><span class="token plain">templates</span><span class="token operator">|</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">/ </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        deny all</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    location ~ ^/</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">?:</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">.</span><span class="token operator">|</span><span class="token plain">autotest</span><span class="token operator">|</span><span class="token plain">occ</span><span class="token operator">|</span><span class="token plain">issue</span><span class="token operator">|</span><span class="token plain">indie</span><span class="token operator">|</span><span class="token plain">db_</span><span class="token operator">|</span><span class="token plain">console</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        deny all</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    location ~ ^/</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">?:index</span><span class="token operator">|</span><span class="token plain">remote</span><span class="token operator">|</span><span class="token plain">public</span><span class="token operator">|</span><span class="token function" style="color:rgb(80, 250, 123)">cron</span><span class="token operator">|</span><span class="token plain">core/ajax/update</span><span class="token operator">|</span><span class="token plain">status</span><span class="token operator">|</span><span class="token plain">ocs/v</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">12</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token operator">|</span><span class="token plain">updater/.+</span><span class="token operator">|</span><span class="token plain">ocs-provider/.+</span><span class="token operator">|</span><span class="token plain">core/templates/40</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">34</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">.php</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">?:$</span><span class="token operator">|</span><span class="token plain">/</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        include fastcgi_params</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        fastcgi_split_path_info ^</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">.+</span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">.php</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">/.*</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">$</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        fastcgi_param SCRIPT_FILENAME </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$document_root</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$fastcgi_script_name</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        fastcgi_param PATH_INFO </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$fastcgi_path_info</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        fastcgi_param HTTPS on</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">#Avoid sending the security headers twice</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        fastcgi_param modHeadersAvailable </span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        fastcgi_param front_controller_active </span><span class="token boolean">true</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        fastcgi_pass php-handler</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        fastcgi_intercept_errors on</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        fastcgi_request_buffering off</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    location ~ ^/</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">?:updater</span><span class="token operator">|</span><span class="token plain">ocs-provider</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">?:$</span><span class="token operator">|</span><span class="token plain">/</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        try_files </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$uri</span><span class="token plain">/ </span><span class="token operator">=</span><span class="token number">404</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        index index.php</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Adding the cache control header for js and css files</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Make sure it is BELOW the PHP block</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    location ~* </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">?:css</span><span class="token operator">|</span><span class="token plain">js</span><span class="token operator">|</span><span class="token plain">woff</span><span class="token operator">|</span><span class="token plain">svg</span><span class="token operator">|</span><span class="token plain">gif</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">$ </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        try_files </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$uri</span><span class="token plain"> /index.php</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$uri</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$is_args</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$args</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        add_header Cache-Control </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;public, max-age=7200&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Add headers to serve security related headers (It is intended to</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># have those duplicated to the ones above)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Before enabling Strict-Transport-Security headers please read into</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># this topic first.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># add_header Strict-Transport-Security &quot;max-age=15768000;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)">#  includeSubDomains; preload;&quot;;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        add_header X-Content-Type-Options nosniff</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        add_header X-Frame-Options </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;SAMEORIGIN&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        add_header X-XSS-Protection </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;1; mode=block&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        add_header X-Robots-Tag none</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        add_header X-Download-Options noopen</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        add_header X-Permitted-Cross-Domain-Policies none</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Optional: Don&#x27;t log access to assets</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        access_log off</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    location ~* </span><span class="token punctuation" style="color:rgb(248, 248, 242)">\</span><span class="token plain">.</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">?:png</span><span class="token operator">|</span><span class="token plain">html</span><span class="token operator">|</span><span class="token plain">ttf</span><span class="token operator">|</span><span class="token plain">ico</span><span class="token operator">|</span><span class="token plain">jpg</span><span class="token operator">|</span><span class="token plain">jpeg</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">$ </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        try_files </span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$uri</span><span class="token plain"> /index.php</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$uri</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$is_args</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$args</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token comment" style="color:rgb(98, 114, 164)"># Optional: Don&#x27;t log access to other assets</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        access_log off</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># service nginx restart</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="文件权限调整">文件权限调整<a href="#文件权限调整" class="hash-link" aria-label="Direct link to 文件权限调整" title="Direct link to 文件权限调整">​</a></h3><p>因为 NextCloud 运行是以 nginx 程序，注意修改目录所属用户和组为 nginx</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># chown -R nginx:nginx /opt/nextcloud</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="创建-mysql-数据库">创建 MySQL 数据库<a href="#创建-mysql-数据库" class="hash-link" aria-label="Direct link to 创建 MySQL 数据库" title="Direct link to 创建 MySQL 数据库">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysql</span><span class="token operator">&gt;</span><span class="token plain"> CREATE DATABASE nextcloud CHARACTER SET UTF-8</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysql</span><span class="token operator">&gt;</span><span class="token plain"> GRANT ALL PRIVILEGES ON nextcloud.* TO </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;nextcloud&#x27;</span><span class="token plain">@</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;localhost&#x27;</span><span class="token plain"> IDENTIFIED BY </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;your_password&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysql</span><span class="token operator">&gt;</span><span class="token plain"> FLUSH PRIVILEGES</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="初始化-nextcloud">初始化 NextCloud<a href="#初始化-nextcloud" class="hash-link" aria-label="Direct link to 初始化 NextCloud" title="Direct link to 初始化 NextCloud">​</a></h2><p>在浏览器打开你在 nginx 中配置的域名，NextCloud 初始化非常简单，设定一个管理员账户和密码，然后设定数据库即可，按照我们上一步针对 MySQL 的设定，你会非常清楚地知道你的数据库信息：</p><p><img loading="lazy" src="https://img.samzong.me/202307191530733.png?imageView2/3/w/400/interlace/1/q/50" alt="image" class="img_ev3q"></p><p>登录之后的界面是这样：</p><p><img loading="lazy" src="https://img.samzong.me/202307191530734.png?imageView2/3/w/400/interlace/1/q/50" alt="image" class="img_ev3q"></p><p>你可以在登录之后，在你的右上角点击头像选择 Admin 进入管理界面查看和修改你的服务器设置，你还可以在浏览器上方看到你的服务器现有哪些问题，会有对应文档提醒你如何解决这些问题。</p><p><img loading="lazy" src="https://img.samzong.me/202307191530735.png?imageView2/3/w/400/interlace/1/q/50" alt="image" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="other">Other<a href="#other" class="hash-link" aria-label="Direct link to Other" title="Direct link to Other">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="修改默认-data-目录">修改默认 data 目录<a href="#修改默认-data-目录" class="hash-link" aria-label="Direct link to 修改默认 data 目录" title="Direct link to 修改默认 data 目录">​</a></h3><p>在我们首次打开 NextCloud 网页时，需要我们设定 datadir 目录，这里有个默认目录在 nextcloud 项目包，这其实是不安全的，我们最后将目录路径修改为其他位置：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># mkdir /nextcloud_files/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># chown -R nginx:nginx /nextcloud_files/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># 修改datadirectory的路径</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># vim /opt/nextcloud/config/config.php</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">datadirectory</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27; =&gt; &#x27;</span><span class="token plain">/nextcloud/data</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="无法登陆到个人用户界面">无法登陆到个人用户界面<a href="#无法登陆到个人用户界面" class="hash-link" aria-label="Direct link to 无法登陆到个人用户界面" title="Direct link to 无法登陆到个人用户界面">​</a></h3><p>我在安装时碰到这个问题，折腾了很久才解决，因为我们是使用 nginx 程序，但是 php-fpm 默认用户身份为 apache，所以<code>/var/lib/php/session</code>目录的所属用户和组都是 apache，导致我们没有权限去写入 session，所以无法登入系统，报错信息可以在 NextCloud 的 log 文件下看到：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># tail -n 1 /usr/nextcloud/data/nextcloud.log</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;reqId&quot;</span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">:</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;NNnIwMCCPDMQtzZW5Ndc&quot;</span><span class="token plain">,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;remoteAddr&quot;</span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">:</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;180.166.66.226&quot;</span><span class="token plain">,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;app&quot;</span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">:</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;PHP&quot;</span><span class="token plain">,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;message&quot;</span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">:</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;session_write_close(): Failed to write session data (files). Please verify that the current setting of session.save_path is correct (\/var\/lib\/php\/session) at \/usr\/nextcloud\/lib\/private\/Session\/Internal.php#104&quot;</span><span class="token plain">,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;level&quot;</span><span class="token plain">:3,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;time&quot;</span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">:</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;2017-02-24T10:46:13+00:00&quot;</span><span class="token plain">,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;method&quot;</span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">:</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;POST&quot;</span><span class="token plain">,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;url&quot;</span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">:</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;\/index.php&quot;</span><span class="token plain">,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;user&quot;</span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">:</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;samzong&quot;</span><span class="token plain">,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;version&quot;</span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">:</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;11.0.0.10&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># 修改/var/lib/php/的属组为nginx即可</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># chgrp -R nginx /var/lib/php</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="增加-redis-组件提高性能">增加 redis 组件，提高性能<a href="#增加-redis-组件提高性能" class="hash-link" aria-label="Direct link to 增加 redis 组件，提高性能" title="Direct link to 增加 redis 组件，提高性能">​</a></h3><p>关于如何安装 redis 我在之前的文章中也有讲到，大家可以去看下 <a href="https://samzong.me/redis01/" target="_blank" rel="noopener noreferrer">安装教程</a></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># yum --enablerepo=remi install -y redis</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># 增加php的redis插件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># yum --enablerepo=remi-php56 install php-redis</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># 配置文件增加redis</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;memcache.local&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;\\OC\\Memcache\\Redis&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;memcache.locking&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;\\OC\\Memcache\\Redis&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;redis&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   array </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;host&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;localhost&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;port&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">6379</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># 重启令服务生效</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># service php-fpm restart</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">root@ultraera ~</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token comment" style="color:rgb(98, 114, 164)"># service nginx restart</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>我的 NextCloud 配置如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token operator">&lt;</span><span class="token plain">?php</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">$CONFIG</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> array </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;memcache.local&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;\\OC\\Memcache\\Redis&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;memcache.locking&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;\\OC\\Memcache\\Redis&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;redis&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  array </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;host&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;localhost&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;port&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">6379</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;enable_previews&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"> false,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;instanceid&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;ockhup01dxbf&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;passwordsalt&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;TlJgWGrE0N7vOrRfZkOojwdYh/BixL&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;secret&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;/IQh0LioZp5eYFQJhicY7n324Q80WQUYOzWL+8OcxcXVw3Ef&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;trusted_domains&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  array </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token number">0</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;pan.ultraera.org&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;datadirectory&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;/nextcloud&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;overwrite.cli.url&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;https://pan.ultraera.org&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;dbtype&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;mysql&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;version&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;11.0.0.10&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;dbname&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;nextcloud&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;dbhost&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;localhost&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;dbport&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;dbtableprefix&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;oc_&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;dbuser&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;nextcloud&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;dbpassword&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;nextcloud&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;logtimezone&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;CST&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;installed&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"> true,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;mail_from_address&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;luchuanjia&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;mail_smtpmode&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;php&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;mail_domain&#x27;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;msn.com&#x27;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ssl-证书">SSL 证书<a href="#ssl-证书" class="hash-link" aria-label="Direct link to SSL 证书" title="Direct link to SSL 证书">​</a></h3><p>现国内提供免费的 SSL 证书的服务商很多，作为个人站点，免费 SSL 证书是个挺不错的选择，我在之前 nginx 配置时将 ssl 的配置方式写在了配置文件中了，注意如果不启用 ssl 时，不要启用 https 的虚拟主机，当然你可以自己生成一个 ssl 证书来提供服务，但这样在别人访问你的网站时，会不提示不受信任的证书，具体如何获取的证书的方式，因各个厂家方式有些区别，这里就不赘述，可以联系对应的厂商的技术人员咨询。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="使用现状">使用现状<a href="#使用现状" class="hash-link" aria-label="Direct link to 使用现状" title="Direct link to 使用现状">​</a></h2><p>在将服务搭建完成之后，对于存储的文件加密，现在通过 jobs，每日凌晨将文件推送到 oss 内，保存 2 天的数据，避免因为服务器宕机导致文件丢失；使用端，自己的电脑和手机，还有家人的手机，都安装了应用，后台自动将拍照图片等自动上传到云盘，使用起来目前很稳定，只是 iOS 应用是收费的，因为 NextCloud 源于 OwnCloud，如果你之前购买了 OwnCloud 的 App 也可以直接使用，当然 NextCloud 也有很多其他功能，可以根据你的实际需求发掘。</p></div><footer class="row docusaurus-mt-lg blogPostFooterDetailsFull_mRVl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/tools">Tools</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/2017/02/22/HowTo-Install-Redmine"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">HowTo Install Redmine</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/2017/02/27/mactips-shi-yong-ming-ling-guan-bi-he-qi-dong-airport"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">MacTips 使用命令关闭和启动 AirPort</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#运行环境" class="table-of-contents__link toc-highlight">运行环境</a></li><li><a href="#搭建-lnmp-环境" class="table-of-contents__link toc-highlight">搭建 LNMP 环境</a><ul><li><a href="#软件版本" class="table-of-contents__link toc-highlight">软件版本</a></li><li><a href="#基础环境安装" class="table-of-contents__link toc-highlight">基础环境安装</a></li><li><a href="#install-lnmp" class="table-of-contents__link toc-highlight">Install LNMP</a></li><li><a href="#下载-nextcloud" class="table-of-contents__link toc-highlight">下载 NextCloud</a></li><li><a href="#配置-nginx-和-php-fpm" class="table-of-contents__link toc-highlight">配置 Nginx 和 php-fpm</a></li><li><a href="#文件权限调整" class="table-of-contents__link toc-highlight">文件权限调整</a></li><li><a href="#创建-mysql-数据库" class="table-of-contents__link toc-highlight">创建 MySQL 数据库</a></li></ul></li><li><a href="#初始化-nextcloud" class="table-of-contents__link toc-highlight">初始化 NextCloud</a></li><li><a href="#other" class="table-of-contents__link toc-highlight">Other</a><ul><li><a href="#修改默认-data-目录" class="table-of-contents__link toc-highlight">修改默认 data 目录</a></li><li><a href="#无法登陆到个人用户界面" class="table-of-contents__link toc-highlight">无法登陆到个人用户界面</a></li><li><a href="#增加-redis-组件提高性能" class="table-of-contents__link toc-highlight">增加 redis 组件，提高性能</a></li><li><a href="#ssl-证书" class="table-of-contents__link toc-highlight">SSL 证书</a></li></ul></li><li><a href="#使用现状" class="table-of-contents__link toc-highlight">使用现状</a></li></ul></div></div></div></div></div></div>
<script src="/assets/js/runtime~main.dedf9ab4.js"></script>
<script src="/assets/js/main.e77dfce3.js"></script>
</body>
</html>