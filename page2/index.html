
<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/Blog">
  <head>
    <meta charset="utf-8">
	<link rel="manifest" href="/static/pwa/manifest.json">
	<title> Home | 船长的课记 </title>
    
		
    <meta name="author" content="船长">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="theme-color" content="#2196F3">
	<meta name="google-site-verification" content="puZt0ZyqB-t67BYdYAgLUyIPBeismG68J0dmEc01QeY" />

	
    <script>
		if ('serviceWorker' in navigator) {
			window.addEventListener('load', function () {
				navigator.serviceWorker
										.register('/sw.js')
										.then(function(registration) {
											console.log("Successfully registered service worker", registration.scope);
										}).catch(function(err) {
											console.log("Service worker registration failed: ", err);
										});
				//navigator.serviceWorker.ready always resolve
				navigator.serviceWorker.ready.then(function (registration) {
					console.log('Service worker successfully registered on scope', registration.scope);
				});
			});
		}
    </script>
	<script type="text/javascript" src="/assets/themes/evjekylltheme/jquery-3.6.0.slim.min.js"></script>

	<link href="/assets/themes/evjekylltheme/google-code-prettify/desert.css" type="text/css" rel="stylesheet" />

    <!-- Le styles -->
    <link href="/assets/themes/evjekylltheme/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/evjekylltheme/css/style.css" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="/static/images/favicon.ico">

    <!-- atom & rss feed -->
    <link href="" type="application/atom+xml" rel="alternate" title="Jekyll auto generate ATOM Feed">
    <link href="" type="application/atom+xml" rel="alternate" title="Site ATOM Feed">
    <link href="" type="application/rss+xml" rel="alternate" title="Site RSS Feed">
	<link rel="stylesheet" href="/assets/themes/evjekylltheme/font-awesome-4.4.0/css/font-awesome.min.css">
	<!-- <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
	new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
	j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
	'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
	})(window,document,'script','dataLayer','GTM-W2LDG64');</script> -->
		<!-- <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8529425670069509"
						crossorigin="anonymous"></script> -->
	<!-- <script async src="https://cdn.splitbee.io/sb.js"></script> -->
  </head>

  <body>
	<!-- <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W2LDG64"
	height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript> -->
    <div class="navbar navbar-default navbar-fixed-top">
				<div class="container">
          <div class="row mobilepadding">
					<!-- <a class="navbar-brand" href="/">船长的课记</a> -->
					<a class="navbar-brand" href="/">SAMZONG</a>
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#mNavbar">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <div class="collapse navbar-collapse" id="mNavbar">
  					<ul class="nav navbar-nav">
  						
  						
  						


  
    
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/friends.html">Friends</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  
    
  
    
  
    
  
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  



						  <li class="dropdown">
							  <a class="dropdown-toggle" data-toggle="dropdown" href="#">Other</a>
							  <ul class="dropdown-menu">
									<li><a href="/about.html">About</a></li>
									<li><a href="https://yuque.com/samzong/note" target="_blank">船长的课记</a></li>
									<li><a href="https://yuque.com/samzong/ap" target="_blank">果粉日记</a></li>
									<li><a href="https://yuque.com/samzong/code" target="_blank">Code Snippet</a></li>
									<li><a href="https://www.yuque.com/samzong/mcx" target="_blank">集</a></li>
									<li><a href="https://www.yuque.com/zooka" target="_blank">藏金阁</a></li>
								</ul>
						  </li>
  					</ul>
  					<form id="search-form" class="navbar-form navbar-right" role="search">
  						<div class="form-group">
  						<input type="text" class="form-control input-sm" placeholder="Search's Bad" id="query">
  						</div>
  					</form>
  					<div class="nav-icon">
  						<a href="/feed.xml"><i class="fa fa-rss fa-2x"></i></a>
  					</div>
          </div>
				</div>
      </div>
    </div>

    <div class="container">
			<div class="row mobilepadding">
        <div class="row">
					<div class="col-md-12">
						<div class="searchresult">
						</div>
						<div id="search-loader" class="img-wrap">
						</div>
					</div>
        </div>
				<meta itemprop="image" content="https://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com/uPic/telegram-cloud-photo-size-4-5971176114485308439-x.jpg">
<div class="row">
  <div class="col-xs-12 col-md-8">
    
    
    <h1><a class="title" href="/post/2022/09/GitLab-Forked-%E5%A6%82%E4%BD%95%E8%B7%9F%E9%9A%8Fupstream%E4%B8%BB%E5%BA%93.html">GitLab Forked 如何跟随 upstream 主库</a></h1>
    <div class="post_at_index">
      <p>:::info
通过 PR 的方式共同对主仓库进行贡献的方式，是开源项目协作的非常有效的方法；通常我们不会直接对主仓库直接提交代码。
:::</p>

<p>一般情况下，我们的操作是，在需要贡献时，Fork 一份项目，然后自己修改以 PR 的方式提交贡献请求。</p>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1664330743895-9b2e0dc6-527e-4bcd-8b63-c223aa634b8f.png?x-oss-process=image/resize,w_960,m_lfit" alt="image.png" title="一份完整的 Github贡献指南" /></p>

<h2 id="github-的实现方式">Github 的实现方式</h2>

<p>熟悉 Github 的同学会发现，在 Github 上最近更新了 <code class="language-plaintext highlighter-rouge">Sync fork</code>的功能，通过简单的点击操作，即可完成对源库 (upstream) 的更新同步。
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1664330528512-563a5536-1734-4fd0-b41c-9c5d121327e0.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-09-28 at 10.01.33.jpg" title="当 upstream 超前时，提示 update branch" />
通过以上方式，我们可以方便在跟随主库的更新</p>

<blockquote>
  <p>Tips Github 的方式，仅在 Web 端 和 Github CLI 官方提供的 GH 才可以使用这样的功能</p>
</blockquote>

<h2 id="no-github-when-gitlab-">No Github, When Gitlab ?</h2>

<p>Github 更多在开源项目时贡献，实际上，在我们日常的工作当中，更多会有自建的 Gitlab 或者其他的代码 Hub，这里以 Gitlab 为例</p>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1664331575915-853554f5-c047-4f14-8e79-67e2214429bc.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-09-28 at 10.19.20.jpg" title="gitlab 默认项目首页" />
Gitlab 并未提供 Sync fork 的功能，所以我们需要自行解决同步的需求</p>

<h2 id="为仓库添加-upstream-源仓库">为仓库添加 upstream 源仓库</h2>

<p>:::success
以下方式会在终端或本地使用<code class="language-plaintext highlighter-rouge">Sourcetree</code>更加自由，仅使用 Git 的方式协作，自由度很大
:::
基于这个方式我们可以实现，有关联的 主库到从库的同步；也可以完成跨 Hub 的同步，比如：</p>

<ul>
  <li>Github -&gt;  Gitlab</li>
  <li>Github -&gt; Github</li>
  <li>Gitlab  -&gt; Gitlab</li>
  <li>Gitlab  -&gt;  Github</li>
  <li>Gitee  -&gt;  Gitlab</li>
  <li>Gitee -&gt; Github</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>samzonglu at samzongs-MacBook-Pro <span class="k">in</span> ~/Git/daocloud/DaoCloud-docs<span class="o">(</span>main✔<span class="o">)</span>
± git remote add upstream https://github.com/DaoCloud/DaoCloud-docs.git
Alias tip: gra upstream https://github.com/DaoCloud/DaoCloud-docs.git

samzonglu at samzongs-MacBook-Pro <span class="k">in</span> ~/Git/daocloud/DaoCloud-docs<span class="o">(</span>main✔<span class="o">)</span>
± git remote
Alias tip: gr
origin
upstream

samzonglu at samzongs-MacBook-Pro <span class="k">in</span> ~/Git/daocloud/DaoCloud-docs<span class="o">(</span>main✔<span class="o">)</span>
± git fetch upstream
Alias tip: gf upstream
remote: Enumerating objects: 1268, <span class="k">done</span><span class="nb">.</span>
remote: Counting objects: 100% <span class="o">(</span>182/182<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Compressing objects: 100% <span class="o">(</span>5/5<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Total 1268 <span class="o">(</span>delta 177<span class="o">)</span>, reused 182 <span class="o">(</span>delta 177<span class="o">)</span>, pack-reused 1086
Receiving objects: 100% <span class="o">(</span>1268/1268<span class="o">)</span>, 1.87 MiB | 2.74 MiB/s, <span class="k">done</span><span class="nb">.</span>
Resolving deltas: 100% <span class="o">(</span>637/637<span class="o">)</span>, completed with 119 <span class="nb">local </span>objects.
From https://github.com/DaoCloud/DaoCloud-docs
 <span class="k">*</span> <span class="o">[</span>new branch]      feature/theme                            -&gt; upstream/feature/theme
 <span class="k">*</span> <span class="o">[</span>new branch]      fix-typo                                 -&gt; upstream/fix-typo
 <span class="k">*</span> <span class="o">[</span>new branch]      gh-pages                                 -&gt; upstream/gh-pages
 <span class="k">*</span> <span class="o">[</span>new branch]      main                                     -&gt; upstream/main
 <span class="k">*</span> <span class="o">[</span>new branch]      patch-new-gh-pages-01                    -&gt; upstream/patch-new-gh-pages-01
 <span class="k">*</span> <span class="o">[</span>new branch]      stash/bug-codes                          -&gt; upstream/stash/bug-codes

samzonglu at samzongs-MacBook-Pro <span class="k">in</span> ~/Git/daocloud/DaoCloud-docs<span class="o">(</span>main✔<span class="o">)</span>
± git pull upstream main
Alias tip: gl upstream main
From https://github.com/DaoCloud/DaoCloud-docs
 <span class="k">*</span> branch            main       -&gt; FETCH_HEAD
Already up to date.

samzonglu at samzongs-MacBook-Pro <span class="k">in</span> ~/Git/daocloud/DaoCloud-docs<span class="o">(</span>main✔<span class="o">)</span>
± git push origin main
Alias tip: gp origin main
Everything up-to-date
</code></pre></div></div>

      
    </div>
    <br/>
    <div>
      <cite>2022-09-28</cite> <i class="icon-tag"></i>
      <a href="/tags.html#GitLab">GitLab</a>
      
      
      
    </div>
    <div style="clear: both;"></div>
    <hr/>
    
    
    <h1><a class="title" href="/post/2022/09/Kafka-%E7%AB%9E%E5%93%81%E8%B0%83%E7%A0%94%E5%8F%8A%E5%8A%9F%E8%83%BD%E8%AE%BE%E8%AE%A1.html">Kafka 调研及功能设计</a></h1>
    <div class="post_at_index">
      <h2 id="调研对象">调研对象</h2>

<table>
  <thead>
    <tr>
      <th>厂家</th>
      <th>产品控制台主页</th>
      <th>应用模式</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>阿里云</td>
      <td><a href="https://kafka.console.aliyun.com/">https://kafka.console.aliyun.com/</a></td>
      <td>中间件 PaaS 模块之一</td>
    </tr>
    <tr>
      <td>腾讯云</td>
      <td><a href="https://console.cloud.tencent.com/ckafka/overview">https://console.cloud.tencent.com/ckafka/overview</a></td>
      <td>中间件 PaaS 模块之一</td>
    </tr>
    <tr>
      <td>华为云</td>
      <td><a href="https://console.huaweicloud.com/dms/?region=cn-east-3&amp;engine=kafka">https://console.huaweicloud.com/dms/?region=cn-east-3&amp;engine=kafka</a></td>
      <td>中间件 PaaS 模块之一</td>
    </tr>
    <tr>
      <td>QingCloud</td>
      <td><a href="https://console.qingcloud.com/pek3/app/app-n9ro0xcp/">https://console.qingcloud.com/pek3/app/app-n9ro0xcp/</a></td>
      <td>中间件 AppCenter 模块之一</td>
    </tr>
    <tr>
      <td>UCloud</td>
      <td><a href="https://console.ucloud.cn/ukafka/ukafka">https://console.ucloud.cn/ukafka/ukafka</a></td>
      <td>中间件 PaaS 模块之一</td>
    </tr>
    <tr>
      <td>时速云</td>
      <td><a href="https://console.tenxcloud.com/middleware_center/app">https://console.tenxcloud.com/middleware_center/app</a></td>
      <td>中间件 应用之一</td>
    </tr>
  </tbody>
</table>

<h2 id="operator-选型">operator 选型</h2>

<ul>
  <li><a href="https://github.com/strimzi/strimzi-kafka-operator">https://github.com/strimzi/strimzi-kafka-operator</a></li>
  <li><a href="https://github.com/banzaicloud/koperator">https://github.com/banzaicloud/koperator</a></li>
</ul>

<h3 id="功能横向对比">功能横向对比</h3>

<table>
  <thead>
    <tr>
      <th>功能点</th>
      <th>阿里云</th>
      <th>腾讯云</th>
      <th>华为云</th>
      <th>QingCloud</th>
      <th>UCloud</th>
      <th>时速云</th>
      <th>strimzi-kafka-operator</th>
      <th>koperator</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Kafka 实例的生命周期管理</td>
      <td>√</td>
      <td>√</td>
      <td>√</td>
      <td>√</td>
      <td>√</td>
      <td>√</td>
      <td>√</td>
      <td>√</td>
    </tr>
    <tr>
      <td>Kafka 多版本支持</td>
      <td>√ 默认固定，工单调整</td>
      <td>√</td>
      <td>√</td>
      <td>√(仅 1 个)</td>
      <td>√</td>
      <td>√</td>
      <td>√</td>
      <td>√</td>
    </tr>
    <tr>
      <td>Kafka 节点列表</td>
      <td>√</td>
      <td> </td>
      <td>√</td>
      <td> </td>
      <td>√</td>
      <td>跳转 Pod</td>
      <td>√ (能创建 pod)</td>
      <td>√</td>
    </tr>
    <tr>
      <td>Kafka 原生参数管理</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td>√</td>
      <td>√ 原生</td>
      <td>√</td>
      <td>√ 原生</td>
      <td>√</td>
      <td>√</td>
      <td> </td>
    </tr>
    <tr>
      <td>Kafka 常用参数抽象</td>
      <td>√</td>
      <td>√</td>
      <td>√</td>
      <td> </td>
      <td>√</td>
      <td> </td>
      <td>√</td>
      <td>√</td>
    </tr>
    <tr>
      <td>Kafka 模块自带 Zookeeper</td>
      <td>√</td>
      <td>√</td>
      <td>√</td>
      <td> </td>
      <td>√</td>
      <td> </td>
      <td>√</td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>消息查询功能</td>
      <td>√</td>
      <td>√</td>
      <td>√</td>
      <td>√ 原生</td>
      <td> </td>
      <td>√ 原生</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>消息下载功能</td>
      <td>√(高级版）</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>Topic 管理列表</td>
      <td>√</td>
      <td>√</td>
      <td>√</td>
      <td>√ 原生</td>
      <td>√</td>
      <td>√ 原生</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>Topic 增删改查</td>
      <td>√</td>
      <td>√</td>
      <td>√</td>
      <td>√ 原生</td>
      <td>√</td>
      <td>√ 原生</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>Topic 高级参数支持</td>
      <td>√</td>
      <td>√</td>
      <td>√</td>
      <td>√ 原生</td>
      <td>√</td>
      <td>√ 原生</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>Topic 详情</td>
      <td>√</td>
      <td>√</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td>√ 原生</td>
      <td>√</td>
      <td>√ 原生</td>
      <td>√</td>
      <td>√</td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>Consumer Group 列表</td>
      <td>√</td>
      <td>√</td>
      <td> </td>
      <td>√ 原生</td>
      <td> </td>
      <td>√ 原生</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>Consumer Group 增删改查</td>
      <td>√</td>
      <td>√</td>
      <td> </td>
      <td>√ 原生</td>
      <td>√</td>
      <td>√ 原生</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>资源监控看板</td>
      <td>√</td>
      <td>√</td>
      <td> </td>
      <td>√</td>
      <td>√</td>
      <td>√</td>
      <td>√ grafana dashboard</td>
      <td>√ grafana dashboard</td>
    </tr>
    <tr>
      <td>Kafka 业务数据监控 (消息量/积压/消费情况)</td>
      <td>√</td>
      <td>√</td>
      <td>√</td>
      <td> </td>
      <td>√</td>
      <td>√Grafana</td>
      <td>√ exporter+grafana</td>
      <td>√  exporter+grafana</td>
    </tr>
    <tr>
      <td>示例接入代码</td>
      <td>√</td>
      <td>√</td>
      <td>√</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>消息发送测试窗口</td>
      <td>√</td>
      <td>√</td>
      <td>√</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>Kafka 服务日志查看</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>操作审计日志查看</td>
      <td>√</td>
      <td>√</td>
      <td>√</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>提供 Kafka Manager UI</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td>√</td>
      <td> </td>
      <td>√</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>提供 kafka export 备份功能</td>
      <td>√</td>
      <td>√</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>友好性帮助文档</td>
      <td>√</td>
      <td>√</td>
      <td>√</td>
      <td>√</td>
      <td>√</td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>提供帮助用户迁入上云</td>
      <td>√</td>
      <td>√</td>
      <td>√</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
  </tbody>
</table>

<h2 id="kafka-创建过程及开放参数">Kafka 创建过程及开放参数</h2>

<table>
  <thead>
    <tr>
      <th>厂家</th>
      <th>字段</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>阿里云</td>
      <td>名称流量规格集群流量 = 业务流量 + 集群内副本复制流量，该规格实际业务读流量处理峰值为 50 MB/s，业务写流量处理峰值为 10 MB/s。磁盘容量数据默认 3 副本存储。实例规格为标准版时，如购买 300G 磁盘，实际存储业务的磁盘大小为 100G，其余 200G 为备份容量。实例规格为专业版时，如购买 300G 磁盘，实际存储业务的磁盘大小为 300G，额外赠送 600G 备份容量。消息保留最长时间是指在磁盘容量充足的情况下，消息的最长保留时间；在磁盘容量不足（即磁盘水位达到 85%）时，将提前删除旧的消息，以确保服务可用性；默认 72 小时，可选 24 小时 ～ 168 小时。最大消息大小，默认 1MB 边界值？标准版实例单条消息最大为 256KB，专业版实例单条消息最大为 10MB 且支持<strong>下载</strong>Topic 数量</td>
    </tr>
    <tr>
      <td>腾讯云</td>
      <td>名称 Kafka 版本实例规格配置存储容量消息保留时长</td>
    </tr>
    <tr>
      <td>华为云</td>
      <td>名称 Kafka 版本实例规格配置存储容量</td>
    </tr>
    <tr>
      <td>QingCloud</td>
      <td>名称 Kafka 版本 Kafka 节点配置：CPU / 内存  / 节点数（规格）客户端节点配置：CPU / 内存  / 节点数（规格）Kafka-Manager / CLI）Zookeeper 实例存储容量自定义参数配置内部 Topic offset replicasKafka manager 认证 zabbix.agentkafka scale version</td>
    </tr>
    <tr>
      <td>UCloud</td>
      <td>名称 Kafka 版本实例规格配置 + 存储容量实例数 3&lt;设定值&lt;100 消息保留时长</td>
    </tr>
  </tbody>
</table>

<h2 id="基础设计问题">基础设计问题</h2>

<h3 id="部署方式">部署方式？</h3>

<p>DCE5 支持多集群，Kafka 采用 operator 的方式部署，则需要先安装 Operator 模板到集群内</p>

<h3 id="什么时间安装---kafka-operator">什么时间安装   Kafka-operator？</h3>

<p>在用户创建 kafka 实例时，检测是否目标集群是否存在 kafka-operator，如果不存在则同步安装</p>

<blockquote>
  <p>什么时间移除 kafka-operator，默认情况下安装后不移除；交由 Kpanda 对集群释放时处理</p>
</blockquote>

<h3 id="如果支持-kafka-多版本">如果支持 Kafka 多版本？</h3>

<p>通过多版本 对应 多 Kafka-opeator 的方式，让用户进行多版本选择</p>

<h3 id="operator-更新后存量-kafka-怎么办">Operator 更新后，存量 Kafka 怎么办？</h3>

<blockquote>
  <p>非必要需求，短期不支持</p>
</blockquote>

<p>默认情况下更新了 operator 之后，不对存量做处理；后续可以做友好提示用户升级即可</p>

<h2 id="调研对象主要功能截图">调研对象主要功能截图</h2>

<h3 id="阿里云">阿里云</h3>

<h4 id="实例生命周期管理">实例生命周期管理</h4>

<blockquote>
  <p>实例创建</p>
</blockquote>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661307586169-51f50e53-916d-4c22-b365-94403478b2cd.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 10.19.23.jpg" /></p>

<blockquote>
  <p>实例详情</p>
</blockquote>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661307617207-228cff9e-97a2-45df-a072-de9161d99594.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 10.20.05.jpg" /></p>

<h4 id="kafka-topic-管理">Kafka Topic 管理</h4>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661307510049-397d57bc-29e5-4795-83f0-f08a0d91606b.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 10.18.17.jpg" /></p>

<h4 id="kafka-消息查询">Kafka 消息查询</h4>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661307481227-28a5f677-942f-4bee-8a40-f211a0699427.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 10.16.43.jpg" /></p>

<h4 id="监控告警页面">监控告警页面</h4>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661307674273-cd48a1dc-2d56-4ac6-85ba-f7a15e9c977b.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 10.20.49.jpg" /></p>

<h4 id="topic-详情">Topic 详情</h4>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661315257657-3dd43b19-5c83-44a5-8dcf-3a7b00fdde2d.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 12.27.10@2x.jpg" />
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661325524370-2d137783-d065-40cf-b0e1-f758ec574a06.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 15.18.33@2x.jpg" />
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661325542835-025378a0-2813-4d38-a0ad-506012d0b7ec.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 15.18.54@2x.jpg" />
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661325553902-8071ff2d-e5ce-4328-bf30-33be12a1aec0.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 15.19.07@2x.jpg" /></p>

<h4 id="group-管理">Group 管理</h4>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661325583058-974985e4-822b-4229-bf20-7c78e07a5ac7.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 15.19.37.jpg" />
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661325590879-42d393a0-93de-44fe-b71b-de31ce075c09.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 15.19.45@2x.jpg" />
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661325603155-d688fe65-6f4c-4324-9244-854b7a818154.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 15.19.54@2x.jpg" /></p>

<h4 id="prom-监控">Prom 监控</h4>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661323003273-fe3de5cc-28d0-48ab-8ead-38d8ba7b52b1.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 14.28.53.jpg" /></p>

<h3 id="腾讯云">腾讯云</h3>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661325816247-f34749aa-9d99-4a79-9295-108e9f97cbed.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 15.23.24@2x.jpg" /></p>

<h4 id="kafka-实例生命周期管理">Kafka 实例生命周期管理</h4>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661325788285-5a658ef6-092c-40b2-88b8-1317e29b71b4.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 15.22.56@2x.jpg" /></p>

<h4 id="消息查询功能">消息查询功能</h4>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661325835047-bc37c5a0-919b-422a-8706-bcb444171aef.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 15.23.44@2x.jpg" /></p>

<h4 id="数据同步任务">数据同步任务</h4>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661325851682-523521fc-491d-431d-a255-efdaa2c1fa2d.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 15.24.04@2x.jpg" /></p>

<h4 id="迁移上云功能">迁移上云功能</h4>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661325869643-c2bc8a18-17be-406d-891f-fac1348d8072.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 15.24.21@2x.jpg" /></p>

<h4 id="topic-管理">Topic 管理</h4>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661332709528-c073dd8e-8637-4620-831b-59b714fd31ec.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 17.18.06@2x.jpg" />
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661332721004-1c4aae0a-424a-4a40-89de-904f2cc9e021.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 17.18.35@2x.jpg" />
<a href="https://cloud.tencent.com/document/product/597/73566">https://cloud.tencent.com/document/product/597/73566</a></p>

<h4 id="查看-topic-详情">查看 Topic 详情</h4>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661332758035-b38e4bf8-e5e5-4fc6-82ad-72d27a995c05.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 17.19.00@2x.jpg" /></p>

<h4 id="查看-topic-生产端连接">查看 Topic 生产端连接</h4>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661332800322-193f8f5e-b5cf-49d1-830c-a35496a34737.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 17.19.30@2x.jpg" /></p>

<h4 id="发送测试消息">发送测试消息</h4>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661332849948-44c9aa3b-6fcb-42e8-8d07-91ad7dc1108b.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 17.20.13@2x.jpg" /></p>

<h4 id="group-管理-1">Group 管理</h4>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661332888749-197b7cd0-4db2-4324-a8be-523f6230e1d8.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 17.21.06@2x.jpg" />
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661332903130-4aa1572a-2191-4b9a-a7d8-da430d5b664a.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 17.21.36@2x.jpg" /></p>

<h3 id="华为云">华为云</h3>

<h4 id="实例的创建">实例的创建</h4>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661326023773-8c1cfb61-6d36-451a-9ae8-e23253d0630a.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 15.26.48@2x.jpg" />
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661326059316-df094fe7-237e-4aa3-b94c-be9015099325.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 15.27.28@2x.jpg" /></p>

<h4 id="实例基本信息">实例基本信息</h4>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661327087509-8db8e907-fc63-46b0-8df3-de9c03f05ec1.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 15.44.29@2x.jpg" /></p>

<h4 id="实例配置修改">实例配置修改</h4>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661326942939-93255eb4-0f4f-4d09-b4f7-c824fe2cdb7d.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 15.42.03@2x.jpg" /></p>

<h4 id="创建-topic">创建 Topic</h4>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661326884381-03f190c8-7371-4ee3-8222-39cf0c78bb17.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 15.41.07@2x.jpg" /></p>

<h4 id="监控">监控</h4>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661326916095-08d2ad76-421b-481c-a81e-8bd6b402fea3.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 15.41.43@2x.jpg" />
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661326990347-ab2413fc-d1c5-4875-8026-408ba05c19e0.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 15.43.01@2x.jpg" />
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661327009996-7525be7c-31e7-4c94-9b88-9a9d6c06f6bb.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 15.43.16@2x.jpg" />
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661327029319-18496da6-1f6c-458e-9cc2-2841da4ae21b.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 15.43.40@2x.jpg" />
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661327041939-b6642928-ddb3-4f6d-9cf6-f900ff0ba7ee.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 15.43.56@2x.jpg" /></p>

<h4 id="示例代码">示例代码</h4>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661327057619-5dbb3d4b-d6b8-40ec-a528-8b87e6253d62.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 15.44.07@2x.jpg" /></p>

<h3 id="qingcloud">QingCloud</h3>

<h4 id="kafka-实例的创建">Kafka 实例的创建</h4>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661327953531-4347c195-85b1-4284-90c9-71b2f658d20a.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 15.59.07@2x.jpg" />
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661327970196-df7533af-51b5-44c1-a3e6-dc53dd345165.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 15.59.23@2x.jpg" />
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661327978746-cde36af3-af9d-4818-a225-0435be7d8c70.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 15.59.33@2x.jpg" />
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661327989141-65ba9381-c39d-4df4-b35f-eb30c2c0f117.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 15.59.43@2x.jpg" /></p>

<blockquote>
  <p>创建时，需要关联依赖服务 zookeeper</p>
</blockquote>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661327998858-3c6af065-aac1-4351-8e7a-3a72c803ee36.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 15.59.51@2x.jpg" /></p>

<h4 id="实例详情">实例详情</h4>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661328648427-68359d73-3397-4f51-a41e-72ff088aa1da.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 16.10.36@2x.jpg" /></p>

<h4 id="topic-管理-1">Topic 管理</h4>

<p>提供了原生的 Kafka-manager 管理 UI
<a href="https://docsv3.qingcloud.com/middware/kafka/manual/kafka_manager/kafka_manager_topic/">https://docsv3.qingcloud.com/middware/kafka/manual/kafka_manager/kafka_manager_topic/</a></p>

<p>访问方式，以 openvpn 的方式接入到 VPC(需绑定入口公网 IP) 后，通过 client 内网地址访问
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661335030256-d6d8f4ce-5450-4675-9887-d91bfc43261e.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 17.57.01@2x.jpg" /></p>

<h3 id="ucloud">UCloud</h3>

<h4 id="创建实例">创建实例</h4>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661329936765-dc801f1f-b820-4346-8cd5-bd16f22c933b.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 16.32.07@2x.jpg" /></p>

<h4 id="kafka-实例详情">Kafka 实例详情</h4>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661330180680-64f2f85d-65b1-429b-a9c2-0d4a3b7e7057.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 16.36.01@2x.jpg" />
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661330194590-e638d644-6d73-4008-9e73-fbd9386a739c.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 16.36.29@2x.jpg" />
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661330211435-8ac8d8e4-fa63-4151-a3c4-6cd85c346c2c.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 16.36.41@2x.jpg" />
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661330224056-a5b18cfb-21d8-44ab-aa10-2ec8b3225ad8.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 16.36.55@2x.jpg" /></p>

<h4 id="kafka-节点的详情页面">Kafka 节点的详情页面</h4>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661331042096-143c7a92-3189-4413-b0f8-59c2e6480eb4.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 16.50.34@2x.jpg" />
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661330392867-c7609d4a-72bd-45e6-b741-943c2c7711fd.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 16.39.28@2x.jpg" /></p>

<h4 id="kafka-自定义配置">kafka 自定义配置</h4>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661331022340-2de4f944-dd32-42ea-a0ab-538044f96ab7.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 16.50.13@2x.jpg" /></p>

<h4 id="kafka-连接器">Kafka 连接器</h4>

<p>将上游 Kafka 数据传输到 HDFS 或者 es
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661331196868-8af6eb6f-7690-49f8-83fa-f39297820c5f.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 16.53.11@2x.jpg" />
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661331184528-87b97468-042b-479b-9051-6a49838280a2.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 16.52.58@2x.jpg" />
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661331174214-c2788e65-e3a2-4080-b275-73b30ac6ed3c.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 16.52.43@2x.jpg" /></p>

<h4 id="监控看板">监控看板</h4>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661330312396-375635d6-015b-447a-88c2-e5c2ad51de23.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 16.38.11@2x.jpg" /></p>

<h4 id="创建-topic-1">创建 Topic</h4>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661331056766-ea9a2a74-12bd-482a-b77c-e375e9e0bb45.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 16.50.50@2x.jpg" />
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661330340573-54024fe3-75fe-4dfb-b322-a0f157e369bf.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 16.38.45@2x.jpg" />
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661331099713-b943c976-ca08-4769-a4dc-710c92d899a2.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 16.51.29@2x.jpg" />
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661331073008-7df8b7f5-b92b-41a2-8c7f-74cc29071bc8.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 16.51.05@2x.jpg" /></p>

<h3 id="时速云">时速云</h3>

<h4 id="实例生命周期管理-1">实例生命周期管理</h4>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661331586127-3cd1e00a-fbed-4454-aea2-14e3bf95c393.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 16.59.24@2x.jpg" /></p>

<ul>
  <li>需要提前安装 zookeeper</li>
  <li>需要联系时速云管理员安装 kafka-cluster-operator
    <ul>
      <li>到交付中心，找到 Operator Hub，选择 Kafka-cluster-operator 安装</li>
      <li>安装完成后，可通过 Yaml + 表单形式 创建 Kafka</li>
    </ul>
  </li>
  <li>提供 Kafka manger 原生 UI 控制台</li>
</ul>

<h4 id="kafka-实例详情-1">Kafka 实例详情</h4>

<p>提供原生的实例管理界面，进行配置更新等
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661334983034-f068a1ae-ccda-40b7-9b12-40e64bde24cc.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 17.56.16@2x.jpg" />
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661334441012-bb78b74e-4c95-4679-a25b-52ace6645dd0.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 17.47.02@2x.jpg" /></p>

<h4 id="kafka-实例下节点信息">Kafka 实例下节点信息</h4>

<p>直接跳转到 K8s 容器组界面查看
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661334844501-fd53ecb8-9194-477e-ba99-690950d32ac2.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 17.53.57@2x.jpg" /></p>

<h4 id="topic-管理-2">Topic 管理</h4>

<p>在 Kafka manger 原生 UI 控制台内管理，默认启用了控制台公网访问能力
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661335035163-a487b30d-6938-4cfb-88a7-5ebbf08a4d02.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 17.57.01@2x.jpg" /></p>

<h4 id="实例资源监控">实例资源监控</h4>

<p>基础 CPU、内存、网络、存储监控
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661334944904-59442083-e24e-4776-8e4b-3683c27e279e.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 17.55.38@2x.jpg" /></p>

<h4 id="kafka-性能监控">Kafka 性能监控</h4>

<p>接入 Grafana 提供一个 Dashboard 的，可以查看 Topics 的消息数，消费量，积压数
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661334965612-08293584-95c6-4220-b4e5-dcdfe2db44e1.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 17.55.57@2x.jpg" /></p>

<h2 id="调研对象操作视频录制">调研对象操作视频录制</h2>

<p>操作视频已上传到 OneDrive 共享空间</p>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1661337926424-23d5d513-4080-4f36-af59-2bda413eb905.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-08-24 at 18.45.08@2x.jpg" /></p>

<p><a href="https://yongyu2000hotmailcom.sharepoint.cn/:f:/s/ndx/EuCYqMaXhdlPh411YVnihRQBmCbGLQ4BvU1QW_2DX7_uUQ?e=18NyTR">https://yongyu2000hotmailcom.sharepoint.cn/:f:/s/ndx/EuCYqMaXhdlPh411YVnihRQBmCbGLQ4BvU1QW_2DX7_uUQ?e=18NyTR</a></p>

<blockquote>
  <p>腾讯云只可以按月份订购，所以没有录制视频。</p>
</blockquote>

<h2 id="选型确认">选型确认</h2>

<p>方案一：</p>

<ul>
  <li>中间件实例 LCM + 三方 UI 管理工具</li>
</ul>

<p>实现：</p>

<ul>
  <li>Kafka 实例 LCM</li>
  <li>Kafka Manage UI (三方)</li>
  <li>监控三件套 (Insight) [只需要做实例级别]</li>
</ul>

<p>方案比对：</p>

<ul>
  <li>现有 Opeator 不带 Kafka Manger，需要自行处理</li>
  <li>不需要关心 Topic LCM</li>
  <li>不需要做业务监控</li>
  <li>沿用现有的 DCE 中间件的设计思路</li>
</ul>

<p>方案二：</p>

<ul>
  <li>不增加三方 Kafka Manage UI</li>
</ul>

<p>实现：</p>

<ul>
  <li>Kafka 实例 LCM</li>
  <li>Topic LCM</li>
  <li>监控三件套 (Insight) [需要做实例 + 业务监控]</li>
</ul>

<p>方案对比：</p>

<ul>
  <li>现有 Operator 带有 Topic CR，可以用</li>
  <li>需要做业务监控</li>
  <li>需要做 Topic LCM</li>
  <li>与其他中间件模块定义不一致（当前阶段）</li>
</ul>

      
    </div>
    <br/>
    <div>
      <cite>2022-09-27</cite> <i class="icon-tag"></i>
      <a href="/tags.html#Kafka">Kafka</a>
      
      
      
    </div>
    <div style="clear: both;"></div>
    <hr/>
    
    
    <h1><a class="title" href="/post/2022/09/Poetry-%E4%BD%BF%E7%94%A8%E7%AC%94%E8%AE%B0.html">Poetry 使用笔记</a></h1>
    <div class="post_at_index">
      <p>poetry 是目前比较流行的 Python 环境管理工具 和 包管理工具，对多项目开发时的环境隔离有非常大的帮助，同时集成了包管理能力。</p>

<blockquote>
  <p>官方网站  <a href="https://python-poetry.org/">https://python-poetry.org/</a>   集成了所有 Poetry 最新的使用文档，以下仅在我的环境上经过验证</p>
</blockquote>

<h3 id="安装方式">安装方式</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># In Pip
</span><span class="o">-</span> <span class="n">安装</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">poetry</span> <span class="c1"># pip3
</span><span class="o">-</span> <span class="n">更新</span> <span class="n">poetry</span> <span class="bp">self</span> <span class="n">update</span>

<span class="c1"># In my Mac
</span><span class="o">-</span> <span class="n">安装</span> <span class="n">brew</span> <span class="n">install</span> <span class="n">poetry</span>
<span class="o">-</span> <span class="n">更新</span> <span class="n">brew</span> <span class="n">upgrade</span> <span class="n">poetry</span>

<span class="c1"># In my CentOS
</span><span class="o">-</span> <span class="n">安装</span> <span class="n">curl</span> <span class="o">-</span><span class="n">sSL</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="p">.</span><span class="n">githubusercontent</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">python</span><span class="o">-</span><span class="n">poetry</span><span class="o">/</span><span class="n">poetry</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">get</span><span class="o">-</span><span class="n">poetry</span><span class="p">.</span><span class="n">py</span> <span class="o">|</span> <span class="n">python</span> <span class="o">-</span>
<span class="o">-</span> <span class="n">更新</span> <span class="n">poetry</span> <span class="bp">self</span> <span class="n">update</span>
</code></pre></div></div>

<h3 id="配置技巧相关">配置技巧相关</h3>

<p>在开始使用前，建议先对 poetry 的配置有些了解，并调整为适合你的方式，主要是调整一下虚拟环境的安装位置
:::info
<code class="language-plaintext highlighter-rouge">poetry config</code> poetry 相关的查看和编辑的命令
:::</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">~</span> <span class="n">poetry</span> <span class="n">config</span> <span class="o">--</span><span class="nb">list</span>  <span class="c1"># 获取当前 poetry 的配置情况
</span>
<span class="n">cache</span><span class="o">-</span><span class="nb">dir</span> <span class="o">=</span> <span class="s">"/Users/$username/Library/Caches/pypoetry"</span>
<span class="n">experimental</span><span class="p">.</span><span class="n">new</span><span class="o">-</span><span class="n">installer</span> <span class="o">=</span> <span class="n">true</span>
<span class="n">installer</span><span class="p">.</span><span class="n">parallel</span> <span class="o">=</span> <span class="n">true</span>
<span class="n">virtualenvs</span><span class="p">.</span><span class="n">create</span> <span class="o">=</span> <span class="n">true</span>
<span class="n">virtualenvs</span><span class="p">.</span><span class="ow">in</span><span class="o">-</span><span class="n">project</span> <span class="o">=</span> <span class="n">true</span>
<span class="n">virtualenvs</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="s">"{cache-dir}/virtualenvs"</span>  <span class="c1"># /Users/$username/Library/Caches/pypoetry/virtualenvs
</span>
</code></pre></div></div>

<p>| <strong>配置项目</strong> | <strong>配置内容</strong> | <strong>配置项说明</strong> | <strong>建议配置</strong> |
| — | — | — | — |
| cache-dir | String | 缓存目录配置，使用 poetry 安装的包源文件都会缓存到这个目录。 | 不建议更改 |
| installer.parallel | boolean | 此配置会被忽略 |  |
| virtualenvs.create | boolean | 默认为 true，如果当前工程的虚拟环境不存在，就创建一个 | 不建议更改 |
| virtualenvs.in-project | boolean | None：poetry 会在系统特定目录创建一个.venv 目录，由下面的 path 参数指定
true：poetry 会在项目根目录创建一个.venv 目录
false：poetry 将会忽略已存在的.venv 目录 | <strong>《建议修改》</strong></p>

<table>
  <tbody>
    <tr>
      <td>推荐这种方式，在项目根目录创建虚拟环境，这样就算移动目录位置也不影响虚拟环境的使用</td>
      <td> </td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td> </td>
      <td>virtualenvs.path</td>
      <td>string</td>
      <td>默认是{cache-dir}/virtualenvs，虚拟环境创建的目录，如果上面的 in-project 为 true，此配置就无效</td>
      <td>不建议更改</td>
    </tr>
  </tbody>
</table>

<p>:::danger
建议 在使用前 启用 virtualenvs.in-project，这样会在每个项目下有一个.venv 方便隔离管理
:::</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># poetry 配置说明
</span><span class="n">poetry</span> <span class="n">config</span> <span class="n">virtualenvs</span><span class="p">.</span><span class="ow">in</span><span class="o">-</span><span class="n">project</span> <span class="n">true</span>
</code></pre></div></div>

<h3 id="poetry-常用指令说明">poetry 常用指令说明</h3>

<table>
  <thead>
    <tr>
      <th><strong>Poetry Command</strong></th>
      <th><strong>解释</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>$ poetry –version</td>
      <td>显示您的 Poetry 安装版本。</td>
    </tr>
    <tr>
      <td>$ poetry new</td>
      <td>创建一个新的 Poetry 项目。</td>
    </tr>
    <tr>
      <td>$ poetry init</td>
      <td>将 Poetry 添加到现有项目中。</td>
    </tr>
    <tr>
      <td>$ poetry run</td>
      <td>使用 Poetry 执行给定的命令。</td>
    </tr>
    <tr>
      <td>$ poetry add</td>
      <td>添加一个包 pyproject.toml 并安装它。</td>
    </tr>
    <tr>
      <td>$ poetry update</td>
      <td>更新项目的依赖项。</td>
    </tr>
    <tr>
      <td>$ poetry install</td>
      <td>安装依赖项。</td>
    </tr>
    <tr>
      <td>$ poetry show</td>
      <td>列出已安装的软件包。</td>
    </tr>
    <tr>
      <td>$ poetry lock</td>
      <td>将最新版本的依赖项固定到 poetry.lock.</td>
    </tr>
    <tr>
      <td>$ poetry lock –no-update</td>
      <td>刷新 poetry.lock 文件而不更新任何依赖版本。</td>
    </tr>
    <tr>
      <td>$ poetry check</td>
      <td>验证 pyproject.toml。</td>
    </tr>
    <tr>
      <td>$ poetry config –list</td>
      <td>显示 Poetry 配置。</td>
    </tr>
    <tr>
      <td>$ poetry env list</td>
      <td>列出项目的虚拟环境。</td>
    </tr>
    <tr>
      <td>$ poetry export</td>
      <td>导出 poetry.lock 为其他格式。</td>
    </tr>
  </tbody>
</table>

<h3 id="新项目初始化流程">新项目初始化流程</h3>

<blockquote>
  <p>这里以 初始化一个  FastAPI 项目作为 实例</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  fastapi poetry new fastapi-demo
Created package fastapi_demo <span class="k">in </span>fastapi-demo
➜  fastapi <span class="nb">ls</span> <span class="nt">-lh</span> fastapi-demo
total 8
<span class="nt">-rw-r--r--</span>  1 samzonglu  staff     0B  2 15 14:28 README.rst
drwxr-xr-x  3 samzonglu  staff    96B  2 15 14:28 fastapi_demo
<span class="nt">-rw-r--r--</span>  1 samzonglu  staff   304B  2 15 14:28 pyproject.toml
drwxr-xr-x  4 samzonglu  staff   128B  2 15 14:28 tests

➜  fastapi <span class="nb">cd </span>fastapi-demo
➜  fastapi-demo poetry <span class="nb">env </span>use 3.10.2  <span class="c"># 配置项目的虚拟环境</span>

</code></pre></div></div>

<h3 id="requirementstxt-已存在项目使用-poetry">requirements.txt 已存在项目使用 poetry</h3>

<p>这里会遇到一个问题，已存在的项目基本都已经有了 requirements.txt，所以 poetry 最好可以直接读取它</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>poetry add <span class="sb">`</span><span class="nb">cat </span>requirements.txt<span class="sb">`</span>
</code></pre></div></div>

<p>将项目依赖导出为  requirements.txt</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>poetry <span class="nb">export</span> <span class="nt">--output</span> requirements.txt
</code></pre></div></div>

<h2 id="更新内容">更新内容</h2>

<p>如何把项目移交给一个 not use Poetry 的人运行，对于 Python 的 环境包 依赖，上述的 ouput/input 的方式，会存在一些问题，这里进行纠正。</p>

<h3 id="问题-pip-freeze-不能用了">问题 pip freeze 不能用了</h3>

<p>:::warning
pip freeze &gt; requirements.txt
:::</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>anyio @ file:///Users/samzonglu/Library/Caches/pypoetry/artifacts/cd/3f/ae/baff749ce6cb4d7985e4142650605d2d30cb92eb418e2d121868e4413d/anyio-3.6.1-py3-none-any.whl
certifi @ file:///Users/samzonglu/Library/Caches/pypoetry/artifacts/b1/9b/6f/cd63ce97294ee9a1fb57e5cebf02f251fbb8f9ac48353a27ceeddc410b/certifi-2022.6.15-py3-none-any.whl
charset-normalizer @ file:///Users/samzonglu/Library/Caches/pypoetry/artifacts/86/c8/3e/d878881698fbd2b72f484e4fca340588d633102920a002b66a293f9480/charset_normalizer-2.1.0-py3-none-any.whl
click @ file:///Users/samzonglu/Library/Caches/pypoetry/artifacts/63/f3/4c/2270b95f4d37b9ea73cd401abe68b6e9ede30380533cd4e7118a8e3aa3/click-8.1.3-py3-none-any.whl
fastapi @ file:///Users/samzonglu/Library/Caches/pypoetry/artifacts/f9/37/53/c998e9ffd7ace66218174711f5c3ef1026a0bd3cd72f5fe2908e9b949b/fastapi-0.78.0-py3-none-any.whl
h11 @ file:///Users/samzonglu/Library/Caches/pypoetry/artifacts/ef/5c/a2/a6d556bc5e3493616e52726df9c880b2da2fbf9c3be5e8351c84fbfafd/h11-0.13.0-py3-none-any.whl
idna @ file:///Users/samzonglu/Library/Caches/pypoetry/artifacts/90/36/8c/81eabf6ac88608721ab27f439c9a6b9a8e6a21cc58c59ebb1a42720199/idna-3.3-py3-none-any.whl
pydantic @ file:///Users/samzonglu/Library/Caches/pypoetry/artifacts/c2/13/d4/b9f7dbf75702d85504b4a5f36545ff903c7e2264d4889e94ce02637276/pydantic-1.9.1-cp310-cp310-macosx_11_0_arm64.whl
requests @ file:///Users/samzonglu/Library/Caches/pypoetry/artifacts/14/1f/4d/1b93db6513b8ab38db841e4ce62691288ba549a5c1b6f3ca7274a1c9fd/requests-2.28.1-py3-none-any.whl
sniffio @ file:///Users/samzonglu/Library/Caches/pypoetry/artifacts/2b/1b/93/9c34d727e29f7bb11ce5b2ca7f43e77cb4e96a81ee5e07a92763951416/sniffio-1.2.0-py3-none-any.whl
starlette @ file:///Users/samzonglu/Library/Caches/pypoetry/artifacts/3d/fc/74/569a1206737284325f5bb2e4f34689632c159dafbe8b7ff30bf2893c2d/starlette-0.19.1-py3-none-any.whl
typing_extensions @ file:///Users/samzonglu/Library/Caches/pypoetry/artifacts/4a/aa/fe/e4680f3423fbdb5ac89a6fb2f83d9e7ff7fb48173b0fa1604786182558/typing_extensions-4.3.0-py3-none-any.whl
urllib3 @ file:///Users/samzonglu/Library/Caches/pypoetry/artifacts/8a/87/ce/4a44bf6bb59a745f4af7082c6977ab23a478fca039ad4d631dfdc0185b/urllib3-1.26.10-py2.py3-none-any.whl
uvicorn @ file:///Users/samzonglu/Library/Caches/pypoetry/artifacts/62/76/ec/dcafe6bae872839618dbf982c87eb314eee97784f7df74895e07bd198a/uvicorn-0.18.2-py3-none-any.whl
</code></pre></div></div>

<p>可以看到，默认情况下<code class="language-plaintext highlighter-rouge">pip freeze</code>在输出时，携带里对应的安装路径；如果这个时候，我们把项目移交给其他人运行时，会遇到以下问题</p>

<blockquote>
  <p>ERROR: Could not install packages due to an EnvironmentError: [Errno 2] No such</p>
</blockquote>

<p>这是 pip 安装软件包的一种特殊语法（自 19.1 开始受支持）<a href="https://www.python.org/dev/peps/pep-0440/#direct-references">PEP404</a>，
但是该此种路径取决于环境，file:///URL 仅在本地文件系统上可用，你不能将生成的 requirements.txt 文件提供给其他人使用</p>

<h3 id="先说解决方法-01-poetry-style">先说解决方法 01 [poetry style]</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>poetry <span class="nb">export</span> <span class="nt">--without-hashes</span> <span class="nt">--format</span><span class="o">=</span>requirements.txt <span class="o">&gt;</span> requirements.txt
</code></pre></div></div>

<p>通过 poetry 自带的导出能力，会携带更多的一些信息：对于环境中 python 版本的依赖，虽然更加友好一些。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">anyio</span><span class="o">==</span>3.6.1<span class="p">;</span> python_full_version <span class="o">&gt;=</span> <span class="s2">"3.6.2"</span>
<span class="nv">certifi</span><span class="o">==</span>2022.6.15<span class="p">;</span> python_version <span class="o">&gt;=</span> <span class="s2">"3.6"</span>
charset-normalizer<span class="o">==</span>2.1.0<span class="p">;</span> python_full_version <span class="o">&gt;=</span> <span class="s2">"3.6.0"</span>
<span class="nv">click</span><span class="o">==</span>8.1.3<span class="p">;</span> python_version <span class="o">&gt;=</span> <span class="s2">"3.7"</span>
<span class="nv">colorama</span><span class="o">==</span>0.4.5<span class="p">;</span> python_version <span class="o">&gt;=</span> <span class="s2">"3.7"</span> and python_full_version &lt; <span class="s2">"3.0.0"</span> and platform_system <span class="o">==</span> <span class="s2">"Windows"</span> or platform_system <span class="o">==</span> <span class="s2">"Windows"</span> and python_version <span class="o">&gt;=</span> <span class="s2">"3.7"</span> and python_full_version <span class="o">&gt;=</span> <span class="s2">"3.5.0"</span>
<span class="nv">fastapi</span><span class="o">==</span>0.78.0<span class="p">;</span> python_full_version <span class="o">&gt;=</span> <span class="s2">"3.6.1"</span>
<span class="nv">h11</span><span class="o">==</span>0.13.0<span class="p">;</span> python_version <span class="o">&gt;=</span> <span class="s2">"3.6"</span>
<span class="nv">idna</span><span class="o">==</span>3.3<span class="p">;</span> python_version <span class="o">&gt;=</span> <span class="s2">"3.5"</span>
<span class="nv">pydantic</span><span class="o">==</span>1.9.1<span class="p">;</span> python_full_version <span class="o">&gt;=</span> <span class="s2">"3.6.1"</span>
<span class="nv">requests</span><span class="o">==</span>2.28.1<span class="p">;</span> python_version <span class="o">&gt;=</span> <span class="s2">"3.7"</span> and python_version &lt; <span class="s2">"4"</span>
<span class="nv">sniffio</span><span class="o">==</span>1.2.0<span class="p">;</span> python_version <span class="o">&gt;=</span> <span class="s2">"3.5"</span>
<span class="nv">starlette</span><span class="o">==</span>0.19.1<span class="p">;</span> python_version <span class="o">&gt;=</span> <span class="s2">"3.6"</span>
typing-extensions<span class="o">==</span>4.3.0<span class="p">;</span> python_version <span class="o">&gt;=</span> <span class="s2">"3.7"</span>
<span class="nv">urllib3</span><span class="o">==</span>1.26.10<span class="p">;</span> <span class="o">(</span>python_version <span class="o">&gt;=</span> <span class="s2">"2.7"</span> and python_full_version &lt; <span class="s2">"3.0.0"</span><span class="o">)</span> or <span class="o">(</span>python_full_version <span class="o">&gt;=</span> <span class="s2">"3.6.0"</span> and python_version &lt; <span class="s2">"4"</span><span class="o">)</span>
<span class="nv">uvicorn</span><span class="o">==</span>0.18.2<span class="p">;</span> python_version <span class="o">&gt;=</span> <span class="s2">"3.7"</span>
</code></pre></div></div>

<h3 id="再说解决方法-02">再说解决方法 02</h3>

<p>在新版的 python 中，推荐采用另外一个命令方式，<code class="language-plaintext highlighter-rouge">pip list --format=freeze</code> 这样会输出一份干净的依赖清单，我们可以通过这个方式，快速导出一份 <code class="language-plaintext highlighter-rouge">原汁原味</code> 的 requirements.txt</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>poetry run pip list <span class="nt">--format</span><span class="o">=</span>freeze
<span class="nv">anyio</span><span class="o">==</span>3.6.1
<span class="nv">certifi</span><span class="o">==</span>2022.6.15
charset-normalizer<span class="o">==</span>2.1.0
<span class="nv">click</span><span class="o">==</span>8.1.3
<span class="nv">fastapi</span><span class="o">==</span>0.78.0
<span class="nv">h11</span><span class="o">==</span>0.13.0
<span class="nv">idna</span><span class="o">==</span>3.3
<span class="nv">pip</span><span class="o">==</span>22.2
<span class="nv">pydantic</span><span class="o">==</span>1.9.1
<span class="nv">requests</span><span class="o">==</span>2.28.1
<span class="nv">setuptools</span><span class="o">==</span>62.6.0
<span class="nv">sniffio</span><span class="o">==</span>1.2.0
<span class="nv">starlette</span><span class="o">==</span>0.19.1
<span class="nv">typing_extensions</span><span class="o">==</span>4.3.0
<span class="nv">urllib3</span><span class="o">==</span>1.26.10
<span class="nv">uvicorn</span><span class="o">==</span>0.18.2
<span class="nv">wheel</span><span class="o">==</span>0.37.1
</code></pre></div></div>

<h3 id="补充安装来自于-requirementstxt-的方式">补充安装来自于 requirements.txt 的方式</h3>

<blockquote>
  <p>with poetry</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>requirements.txt | xargs poetry add
</code></pre></div></div>

<blockquote>
  <p>without poetry</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt
</code></pre></div></div>

      
    </div>
    <br/>
    <div>
      <cite>2022-09-22</cite> <i class="icon-tag"></i>
      <a href="/tags.html#Python">Python</a>
      
      
      
    </div>
    <div style="clear: both;"></div>
    <hr/>
    
    
    <h1><a class="title" href="/post/2022/09/Skoala-%E9%83%A8%E7%BD%B2%E6%95%99%E7%A8%8B.html">Skoala 部署教程</a></h1>
    <div class="post_at_index">
      <h2 id="使用之前的话">使用之前的话</h2>

<p>Skoala 的微服务治理和微服务是强依赖的 Ghippo、Insight 和 Kpanda 作为基石；同时 Skoala 也支持了 Mesh 服务治理能力，所以也需要 Mspider。
为了保证良好的使用体验，以及减少不可预知的部署问题，请确认以上组件均可正常工作。</p>

<h3 id="检测方式一">检测方式一</h3>

<p>访问 UI 界面环境，可以在左侧导航栏能够正确看到所有模块，并且可以正常使用。
<img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1662545276376-f34d4b1d-e736-4552-b873-83421c7a70e8.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-09-07 at 18.07.42@2x.jpg" /></p>

<h3 id="检测方式二">检测方式二</h3>

<p>通过终端查看集群内的 apiserver 是否正常，检查服务 Pod 是否正常运行</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 检测 ghippo</span>
~ kubectl <span class="nt">-n</span> ghippo-system get pods | egrep <span class="s2">"apiserver|ui"</span>
ghippo-apiserver-589c4ddcf6-cmct7              3/3     Running     0          17h
ghippo-apiserver-589c4ddcf6-sts8t              3/3     Running     0          17h
ghippo-ui-7ddddc548c-nsbkj                     2/2     Running     0          94m


<span class="c"># 检查 kpanda</span>
~ kubectl <span class="nt">-n</span> kpanda-system get pods | egrep <span class="s2">"apiserver|ui"</span>
kpanda-apiserver-695b76f476-kdb8l                                 2/2     Running     0          5m56s
kpanda-apiserver-695b76f476-mvllg                                 2/2     Running     0          7m51s
kpanda-clusterpedia-apiserver-574d49c4c-hptm7                     2/2     Running     0          74m
kpanda-clusterpedia-apiserver-574d49c4c-mjm84                     2/2     Running     0          74m
kpanda-ui-5f9586d49b-f4mn2                                        2/2     Running     0          66m
kpanda-ui-5f9586d49b-qpgwd                                        2/2     Running     0          66m


<span class="c"># 检查 Insight</span>
~ kubectl <span class="nt">-n</span> insight-system get pods | egrep <span class="s2">"server|ui"</span>
insight-server-5bbc96bb94-n2wc7                                1/1     Running   0          174m
insight-ui-66b6795c44-zm6qj                                    1/1     Running   0          3h38m


<span class="c"># 检查 mspider</span>
~ kubectl <span class="nt">-n</span> mspider-system get pods | egrep <span class="s2">"api|ui"</span>
mspider-api-service-7d96c6798-mljst       2/2     Running   0          3h20m
mspider-ui-6f5d58cdc6-59hbn               2/2     Running   0          170m
mspider-work-api-684b75dccb-4659g         2/2     Running   0          3h20m
</code></pre></div></div>

<h2 id="配置-skoala-helm-repo">配置 skoala helm repo</h2>

<p>配置好 skoala 仓库，即可查看和获取到 skoala 的应用 chart</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm repo add skoala-release https://release.daocloud.io/chartrepo/skoala
helm repo update
</code></pre></div></div>

<blockquote>
  <p>需要实现安装 Helm</p>
</blockquote>

<h2 id="安装依赖-mysql">安装依赖 mysql</h2>

<p>在安装 skoala 的组件时，hive 和 sesame 需要用到 mysql 组件，所以这里需要预先安装一下 mysql，执行下方 yaml。</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 使用如下命令</span>
<span class="s">kubectl -n skoala-system apply -f skoala-mysql.yml</span>
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 保存到 skoala-mysql.yml 文件</span>

<span class="s">~ cat skoala-mysql.yml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">skoala-mysql</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">skoala-system</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">3306</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">mysql</span>
  <span class="na">clusterIP</span><span class="pi">:</span> <span class="s">None</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">skoala-mysql</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">skoala-system</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">mysql</span>
  <span class="na">strategy</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">Recreate</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">mysql</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">release.daocloud.io/skoala/mysql:5.7.32</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">mysql</span>
        <span class="na">env</span><span class="pi">:</span>
          <span class="c1"># Use secret in real usage</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">MYSQL_ROOT_PASSWORD</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">password</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">3306</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">mysql</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">mysql-persistent-storage</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/var/lib/mysql</span>
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">mysql-persistent-storage</span>
        <span class="na">persistentVolumeClaim</span><span class="pi">:</span>
          <span class="na">claimName</span><span class="pi">:</span> <span class="s">mysql-pv-claim</span>
</code></pre></div></div>

<ul>
  <li>注意修改以上，mysql 的密码。</li>
</ul>

<h3 id="初始化-mysql">初始化 mysql</h3>

<p>登录到 pod 内，并成功登录到 mysql 内</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">kubectl -n skoala-system exec pods/`kubectl -n skoala-system get pods | grep skoala-mysql | awk '{print $1}'` -it bash</span>
</code></pre></div></div>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1662548094736-0d938b21-7991-426b-a0b0-9aa19a2d357a.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="CleanShot 2022-09-07 at 18.54.47@2x.jpg" /></p>

<p>初始化数据库表</p>

<ul>
  <li>获取到 mysql 的初始化脚本文件，<a href="https://gitlab.daocloud.cn/ndx/skoala/-/tree/main/app/hive/db">https://gitlab.daocloud.cn/ndx/skoala/-/tree/main/app/hive/db</a></li>
  <li>依次查看对应的文件，并放在 mysql 中执行</li>
</ul>

<p>注意把对应的版本，建议使用最新的版本，这里建议  v0.6.1</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm upgrade <span class="nt">--install</span> skoala <span class="nt">--create-namespace</span> <span class="nt">-n</span> skoala-system <span class="nt">--cleanup-on-fail</span> <span class="se">\</span>
<span class="nt">--set</span> image.tag<span class="o">=</span>v0.6.1 <span class="se">\</span>
skoala/skoala-agent <span class="se">\</span>
<span class="nt">--version</span> 0.6.1
</code></pre></div></div>

<p>这里会将资源部署到 skoala-system 命名空间内，可以通过查看该命名空间内的资源来查看是否部署成功。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>~ kubectl <span class="nt">-n</span> skoala-system get pods
NAME                           READY   STATUS    RESTARTS         AGE
hive-96b58785c-shhnh           0/1     Running   0                23h
sesame-cdd894f74-l55hw         0/1     Running   0                23h
ui-7df9754f85-v2gg5            1/1     Running   0                23h
</code></pre></div></div>

<h2 id="安装-skoala">安装 Skoala</h2>

<h3 id="查看-skaola-当前最新版本">查看 skaola 当前最新版本</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>helm search repo skoala-release/skoala <span class="nt">--versions</span>
NAME                CHART VERSION APP VERSION DESCRIPTION
skoala-release/skoala       0.6.1         0.6.1       The helm chart <span class="k">for </span>Skoala
skoala-release/skoala       0.6.0         0.6.0       The helm chart <span class="k">for </span>Skoala
skoala-release/skoala       0.5.1         0.5.1       The helm chart <span class="k">for </span>Skoala
</code></pre></div></div>

<h3 id="执行部署">执行部署</h3>

<p>这里注意各个组件的版本，建议安装如下版本，直接执行命令即可，【在 demo 部署时】</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">helm upgrade --install skoala --create-namespace -n skoala-system --cleanup-on-fail \</span>
<span class="s">--set ui.image.tag=v0.5.3 \</span>
<span class="s">--set hive.image.tag=v0.6.1 \</span>
<span class="s">--set sesame.image.tag=v0.6.1 \</span>
<span class="s">daocloud-registry/skoala \</span>
<span class="s">--version 0.6.1</span>
</code></pre></div></div>

<p>查看部署的 pod 是否启动成功</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">~ kubectl -n skoala-system get pods</span>
<span class="s">NAME                           READY   STATUS             RESTARTS          AGE</span>
<span class="s">hive-96b58785c-shhnh           1/1     Running            0                 25h</span>
<span class="s">sesame-cdd894f74-l55hw         1/1     Running            0                 25h</span>
<span class="s">skoala-mysql-75dc5cfc7-99tbs   1/1     Running            0                 25h</span>
<span class="s">ui-7df9754f85-v2gg5            1/1     Running            0                 23h</span>
</code></pre></div></div>

<h3 id="卸载">卸载</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">helm uninstall skoala -n skoala-system</span>
</code></pre></div></div>

<h3 id="更多参数的配置">更多参数的配置</h3>

<table>
  <thead>
    <tr>
      <th><strong>Key</strong></th>
      <th><strong>Type</strong></th>
      <th><strong>Default</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>global.image.pullPolicy</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"IfNotPresent"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>global.image.repository</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"release.daocloud.io"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>global.imageCredentials.email</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">""</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>global.imageCredentials.password</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">""</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>global.imageCredentials.username</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">""</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>global.imagePullSecrets</td>
      <td>list</td>
      <td><code class="language-plaintext highlighter-rouge">[]</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>global.istioInjection.enable</td>
      <td>bool</td>
      <td><code class="language-plaintext highlighter-rouge">true</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>global.namespace</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"skoala-system"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.chart-repos.skoala.name</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"skoala"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.chart-repos.skoala.password</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">""</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.chart-repos.skoala.url</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"https://release.daocloud.io/chartrepo/skoala"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.chart-repos.skoala.user</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">""</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.client.ghippo.kubeconfig</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">""</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.client.ghippo.timeout</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">30</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.client.insight</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"insight-server.insight-system:80"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.client.kpanda</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"kpanda-apiserver.kpanda-system:80"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.client.mspider</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"mspider-api-service.mspider-system:8081"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.client.mspider_mcpc</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"mspider-work-api.mspider-system:8081"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.data.database.database</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"hive"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.data.database.driver</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"mysql"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.data.database.host</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"skoala-mysql"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.data.database.max-connection-lifetime</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">20</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.data.database.max-idle-connections</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">150</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.data.database.max-open-connections</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">150</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.data.database.password</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"dangerous"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.data.database.port</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">3306</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.data.database.user</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"root"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.data.server.grpc.addr</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"0.0.0.0:9091"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.data.server.grpc.timeout</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"1s"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.data.server.http.addr</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"0.0.0.0:8081"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.configMap.data.server.http.timeout</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"1s"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.enable</td>
      <td>bool</td>
      <td><code class="language-plaintext highlighter-rouge">true</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.image.name</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"skoala/hive"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.image.pullPolicy</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"IfNotPresent"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.image.tag</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"v0.6.0"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.nameOverride</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"hive"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.replicaCount</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">1</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.resources</td>
      <td>object</td>
      <td><code class="language-plaintext highlighter-rouge">{}</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.service.grpc.nodePort</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">30091</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.service.grpc.port</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">9091</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.service.http.nodePort</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">30081</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.service.http.port</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">8081</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>hive.service.type</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"NodePort"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.chart-repos.skoala.name</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"skoala"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.chart-repos.skoala.password</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">""</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.chart-repos.skoala.url</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"https://release.daocloud.io/chartrepo/skoala"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.chart-repos.skoala.user</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">""</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.client.ghippo.kubeconfig</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">""</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.client.ghippo.timeout</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">30</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.client.insight</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"insight-server.insight-system:80"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.client.kpanda</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"kpanda-apiserver.kpanda-system:80"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.data.server.grpc.addr</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"0.0.0.0:9092"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.data.server.grpc.timeout</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"1s"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.data.server.http.addr</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"0.0.0.0:8082"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.data.server.http.timeout</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"1s"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.log.development</td>
      <td>bool</td>
      <td><code class="language-plaintext highlighter-rouge">true</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.log.disable-color</td>
      <td>bool</td>
      <td><code class="language-plaintext highlighter-rouge">false</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.log.disable-stacktrace</td>
      <td>bool</td>
      <td><code class="language-plaintext highlighter-rouge">false</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.log.enable-caller</td>
      <td>bool</td>
      <td><code class="language-plaintext highlighter-rouge">true</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.log.error-output-paths</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"dist/log/skoala-sesame.error.log"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.log.format</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"console"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.log.level</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"debug"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.log.name</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"skoala-sesame"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.configMap.log.output-paths</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"dist/log/skoala-sesame.log,stdout"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.enable</td>
      <td>bool</td>
      <td><code class="language-plaintext highlighter-rouge">true</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.image.name</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"skoala/sesame"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.image.pullPolicy</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"IfNotPresent"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.image.tag</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"v0.6.0"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.nameOverride</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"sesame"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.replicaCount</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">1</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.resources</td>
      <td>object</td>
      <td><code class="language-plaintext highlighter-rouge">{}</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.service.grpc.nodePort</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">30092</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.service.grpc.port</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">9092</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.service.http.nodePort</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">30082</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.service.http.port</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">8082</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>sesame.service.type</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"NodePort"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ui.enable</td>
      <td>bool</td>
      <td><code class="language-plaintext highlighter-rouge">true</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ui.image.name</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"skoala/skoala-ui"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ui.image.pullPolicy</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"IfNotPresent"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ui.image.tag</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"v0.4.0"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ui.nameOverride</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"ui"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ui.replicaCount</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">1</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ui.resources</td>
      <td>object</td>
      <td><code class="language-plaintext highlighter-rouge">{}</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ui.service.nodePort</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">30090</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ui.service.port</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">80</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ui.service.type</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"NodePort"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>create</td>
      <td>bool</td>
      <td><code class="language-plaintext highlighter-rouge">true</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ui.serviceAccount.name</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">""</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ui.tolerations</td>
      <td>list</td>
      <td><code class="language-plaintext highlighter-rouge">[]</code></td>
      <td> </td>
    </tr>
  </tbody>
</table>

<h2 id="安装-skoala-agent">安装 skoala-agent</h2>

<p>安装步骤说明</p>

<h3 id="查看当前最新版本">查看当前最新版本</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">~ helm search repo skoala-release/skoala-agent --versions</span>
<span class="s">NAME                CHART VERSION APP VERSION DESCRIPTION</span>
<span class="s">skoala/skoala-agent 0.6.1         0.6.1       A Helm chart for Skoala Agent</span>
<span class="s">skoala/skoala-agent 0.6.0         0.6.0       A Helm chart for Kubernetes</span>
<span class="s">skoala/skoala-agent 0.5.1         0.5.1       A Helm chart for Kubernetes</span>
<span class="s">skoala/skoala-agent 0.5.0         0.5.0       A Helm chart for Kubernetes</span>
</code></pre></div></div>

<h3 id="部署">部署</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">helm upgrade --install skoala-agent --create-namespace -n skoala-agent --cleanup-on-fail \</span>
<span class="s">--set image.tag=v0.6.1 \</span>
<span class="s">skoala/skoala-agent \</span>
<span class="s">--version 0.6.1</span>
</code></pre></div></div>

<p>查看部署的 pod 是否启动成功</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">~ kubectl -n skoala-agent get pods</span>
<span class="s">NAME                            READY   STATUS    RESTARTS   AGE</span>
<span class="s">skoala-agent-679c6d64b4-tb7k4   1/1     Running   0          26h</span>
</code></pre></div></div>

<h3 id="卸载命令">卸载命令</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">helm uninstall skoala-agent -n skoala-agent</span>
</code></pre></div></div>

<h3 id="更多参数设置">更多参数设置</h3>

<table>
  <thead>
    <tr>
      <th>Key</th>
      <th>Type</th>
      <th>Default</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>affinity</td>
      <td>object</td>
      <td><code class="language-plaintext highlighter-rouge">{}</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>autoscaling.enabled</td>
      <td>bool</td>
      <td><code class="language-plaintext highlighter-rouge">false</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>autoscaling.maxReplicas</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">100</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>autoscaling.minReplicas</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">1</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>autoscaling.targetCPUUtilizationPercentage</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">80</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>fullnameOverride</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">""</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>image.pullPolicy</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"IfNotPresent"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>image.repository</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"release-ci.daocloud.io/skoala/skoala-agent"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>image.tag</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"v0.6.0"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>imagePullSecrets</td>
      <td>list</td>
      <td><code class="language-plaintext highlighter-rouge">[]</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ingress.annotations</td>
      <td>object</td>
      <td><code class="language-plaintext highlighter-rouge">{}</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ingress.className</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">""</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ingress.enabled</td>
      <td>bool</td>
      <td><code class="language-plaintext highlighter-rouge">false</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ingress.hosts[0].host</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"chart-example.local"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ingress.hosts[0].paths[0].path</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"/"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ingress.hosts[0].paths[0].pathType</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"ImplementationSpecific"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>ingress.tls</td>
      <td>list</td>
      <td><code class="language-plaintext highlighter-rouge">[]</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>istioInjection.enable</td>
      <td>bool</td>
      <td><code class="language-plaintext highlighter-rouge">true</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>nameOverride</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">""</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>nodeSelector</td>
      <td>object</td>
      <td><code class="language-plaintext highlighter-rouge">{}</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>podAnnotations</td>
      <td>object</td>
      <td><code class="language-plaintext highlighter-rouge">{}</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>podSecurityContext</td>
      <td>object</td>
      <td><code class="language-plaintext highlighter-rouge">{}</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>replicaCount</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">1</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>resources</td>
      <td>object</td>
      <td><code class="language-plaintext highlighter-rouge">{}</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>securityContext</td>
      <td>object</td>
      <td><code class="language-plaintext highlighter-rouge">{}</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>service.port</td>
      <td>int</td>
      <td><code class="language-plaintext highlighter-rouge">443</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>service.type</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">"NodePort"</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>serviceAccount.annotations</td>
      <td>object</td>
      <td><code class="language-plaintext highlighter-rouge">{}</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>serviceAccount.create</td>
      <td>bool</td>
      <td><code class="language-plaintext highlighter-rouge">false</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>serviceAccount.name</td>
      <td>string</td>
      <td><code class="language-plaintext highlighter-rouge">""</code></td>
      <td> </td>
    </tr>
    <tr>
      <td>tolerations</td>
      <td>list</td>
      <td><code class="language-plaintext highlighter-rouge">[]</code></td>
      <td> </td>
    </tr>
  </tbody>
</table>

      
    </div>
    <br/>
    <div>
      <cite>2022-09-20</cite> <i class="icon-tag"></i>
      <a href="/tags.html#Skoala">Skoala</a>
      
      
      
    </div>
    <div style="clear: both;"></div>
    <hr/>
    
    
    <h1><a class="title" href="/post/2022/09/%E4%BD%BF%E7%94%A8-canal-%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A2%9E%E9%87%8F%E5%90%8C%E6%AD%A5.html">使用 canal 进行数据库增量同步</a></h1>
    <div class="post_at_index">
      <p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1662586780206-7328e88e-c0e3-4e2f-ac6d-e072747efc4a.png?x-oss-process=image/resize,w_960,m_lfit" alt="image.png" /></p>

<h2 id="简介">简介</h2>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/20191104101735947.png?x-oss-process=image/resize,w_960,m_lfit" alt="image" /></p>

<p><strong>canal [kə’næl]</strong>，译意为水道/管道/沟渠，主要用途是基于 MySQL 数据库增量日志解析，提供增量数据订阅和消费</p>

<p>早期阿里巴巴因为杭州和美国双机房部署，存在跨机房同步的业务需求，实现方式主要是基于业务 trigger 获取增量变更。从 2010 年开始，业务逐步尝试数据库日志解析获取增量变更进行同步，由此衍生出了大量的数据库增量订阅和消费业务。</p>

<p>基于日志增量订阅和消费的业务包括</p>

<ul>
  <li>数据库镜像</li>
  <li>数据库实时备份</li>
  <li>索引构建和实时维护 (拆分异构索引、倒排索引等)</li>
  <li>业务 cache 刷新</li>
  <li>带业务逻辑的增量数据处理</li>
</ul>

<p>当前的 canal 支持源端 MySQL 版本包括 5.1.x , 5.5.x , 5.6.x , 5.7.x , 8.0.x</p>

<h2 id="工作原理">工作原理</h2>

<h3 id="mysql-主备复制原理">MySQL 主备复制原理</h3>

<p><img src="../assets/ev1v2m/468c1a14-e7ad-3290-9d3d-44ac501a7227.jpg" alt="image" /></p>

<ul>
  <li>MySQL master 将数据变更写入二进制日志 ( binary log, 其中记录叫做二进制日志事件 binary log events，可以通过 show binlog events 进行查看)</li>
  <li>MySQL slave 将 master 的 binary log events 拷贝到它的中继日志 (relay log)</li>
  <li>MySQL slave 重放 relay log 中事件，将数据变更反映它自己的数据</li>
</ul>

<h3 id="canal-工作原理">canal 工作原理</h3>

<ul>
  <li>canal 模拟 MySQL slave 的交互协议，伪装自己为 MySQL slave，向 MySQL master 发送 dump 协议</li>
  <li>MySQL master 收到 dump 请求，开始推送 binary log 给 slave (即 canal )</li>
  <li>canal 解析 binary log 对象 (原始为 byte 流)</li>
</ul>

<h2 id="文档支持">文档支持</h2>

<ul>
  <li><a href="https://github.com/alibaba/canal/wiki/Home">Home</a></li>
  <li><a href="https://github.com/alibaba/canal/wiki/Introduction">Introduction</a></li>
  <li><a href="https://github.com/alibaba/canal/wiki/QuickStart">QuickStart</a>
    <ul>
      <li><a href="https://github.com/alibaba/canal/wiki/Docker-QuickStart">Docker QuickStart</a></li>
      <li><a href="https://github.com/alibaba/canal/wiki/Canal-Kafka-RocketMQ-QuickStart%22">Canal Kafka/RocketMQ QuickStart</a></li>
      <li><a href="https://github.com/alibaba/canal/wiki/aliyun-RDS-QuickStart">Aliyun RDS for MySQL QuickStart</a></li>
      <li><a href="https://github.com/alibaba/canal/wiki/Prometheus-QuickStart">Prometheus QuickStart</a></li>
    </ul>
  </li>
  <li>Canal Admin
    <ul>
      <li><a href="https://github.com/alibaba/canal/wiki/Canal-Admin-QuickStart">Canal Admin QuickStart</a></li>
      <li><a href="https://github.com/alibaba/canal/wiki/Canal-Admin-Guide">Canal Admin Guide</a></li>
      <li><a href="https://github.com/alibaba/canal/wiki/Canal-Admin-ServerGuide">Canal Admin ServerGuide</a></li>
      <li><a href="https://github.com/alibaba/canal/wiki/Canal-Admin-Docker">Canal Admin Docker</a></li>
    </ul>
  </li>
  <li><a href="https://github.com/alibaba/canal/wiki/AdminGuide">AdminGuide</a></li>
  <li><a href="https://github.com/alibaba/canal/wiki/ClientExample">ClientExample</a></li>
  <li><a href="https://github.com/alibaba/canal/wiki/ClientAPI">ClientAPI</a></li>
  <li><a href="https://github.com/alibaba/canal/wiki/Performance">Performance</a></li>
  <li><a href="https://github.com/alibaba/canal/wiki/DevGuide">DevGuide</a></li>
  <li><a href="https://github.com/alibaba/canal/wiki/BinlogChange%28mysql5.6%29">BinlogChange(MySQL 5.6)</a></li>
  <li><a href="https://github.com/alibaba/canal/wiki/BinlogChange%28MariaDB%29">BinlogChange(MariaDB)</a></li>
  <li><a href="https://github.com/alibaba/canal/wiki/TableMetaTSDB">TableMetaTSDB</a></li>
  <li><a href="http://alibaba.github.com/canal/release.html">ReleaseNotes</a></li>
  <li><a href="https://github.com/alibaba/canal/releases">Download</a></li>
  <li><a href="https://github.com/alibaba/canal/wiki/FAQ">FAQ</a></li>
</ul>

<h2 id="多语言">多语言</h2>

<p>canal 特别设计了 client-server 模式，交互协议使用 protobuf 3.0 , client 端可采用不同语言实现不同的消费逻辑，欢迎大家提交 pull request</p>

<ul>
  <li>canal java 客户端：<a href="https://github.com/alibaba/canal/wiki/ClientExample">https://github.com/alibaba/canal/wiki/ClientExample</a></li>
  <li>canal c# 客户端：<a href="https://github.com/dotnetcore/CanalSharp">https://github.com/dotnetcore/CanalSharp</a></li>
  <li>canal go 客户端：<a href="https://github.com/CanalClient/canal-go">https://github.com/CanalClient/canal-go</a></li>
  <li>canal php 客户端：<a href="https://github.com/xingwenge/canal-php">https://github.com/xingwenge/canal-php</a></li>
  <li>canal Python 客户端：<a href="https://github.com/haozi3156666/canal-python">https://github.com/haozi3156666/canal-python</a></li>
  <li>canal Rust 客户端：<a href="https://github.com/laohanlinux/canal-rs">https://github.com/laohanlinux/canal-rs</a></li>
  <li>canal Nodejs 客户端：<a href="https://github.com/marmot-z/canal-nodejs">https://github.com/marmot-z/canal-nodejs</a></li>
</ul>

<p>canal 作为 MySQL binlog 增量获取和解析工具，可将变更记录投递到 MQ 系统中，比如 Kafka/RocketMQ，可以借助于 MQ 的多语言能力</p>

<ul>
  <li>参考文档：<a href="https://github.com/alibaba/canal/wiki/Canal-Kafka-RocketMQ-QuickStart">Canal Kafka/RocketMQ QuickStart</a></li>
</ul>

<h2 id="资料整理">资料整理</h2>

<p>canal 的策略是模拟了 MySQL Slave 的行为，因此需要有 SELECT, REPLICATION SLAVE, REPLICATION CLIENT 的权限</p>

      
    </div>
    <br/>
    <div>
      <cite>2022-09-18</cite> <i class="icon-tag"></i>
      <a href="/tags.html#Canal">Canal</a>
      , 
      <a href="/tags.html#MySQL">MySQL</a>
      
      
      
    </div>
    <div style="clear: both;"></div>
    <hr/>
    
    
    <h1><a class="title" href="/post/2022/09/K8s%E7%B3%BB%E5%88%97-%E5%8D%97%E5%8C%97%E6%B5%81%E9%87%8F%E5%92%8C%E4%B8%9C%E8%A5%BF%E6%B5%81%E9%87%8F.html">K8s 系列 南北流量和东西流量</a></h1>
    <div class="post_at_index">
      <h2 id="南北流量和东西流量-是什么意思">南北流量和东西流量 是什么意思？</h2>

<p>在 Service Mesh 微服务架构中，我们常常会听到东西流量和南北流量两个术语。</p>

<p>南北流量（NORTH-SOUTH traffic）和东西流量（EAST-WEST traffic）是数据中心环境中的网络流量模式。下面我们通过一个例子来理解这两个术语。</p>

<p>假设我们尝试通过浏览器访问某些 Web 应用。Web 应用部署在位于某个数据中心的应用服务器中。在多层体系结构中，典型的数据中心不仅包含应用服务器，还包含其他服务器，如负载均衡器、数据库等，以及路由器和交换机等网络组件。假设应用服务器是负载均衡器的前端。</p>

<p>当我们访问 web 应用时，会发生以下类型的网络流量：</p>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/f9c10a68e23f6955cc25c176d2ea98f7.png?x-oss-process=image/resize,w_960,m_lfit" alt="img" style="zoom:80%;" /></p>

<p>数据中心树型拓扑图是一个典型的包含接入层、汇聚层、核心层三层的网络结构。这种结构诞生之初就是为了将外部流量引流到内部应用。</p>

<p>流量从外部穿过防火墙或者数据中心其它外围网络设备进来，对应到上⾯这张图里，流动方向为从上到下，称为南向流量（和地图一样，上北下南），而与之对应的，数据中心内部产生的，离开数据中心的流量，从下到上故称为北向流量。合起来称为南北流量。</p>

<p>在微服务化流行之前，以巨石系统（monolithic）这种单体应用为单位部署的方式，产生的是典型的南北流量。一个单体应用配有一个专门的服务器（或虚拟机），一个外部请求通常在单体应用内独立完成，除了访问数据库等必须依赖服务之外，很少会发生横向的流量。</p>

<p>但云计算机、大数据、微服务、云原生等技术的发展催生了大量的从左到右以及从右到左的流量，也被称为东西流量。</p>

<p>数据中心内部南北流量的削弱，而东西流量的井喷在硬件上要求数据中心要横向扩展以提供更宽的大二层以及容纳更多的服务器，而在软件上则要求一种新的服务编排方式以便能充分挖掘、利用现有的计算能力，从这个角度看 K8s 的出现是一种必然。</p>

<p>举两个例子：</p>

<ul>
  <li>
    <p>客户端（位于数据中心一侧的浏览器）与负载均衡器（位于数据中心）之间的网络流量</p>
  </li>
  <li>
    <p>负载均衡器、应用服务器、数据库等之间的网络流量，它们都位于数据中心。</p>
  </li>
</ul>

<p>在这个例子中，前者即即客户端和服务器之间的流量被称为南北流量。简而言之，南北流量是 server-client 流量。</p>

<p>第二种流量即不同服务器之间的流量与数据中心或不同数据中心之间的网络流被称为东西流量。简而言之，东西流量是 service-service 流量。</p>

<p>当下，东西流量远超南北流量，尤其是在当今的大数据生态系统中，比如 Hadoop 生态系统（大量 server 驻留在数据中心中，用 map reduce 处理），server-server 流量远大于 server-client 流量。</p>

<p>大家可能会好奇，东西南北，为什么这么命名？</p>

<p>该命名来自于绘制典型 network diagrams 的习惯。在图表中，通常核心网络组件绘制在顶部（NORTH），客户端绘制在底部（SOUTH），而数据中心内的不同服务器水平（EAST-WEST）</p>

      
    </div>
    <br/>
    <div>
      <cite>2022-09-12</cite> <i class="icon-tag"></i>
      <a href="/tags.html#K8s">K8s</a>
      
      
      
    </div>
    <div style="clear: both;"></div>
    <hr/>
    
    
    <h1><a class="title" href="/post/2022/08/Docker-for-Mac-%E7%BD%91%E7%BB%9C%E6%8A%80%E5%B7%A7.html">Docker for Mac 网络技巧</a></h1>
    <div class="post_at_index">
      <p>在 Windows 和 Linux 中使用 Docker，可以通过 docker0 这个网络 IP，在容器内访问宿主机的端口及服务</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ ifconfig
docker0: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 172.17.0.1  netmask 255.255.0.0  broadcast 172.17.255.255
        ether 02:42:65:e2:82:de  txqueuelen 0  <span class="o">(</span>Ethernet<span class="o">)</span>
        RX packets 19240  bytes 9107695 <span class="o">(</span>8.6 MiB<span class="o">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 16989  bytes 9952021 <span class="o">(</span>9.4 MiB<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</code></pre></div></div>

<p>但以上在 macOS 中无 docker0 端口，那我们如何在 Docker for Mac 中访问宿主机的服务呢？</p>

<blockquote>
  <p>docker.for.mac.host.internal</p>
</blockquote>

<p>可以采用以上本地域名内实现在容器内访问 宿主机的服务</p>

      
    </div>
    <br/>
    <div>
      <cite>2022-08-17</cite> <i class="icon-tag"></i>
      <a href="/tags.html#Docker">Docker</a>
      , 
      <a href="/tags.html#Mac">Mac</a>
      
      
      
    </div>
    <div style="clear: both;"></div>
    <hr/>
    
    
    <h1><a class="title" href="/post/2022/08/%E7%93%A6%E5%B0%94%E7%99%BB%E6%B9%96.html">瓦尔登湖</a></h1>
    <div class="post_at_index">
      <p><a href="https://www.amazon.cn/s/ref=as_li_ss_tl?_encoding=UTF8\&amp;camp=536\&amp;creative=3132\&amp;field-keywords=%E7%93%A6%E5%B0%94%E7%99%BB%E6%B9%96\&amp;linkCode=ur2\&amp;tag=llll1-23\&amp;url=search-alias%3Dbooks">亨利••大卫••梭罗</a>
7 highlights, 1 note</p>

<ul>
  <li>在这段时间里把车钱挣出来了，会在明天的什么时候到达那里，如果你幸运地及时找到了工作，也可能今晚到达。你大半天的时间不是去了菲奇堡，却是在这里干活。因此，如果铁路通到全世界，我想我还是会在你前头；至于说长见识，如果净是那方面的见识，我就得和你完全断绝来往了。</li>
  <li>如果你决定明天开始做一件事情，那为什么不现在就开始呢？实用主义，不应该追求虚无的东西。</li>
  <li>
    <p>最好在坏事一开始的时候就防止它。</p>
  </li>
  <li>
    <p>在任何一个社会中，书籍的作者都是天生的极富魅力的精英分子，对人类发挥着比帝王们更大的影响。当目不识丁的、也许还是鄙视一切的商人，通过魄力和勤奋挣得了垂涎已久的闲暇和衣食无忧的生活，进入了财富和时尚的圈子以后，最终不可避免地会转向那更高的然而却难以企及的知识和才赋的圈子，这时他才会意识到自己文化的残缺，以及他一切财富的空虚无用；于是他不遗余力地要使子女获得知识文化，他深刻地感到自己这方面的不足，从而证明了他的明智；就这样，他成了一个家族的缔造者。</p>
  </li>
  <li>
    <p>我们应该和古代的圣贤一样优秀，但是首先要知道他们有多么优秀。我们是一群矮子，我们智力翱翔所达之处只不过稍高于报纸的专栏而已。</p>
  </li>
  <li>
    <p>德不孤，必有邻。</p>
  </li>
  <li>
    <p>孤独不能以一个人和别人之间有多少英里的空间来衡量。</p>
  </li>
  <li>在他身上肉体的人得到了充分发展。</li>
</ul>

      
    </div>
    <br/>
    <div>
      <cite>2022-08-15</cite> <i class="icon-tag"></i>
      <a href="/tags.html#读书笔记">读书笔记</a>
      
      
      
    </div>
    <div style="clear: both;"></div>
    <hr/>
    
    
    <h1><a class="title" href="/post/2022/08/Contour-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html">Contour 学习笔记</a></h1>
    <div class="post_at_index">
      <h2 id="contour-官方的资料">Contour 官方的资料</h2>

<ul>
  <li><a href="https://hackmd.io/84Xbl4WBTpm7OBhaOAsSiw">https://hackmd.io/84Xbl4WBTpm7OBhaOAsSiw</a>  Contour Community Meeting Notes</li>
  <li><a href="https://www.youtube.com/watch?v=fpRzvQWiHjI&amp;list=PLk2K7YhXu5KtYU1UGEYNC8ApH5gsWihDJ">https://www.youtube.com/watch?v=fpRzvQWiHjI&amp;list=PLk2K7YhXu5KtYU1UGEYNC8ApH5gsWihDJ</a>  双周例会</li>
  <li><a href="https://kubernetes.slack.com/archives/C8XRH2R4J">https://kubernetes.slack.com/archives/C8XRH2R4J</a>  Slack Chat Channel</li>
  <li><a href="https://bitnami.com/stack/contour/helm">https://bitnami.com/stack/contour/helm</a>  Helm 部署 Contour 资料</li>
  <li><a href="https://juejin.cn/post/7029286464802258974">https://juejin.cn/post/7029286464802258974</a>  Envoy Ingress：Contour 基本原理和源码分析
    <ul>
      <li><a href="https://juejin.cn/user/3878732754069272">https://juejin.cn/user/3878732754069272</a> 掘金大佬</li>
    </ul>
  </li>
</ul>

<h2 id="参考文档一使用-contour-接管-k8s-南北流量">参考文档一：使用 Contour 接管 K8s 南北流量</h2>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1652658255610-3a38d8d3-2062-486b-a0b9-3b0a1d47dc5c.png?x-oss-process=image/resize,w_960,m_lfit" alt="image.png" />
容器公司 <a href="https://heptio.com/">Heptio</a> 开源的项目 <a href="https://github.com/heptio/contour">Contour</a> 使用 Envoy 作为 Kubernetes 的 Ingress Controller 实现。</p>

<h3 id="contour-的组成">Contour 的组成</h3>

<p>Contour Ingress controller 由两个组件组成：</p>

<ul>
  <li>Envoy : 提供高性能反向代理。</li>
  <li>Contour : 充当 Envoy 的控制平面，为 Envoy 的路由配置提供统一的来源。</li>
</ul>

<h3 id="contour-的部署方式">Contour 的部署方式</h3>

<p>官方文档提供了三种部署方法：</p>

<ol>
  <li>通过 DaemonSet 来部署，每个节点上跑一个 Contour 实例（Contour 与 Envoy 在同一个 Pod 中）。</li>
  <li>通过 Deployment 来部署，总共跑两个 Contour 实例（Contour 与 Envoy 在同一个 Pod 中）。</li>
  <li>通过 Deployment 来部署 Contour，总共跑两个 Contour 实例；通过 DaemonSet 来部署 Envoy，每个节点上跑一个 Envoy 实例。</li>
</ol>

<p>第三种方案比较巧妙，这样可以让 Contour 和 Envoy 这两个组件解耦，可以分别按需对不同的组件进行扩展，具体的优势如下：</p>

<ul>
  <li>Envoy 以 Daemonset 的形式运行，具有很强的扩展性，后续可通过 ipvs 和 keepalived 等工具来实现其负载均衡和高可用。</li>
  <li>Envoy 运行的网络模式是 hostNetwork，减少了额外的网络性能损耗。</li>
  <li>Contour 与 Envoy 之间通过双向认证的自签名证书进行通信，大大增强了安全性。</li>
  <li>升级 Contour 不需要重启 Envoy。</li>
</ul>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1652658571911-263003fa-2d88-47d9-9650-7929589a49c8.png?x-oss-process=image/resize,w_960,m_lfit" alt="image.png" /></p>

<blockquote>
  <p>启动分析</p>
</blockquote>

<p>在 Envoy 的 Pod 初始化期间，Contour 作为 Init 容器运行，并将 bootstrap（初始化）配置写入一个 temporary volume。该 Volume 被传递给 Envoy 容器并告诉 Envoy 将另一个 Deployment 中的 Contour 容器视为控制平面。</p>

<p><img src="http://ipic-typora-samzong.oss-cn-qingdao.aliyuncs.com//uPic/1652659925765-50a45ceb-22f8-44a9-8c48-34fa832cda3e.jpeg?x-oss-process=image/resize,w_960,m_lfit" alt="image" /></p>

<blockquote>
  <p>Contour 会根据启动参数和 K8S API Server 中的配置信息生成 Envoy 的初始配置文件</p>
</blockquote>

<ol>
  <li>Envoy initContainer 根据启动参数和 K8S API Server 中的配置信息生成 Envoy 的初始配置文件 envoy.json，该文件告诉 Envoy 从 xDS server 中获取动态配置信息，并配置了 xDS server 的地址信息，即控制平面的 Contour。</li>
  <li>Envoy 使用配置文件 envoy.json 启动。</li>
  <li>Envoy 根据获取到的动态配置启动 Listener，并根据 Listener 的配置，结合 Route 和 Cluster 对进入的流量进行处理。</li>
</ol>

<p>Contour 作为 Envoy 的 initContainer</p>

<h2 id="参考文档-二contour-中-envoy-优雅停服的实现与源码分析">参考文档 二：Contour 中 Envoy 优雅停服的实现与源码分析</h2>

      
    </div>
    <br/>
    <div>
      <cite>2022-08-10</cite> <i class="icon-tag"></i>
      <a href="/tags.html#Contour">Contour</a>
      
      
      
    </div>
    <div style="clear: both;"></div>
    <hr/>
    
    
    <h1><a class="title" href="/post/2022/07/%E9%80%9A%E8%BF%87pipreqs%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E9%A1%B9%E7%9B%AE%E7%9A%84%E4%BE%9D%E8%B5%96%E5%BA%93.html">通过 pipreqs 获取当前项目的依赖库</a></h1>
    <div class="post_at_index">
      <p>如果在开始开发一个项目时，未注意项目的依赖库隔离；可能会导致后续给项目打包时：</p>

<ul>
  <li>导致缺少依赖库，导致项目初始化麻烦</li>
  <li>读取了全局依赖库，导致项目安装了大量的实际无用的库</li>
</ul>

<p>这里推荐一个专门解决这个问题的 Python 库， <code class="language-plaintext highlighter-rouge">pipreqs</code></p>

<h3 id="使用注意事项">使用注意事项</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># linux &amp; mac</span>
pipreqs <span class="nv">$python_project_dir</span>

<span class="c"># Windows 需要增加 --encoding=utf-8 字母编码，否则会有出错，懂得都懂</span>
pipreqs ./ <span class="nt">--encoding</span><span class="o">=</span>utf-8

<span class="c"># 会自动在当前目录生成一个 requirements.txt， 如果已存在会提示失败</span>
<span class="c"># 也可以使用 --force 强制覆盖</span>
pipreqs <span class="nb">.</span> <span class="nt">--force</span>
</code></pre></div></div>

<h3 id="支持的其他功能">支持的其他功能</h3>

<p>更多的功能，可以在安装后研究下，通过 -h 可以获取更多有价值的信息</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>\--diff &lt;file&gt;         将 requirements.txt 中的模块与项目导入进行比较。  &gt;&gt; 仅追加
\--clean &lt;file&gt;     通过删除项目中没有导入的模块来清理 requirements.txt   &gt;&gt; 瘦身
</code></pre></div></div>

      
    </div>
    <br/>
    <div>
      <cite>2022-07-24</cite> <i class="icon-tag"></i>
      <a href="/tags.html#Python">Python</a>
      
      
      
    </div>
    <div style="clear: both;"></div>
    <hr/>
    

    <!-- Pagination links -->
    <nav>
      <ul class="pagination hidden-xs">
        
        
        <li>
          <a href="/">&laquo; Previous</a>
        </li>
        
        

        
        <li>
          <a href="/">1</a>
        </li>
        

        
          
            
              
                <li class="active"><a>2</a></li>
                
            
              
                <li><a href="/page3">3</a></li>
              
            
              
                <li><a href="/page4">4</a></li>
              
            
              
                <li><a href="/page5">5</a></li>
              
            
          
          <li class="disabled"><span>...</span></li>
          <li><a href="/page24">24</a></li>
        

        
        

        
        <li>
          <a href="/page3">Next &raquo;</a>
        </li>
        
      </ul>
    </nav>
  </div>
  <div class="col-xs-12 col-md-4">
		<!-- <div>
			<a class="twitter-timeline" data-width="390" data-height="640" data-theme="light" href="https://twitter.com/samzong_lu?ref_src=twsrc%5Etfw">Tweets by SAMZONG</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
		</div> -->
    <div>
      <h2>传送门</h2>
      <ul>
        <li><a href="https://yuque.com/samzong">语雀-花园</a></li>
        <li><a href="https://github.com/samzong">Github</a></li>
      </ul>
    </div>
    <div class="categories">
      <h2>文章分类</h2>
      <ul class="tag_box">
        
        


  
     
    	
      <li><a href="/categories.html#故事汇">
    		故事汇 <span>23</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#Linux">
    		Linux <span>22</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#前端">
    		前端 <span>5</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#数据库">
    		数据库 <span>30</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#Git">
    		Git <span>6</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#Mac">
    		Mac <span>16</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#Tools">
    		Tools <span>7</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#OpenSource">
    		OpenSource <span>11</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#Python">
    		Python <span>45</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#云平台">
    		云平台 <span>8</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#虚拟化">
    		虚拟化 <span>3</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#Java">
    		Java <span>6</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#Docker">
    		Docker <span>6</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#Blog">
    		Blog <span>7</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#安全">
    		安全 <span>2</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#读书笔记">
    		读书笔记 <span>16</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#微服务">
    		微服务 <span>2</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#Kubernetes">
    		Kubernetes <span>15</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#DaoCloud Enterprise">
    		DaoCloud Enterprise <span>2</span>
    	</a></li>
     
    	
      <li><a href="/categories.html#春松客服">
    		春松客服 <span>1</span>
    	</a></li>
    
  



      </ul>
    </div>
    <div>
      <h2>最近文章</h2>
      <ul>
        
        <li>
          <a href="/post/2022/12/dce50.html">保姆式安装 DCE5.0</a>
          前言


        </li>
        
        <li>
          <a href="/post/2022/11/cskefu-opensource-project.html">开源项目 - 春松客服</a>
          项目起源


        </li>
        
        <li>
          <a href="/post/2022/11/what-is-hukou.html">What is Hukou</a>
          背景


        </li>
        
        <li>
          <a href="/post/2022/11/Copy-To-Markdwon.html">Copy to Markdown</a>
          背景


        </li>
        
        <li>
          <a href="/post/2022/11/Dubbo-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86.html">Dubbo 基础知识梳理</a>
          
  参考资料：



        </li>
        
      </ul>
    </div>
  </div>
</div>

			</div>

		</div>

    <footer>
      <div class="container">
        <div class="row mobilepadding">
          			<hr>
      &copy; 2022 船长. Powered by <a href="http://jekyllrb.com" target="_blank" title="The simple, blog-aware, static site generator.">Jekyll</a>. Theme Creator <a href="https://github.com/einverne" target="_blank" title="Ein Verne's GitHub Repos">Ein Verne</a> . Host on <a href="https://github.com/samzong/samzong.me" target="_blank" title="Samzong's GitHub Repos">Github</a> .
      <br><br>
      </div>
    </div>
    </footer>

    




	<script async type="text/javascript" src="/assets/themes/evjekylltheme/bootstrap-3.3.5/js/bootstrap.min.js"></script>
	<script async type="text/javascript" src="/assets/themes/evjekylltheme/webcore.js"></script>

 </body>
</html>

